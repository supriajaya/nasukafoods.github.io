<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasuka Foods - Diskusi Publik</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #ff9800 0%, #f44336 100%); }
        .comment-card { border-radius: 20px; border-left: 6px solid #ff9800; transition: all 0.3s ease; }
        .reply-card { border-left: 2px solid #e2e8f0; background-color: #f8fafc; }
        .tag-name { color: #3b82f6; font-weight: bold; margin-right: 4px; }
        .btn-action { font-size: 11px; color: #64748b; font-weight: bold; cursor: pointer; }
        .btn-view-replies { font-size: 12px; color: #ff9800; font-weight: bold; cursor: pointer; display: flex; items-center: center; gap: 5px; margin-top: 10px; }
        .hidden { display: none; }
        select { appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body class="bg-gray-50 pb-20">

    <div class="gradient-bg text-white p-6 rounded-b-[40px] shadow-lg mb-6 text-center">
        <h1 class="text-xl font-bold uppercase tracking-widest">Suara Pelanggan</h1>
        <p class="text-xs opacity-90">Arsip 2026</p>
    </div>

    <div class="max-w-md mx-auto px-4">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-6">
            <textarea id="testiText" placeholder="Bagikan ceritamu hari ini..." 
                class="w-full p-4 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-orange-400 focus:outline-none h-20 text-sm"></textarea>
            <button onclick="kirimTestimoni()" class="w-full mt-2 bg-orange-500 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-all text-sm uppercase">
                Kirim Postingan
            </button>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-8">
            <p class="text-[10px] font-bold text-gray-400 uppercase mb-3 ml-1"><i class="fas fa-filter mr-1"></i> Cari Postingan Lama</p>
            <div class="flex gap-2">
                <select id="filterBulan" onchange="filterDataSpesifik()" class="flex-1 bg-gray-50 border-none rounded-xl text-xs p-3 outline-none focus:ring-2 focus:ring-orange-400 cursor-pointer">
                    <option value="">Semua Bulan</option>
                    <option value="0">Januari</option>
                    <option value="1">Februari</option>
                    <option value="2">Maret</option>
                    <option value="3">April</option>
                    <option value="4">Mei</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">Agustus</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Desember</option>
                </select>

                <select id="filterTahun" onchange="filterDataSpesifik()" class="w-24 bg-gray-50 border-none rounded-xl text-xs p-3 outline-none focus:ring-2 focus:ring-orange-400 cursor-pointer">
                    <option value="">Tahun</option>
                    <option value="2020">2020</option>
                    <option value="2021">2021</option>
                    <option value="2022">2022</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
                
                <button onclick="resetFilter()" class="bg-gray-100 text-gray-500 px-3 rounded-xl text-[10px] font-bold hover:bg-red-50 hover:text-red-500">RESET</button>
            </div>
        </div>

        <div id="containerList" class="space-y-6">
            <div class="text-center py-10 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Menyiapkan obrolan...</p>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
            authDomain: "nasukafoods1.firebaseapp.app",
            databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nasukafoods1",
            messagingSenderId: "84287800896",
            appId: "1:84287800896:web:83189d6766997b00f701a5"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userSession = {
            ID: localStorage.getItem("ID"),
            Nama: localStorage.getItem("Nama") || "Tamu",
            Foto: localStorage.getItem("Foto") || "https://nasukafoods.site/gambarkosong.jpg"
        };

        let allData = [];

        db.ref('testimoni_publik').on('value', (snapshot) => {
            allData = [];
            snapshot.forEach(c => { 
                let val = c.val(); 
                val.key = c.key; 
                allData.push(val); 
            });
            allData.reverse();
            renderData(allData);
        });

        function filterDataSpesifik() {
            const bulan = document.getElementById('filterBulan').value;
            const tahun = document.getElementById('filterTahun').value;

            const hasilFilter = allData.filter(item => {
                const d = new Date(item.timestamp);
                const matchBulan = bulan === "" || d.getMonth() == bulan;
                const matchTahun = tahun === "" || d.getFullYear() == tahun;
                return matchBulan && matchTahun;
            });

            renderData(hasilFilter);
        }

        function resetFilter() {
            document.getElementById('filterBulan').value = "";
            document.getElementById('filterTahun').value = "";
            renderData(allData);
        }

        function renderData(dataToRender) {
            const listDiv = document.getElementById('containerList');
            listDiv.innerHTML = "";

            if (dataToRender.length === 0) {
                listDiv.innerHTML = `
                    <div class="text-center py-20 text-gray-400">
                        <i class="fas fa-calendar-times text-3xl mb-3 opacity-20"></i>
                        <p class="text-sm">Tidak ada postingan di periode ini.</p>
                    </div>`;
                return;
            }

            dataToRender.forEach(data => {
                const d = new Date(data.timestamp);
                const tglIndo = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                
                let balasanHtml = "";
                let jumlahBalasan = 0;
                
                if (data.balasan) {
                    const balasanList = Object.values(data.balasan);
                    jumlahBalasan = balasanList.length;
                    balasanList.forEach(r => {
                        balasanHtml += `
                            <div class="reply-card p-3 rounded-xl mt-2 border border-gray-50">
                                <div class="flex items-center gap-2 mb-1">
                                    <img src="${r.foto}" class="w-5 h-5 rounded-full object-cover">
                                    <span class="text-[11px] font-bold text-gray-700">${r.nama}</span>
                                </div>
                                <div class="text-xs text-gray-600 mb-1 leading-relaxed">${r.pesan}</div>
                                <span onclick="openReply('${data.key}', '${r.nama}')" class="btn-action hover:text-orange-500">Balas</span>
                            </div>
                        `;
                    });
                }

                const showReplyBtn = jumlahBalasan > 0 ? `
                    <div class="btn-view-replies" onclick="toggleReplies('${data.key}')">
                        <i id="btn-icon-${data.key}" class="fas fa-chevron-down text-[10px]"></i>
                        <span id="btn-text-${data.key}">Lihat ${jumlahBalasan} Balasan</span>
                    </div>
                ` : "";

                listDiv.innerHTML += `
                    <div class="bg-white p-4 comment-card shadow-sm border border-gray-100">
                        <div class="flex items-center gap-3 mb-3">
                            <img src="${data.foto}" class="w-10 h-10 rounded-full border-2 border-orange-100 object-cover">
                            <div>
                                <p class="text-sm font-bold text-gray-800">${data.nama}</p>
                                <p class="text-[9px] text-gray-400">${tglIndo} â€¢ Pelanggan Setia</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 mb-4 leading-relaxed font-medium">"${data.pesan}"</p>
                        
                        <div class="flex items-center border-t border-gray-50 pt-3">
                            <span onclick="openReply('${data.key}', '${data.nama}')" class="btn-action text-orange-500 bg-orange-50 px-3 py-1 rounded-full">
                                <i class="fas fa-comment-dots mr-1"></i> Balas
                            </span>
                        </div>

                        ${showReplyBtn}

                        <div id="replies-${data.key}" class="hidden space-y-1 mt-2">
                            ${balasanHtml}
                        </div>

                        <div id="field-${data.key}" class="mt-4 hidden">
                            <div class="flex gap-2">
                                <input id="input-${data.key}" type="text" 
                                    class="flex-1 text-xs p-3 bg-gray-50 rounded-xl outline-none border border-gray-200 focus:border-orange-400">
                                <button onclick="kirimBalasan('${data.key}', document.getElementById('input-${data.key}').placeholder.replace('Balas ','').replace('...',''))" 
                                    class="bg-orange-500 text-white px-4 rounded-xl text-[10px] font-bold shadow-sm uppercase">Kirim</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function kirimTestimoni() {
            const pesan = document.getElementById('testiText').value.trim();
            if (!userSession.ID) return alert("Yuk, login dulu!");
            if (!pesan) return;
            db.ref('testimoni_publik').push({
                userID: userSession.ID, nama: userSession.Nama, foto: userSession.Foto, pesan: pesan, timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => { document.getElementById('testiText').value = ""; });
        }

        function kirimBalasan(postID, targetNama) {
            const input = document.getElementById(`input-${postID}`);
            let pesan = input.value.trim();
            if (!userSession.ID) return alert("Login dulu ya!");
            if (!pesan) return;
            if (targetNama) pesan = `<span class="tag-name">@${targetNama}</span> ` + pesan;
            db.ref(`testimoni_publik/${postID}/balasan`).push({
                userID: userSession.ID, nama: userSession.Nama, foto: userSession.Foto, pesan: pesan, timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                input.value = "";
                document.getElementById(`field-${postID}`).classList.add('hidden');
                document.getElementById(`replies-${postID}`).classList.remove('hidden');
            });
        }

        function toggleReplies(postID) {
            const replyContainer = document.getElementById(`replies-${postID}`);
            const btnText = document.getElementById(`btn-text-${postID}`);
            const btnIcon = document.getElementById(`btn-icon-${postID}`);
            const isHidden = replyContainer.classList.contains('hidden');
            replyContainer.classList.toggle('hidden');
            btnText.innerText = isHidden ? "Sembunyikan Balasan" : `Lihat ${replyContainer.children.length} Balasan`;
            btnIcon.classList.toggle('fa-chevron-up', isHidden);
            btnIcon.classList.toggle('fa-chevron-down', !isHidden);
        }

        function openReply(postID, namaTujuan) {
            const field = document.getElementById(`field-${postID}`);
            const input = document.getElementById(`input-${postID}`);
            field.classList.remove('hidden');
            input.focus();
            if(namaTujuan) input.placeholder = `Balas ${namaTujuan}...`;
        }
    </script>
</body>
</html>
