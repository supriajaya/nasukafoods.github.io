<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasuka Foods - Diskusi Publik</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #ff9800 0%, #f44336 100%); }
        .comment-card { border-radius: 20px; border-left: 6px solid #ff9800; transition: all 0.3s ease; }
        .reply-card { border-left: 2px solid #e2e8f0; background-color: #f8fafc; }
        .tag-name { color: #3b82f6; font-weight: bold; margin-right: 4px; }
        .btn-action { font-size: 11px; color: #64748b; font-weight: bold; cursor: pointer; }
        .btn-view-replies { font-size: 12px; color: #ff9800; font-weight: bold; cursor: pointer; display: flex; items-center: center; gap: 5px; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-50 pb-20">

    <div class="gradient-bg text-white p-6 rounded-b-[40px] shadow-lg mb-6 text-center">
        <h1 class="text-xl font-bold uppercase tracking-widest">Nasuka Diskusi</h1>
        <p class="text-xs opacity-90">Profil bersifat private ( tidak bisa mengetahui info satu sama lain)</p>
    </div>

    <div class="max-w-md mx-auto px-4">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-8">
            <textarea id="testiText" placeholder="Bagikan ceritamu hari ini..." 
                class="w-full p-4 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-orange-400 focus:outline-none h-20 text-sm"></textarea>
            <button onclick="kirimTestimoni()" class="w-full mt-2 bg-orange-500 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-all text-sm uppercase">
                Kirim Postingan
            </button>
        </div>

        <div id="containerList" class="space-y-6">
            <div class="text-center py-10 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Menyiapkan obrolan...</p>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
            authDomain: "nasukafoods1.firebaseapp.app",
            databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nasukafoods1",
            messagingSenderId: "84287800896",
            appId: "1:84287800896:web:83189d6766997b00f701a5"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const userSession = {
            ID: localStorage.getItem("ID"),
            Nama: localStorage.getItem("Nama") || "Tamu",
            Foto: localStorage.getItem("Foto") || "https://nasukafoods.site/gambarkosong.jpg"
        };

        function kirimTestimoni() {
            const pesan = document.getElementById('testiText').value.trim();
            if (!userSession.ID) return alert("Yuk, login dulu!");
            if (!pesan) return;

            db.ref('testimoni_publik').push({
                userID: userSession.ID,
                nama: userSession.Nama,
                foto: userSession.Foto,
                pesan: pesan,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => { document.getElementById('testiText').value = ""; });
        }

        function kirimBalasan(postID, targetNama) {
            const input = document.getElementById(`input-${postID}`);
            let pesan = input.value.trim();
            if (!userSession.ID) return alert("Login dulu ya!");
            if (!pesan) return;

            if (targetNama) pesan = `<span class="tag-name">@${targetNama}</span> ` + pesan;

            db.ref(`testimoni_publik/${postID}/balasan`).push({
                userID: userSession.ID,
                nama: userSession.Nama,
                foto: userSession.Foto,
                pesan: pesan,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                input.value = "";
                document.getElementById(`field-${postID}`).classList.add('hidden');
                // Otomatis buka balasan setelah mengirim agar user melihat hasilnya
                document.getElementById(`replies-${postID}`).classList.remove('hidden');
            });
        }

        // Fungsi toggle untuk Sembunyi/Lihat Balasan
        function toggleReplies(postID) {
            const replyContainer = document.getElementById(`replies-${postID}`);
            const btnText = document.getElementById(`btn-text-${postID}`);
            const btnIcon = document.getElementById(`btn-icon-${postID}`);
            
            if (replyContainer.classList.contains('hidden')) {
                replyContainer.classList.remove('hidden');
                btnText.innerText = "Sembunyikan Balasan";
                btnIcon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            } else {
                replyContainer.classList.add('hidden');
                btnText.innerText = "Lihat Balasan";
                btnIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            }
        }

        function openReply(postID, namaTujuan) {
            const field = document.getElementById(`field-${postID}`);
            const input = document.getElementById(`input-${postID}`);
            field.classList.remove('hidden');
            input.focus();
            if(namaTujuan) input.placeholder = `Balas ${namaTujuan}...`;
        }

        db.ref('testimoni_publik').on('value', (snapshot) => {
            const listDiv = document.getElementById('containerList');
            listDiv.innerHTML = "";
            
            let dataArray = [];
            snapshot.forEach(c => { 
                let val = c.val(); 
                val.key = c.key; 
                dataArray.push(val); 
            });
            dataArray.reverse();

            dataArray.forEach(data => {
                let balasanHtml = "";
                let jumlahBalasan = 0;
                
                if (data.balasan) {
                    const balasanList = Object.values(data.balasan);
                    jumlahBalasan = balasanList.length;
                    balasanList.forEach(r => {
                        balasanHtml += `
                            <div class="reply-card p-3 rounded-xl mt-2 border border-gray-50">
                                <div class="flex items-center gap-2 mb-1">
                                    <img src="${r.foto}" class="w-5 h-5 rounded-full object-cover">
                                    <span class="text-[11px] font-bold text-gray-700">${r.nama}</span>
                                </div>
                                <div class="text-xs text-gray-600 mb-1 leading-relaxed">${r.pesan}</div>
                                <span onclick="openReply('${data.key}', '${r.nama}')" class="btn-action hover:text-orange-500">Balas</span>
                            </div>
                        `;
                    });
                }

                // Tombol Lihat Balasan hanya muncul jika ada balasan
                const showReplyBtn = jumlahBalasan > 0 ? `
                    <div class="btn-view-replies" onclick="toggleReplies('${data.key}')">
                        <i id="btn-icon-${data.key}" class="fas fa-chevron-down text-[10px]"></i>
                        <span id="btn-text-${data.key}">Lihat ${jumlahBalasan} Balasan</span>
                    </div>
                ` : "";

                listDiv.innerHTML += `
                    <div class="bg-white p-4 comment-card shadow-sm border border-gray-100">
                        <div class="flex items-center gap-3 mb-3">
                            <img src="${data.foto}" class="w-10 h-10 rounded-full border-2 border-orange-100 object-cover">
                            <div>
                                <p class="text-sm font-bold text-gray-800">${data.nama}</p>
                                <p class="text-[9px] text-gray-400">Pelanggan Setia</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 mb-4 leading-relaxed font-medium">"${data.pesan}"</p>
                        
                        <div class="flex items-center border-t border-gray-50 pt-3">
                            <span onclick="openReply('${data.key}', '${data.nama}')" class="btn-action text-orange-500 bg-orange-50 px-3 py-1 rounded-full">
                                <i class="fas fa-comment-dots mr-1"></i> Balas
                            </span>
                        </div>

                        ${showReplyBtn}

                        <div id="replies-${data.key}" class="hidden space-y-1 mt-2">
                            ${balasanHtml}
                        </div>

                        <div id="field-${data.key}" class="mt-4 hidden">
                            <div class="flex gap-2">
                                <input id="input-${data.key}" type="text" 
                                    class="flex-1 text-xs p-3 bg-gray-50 rounded-xl outline-none border border-gray-200 focus:border-orange-400">
                                <button onclick="kirimBalasan('${data.key}', document.getElementById('input-${data.key}').placeholder.replace('Balas ','').replace('...',''))" 
                                    class="bg-orange-500 text-white px-4 rounded-xl text-[10px] font-bold shadow-sm">KIRIM</button>
                            </div>
                        </div>
                    </div>
                `;
            });
        });
    </script>
</body>
</html>
