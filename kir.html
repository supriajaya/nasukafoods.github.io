<!DOCTYPE html>
<html>
<head>
    <title>KIRIM Lokasi Live (Mang Cilok)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 15px; background-color: #f9f9f9; }
        h1 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        #map { 
            height: 350px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            margin-top: 15px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        /* Style untuk status: Hijau = Online, Merah = Error/Offline */
        .status { padding: 12px; border-radius: 4px; margin-bottom: 15px; font-weight: bold; border: 1px solid; }
        .status.online { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <h1>Kirim Lokasi Live üõµ</h1>
    
    <div id="status" class="status online">Menunggu inisialisasi Geolocation...</div>
    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- 1. KONFIGURASI DAN VARIABEL ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpI", 
            authDomain: "nasukafoods1.firebaseapp.com", 
            databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "nasukafoods1", 
            messagingSenderId: "84287800896", 
            appId: "1:84287800896:web:83189d6766997b00f701a5" 
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const database = firebase.database();
        const locationRef = database.ref('live_location/kurir_motor_osm'); 
        const statusElement = document.getElementById('status');
        
        let map;
        let currentMarker;
        const defaultLatLng = [-6.2088, 106.8456]; // Default Jakarta/Indonesia
        
        // Interval pengiriman lokasi diubah dari 15 menit menjadi 5 detik untuk live tracking yang responsif
        const UPDATE_INTERVAL_MS = 5000; // 5 detik
        
        // --- 2. FUNGSI UTAMA ---

        function initMap() {
            map = L.map('map').setView(defaultLatLng, 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Inisialisasi marker
            currentMarker = L.marker(defaultLatLng).addTo(map)
                .bindPopup('Lokasi Kurir')
                .openPopup();

            if (navigator.geolocation) {
                statusElement.innerHTML = `‚úÖ Geolocation aktif. Mulai pelacakan setiap ${UPDATE_INTERVAL_MS / 1000} detik...`;
                statusElement.classList.remove('error');
                statusElement.classList.add('online');
                
                // Ambil dan kirim lokasi pertama kali
                getLocationAndSend(); 
                
                // Atur interval pengiriman lokasi
                setInterval(getLocationAndSend, UPDATE_INTERVAL_MS);
                
            } else {
                statusElement.innerHTML = "‚ùå Geolocation tidak didukung oleh browser Anda.";
                statusElement.classList.remove('online');
                statusElement.classList.add('error');
            }
        }
        
        /**
         * Meminta lokasi saat ini dari Geolocation API.
         */
        function getLocationAndSend() {
            navigator.geolocation.getCurrentPosition(sendLocation, locationError, {
                enableHighAccuracy: true,
                timeout: 5000 // Timeout 5 detik untuk mendapatkan lokasi
            });
            // Tampilkan pesan bahwa lokasi sedang dicari
            const timeNow = new Date().toLocaleTimeString('id-ID');
            statusElement.innerHTML = `‚è≥ Mencari lokasi baru pada ${timeNow}...`;
            statusElement.classList.remove('error');
            statusElement.classList.add('online');
        }

        /**
         * Callback berhasil: Mengirim lokasi ke Firebase.
         * @param {GeolocationPosition} position - Objek posisi dari Geolocation API.
         */
        function sendLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const latLng = [lat, lng];
            
            // Waktu lokal untuk ditampilkan
            const timestampLocal = new Date().toLocaleTimeString('id-ID'); 
            const nextUpdateInSeconds = UPDATE_INTERVAL_MS / 1000;

            // --- PERUBAHAN PENTING: Menambahkan Server Timestamp ---
            locationRef.set({ 
                lat: lat, 
                lng: lng,
                // Waktu lokal hanya untuk tampilan di halaman ini
                time: timestampLocal, 
                accuracy: position.coords.accuracy,
                // **INI PENTING**: Menggunakan ServerValue.TIMESTAMP untuk cek offline di halaman view
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => {
                const message = `‚úÖ Lokasi **berhasil terkirim** (Mang Cilok). Terakhir: ${timestampLocal}. Akurasi: ¬±${position.coords.accuracy.toFixed(1)}m. Update berikutnya dalam ${nextUpdateInSeconds} detik.`;
                statusElement.innerHTML = message;
                statusElement.classList.remove('error');
                statusElement.classList.add('online');
            }).catch(error => {
                const message = `‚ùå Gagal mengirim ke Firebase: ${error.message}`;
                statusElement.innerHTML = message;
                statusElement.classList.remove('online');
                statusElement.classList.add('error');
            });

            // Perbarui marker di peta dan pusat peta
            currentMarker.setLatLng(latLng).bindPopup(`Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`);
            map.setView(latLng, 15); 
        }

        /**
         * Callback gagal: Menangani error Geolocation.
         * @param {GeolocationPositionError} error - Objek error Geolocation.
         */
        function locationError(error) {
            const message = `‚ö†Ô∏è Gagal melacak lokasi: ${error.message}. Kode: ${error.code}. Mencoba lagi dalam ${UPDATE_INTERVAL_MS / 1000} detik.`;
            statusElement.innerHTML = message;
            statusElement.classList.remove('online');
            statusElement.classList.add('error');
            console.error("Geolocation Error:", error);
        }
        
        // Mulai inisialisasi
        initMap();
    </script>
</body>
</html>
