<!DOCTYPE html>
<html>
<head>
    <title>KIRIM Lokasi Live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 15px; }
        #map { height: 350px; border: 1px solid #ccc; border-radius: 8px; margin-top: 15px; }
        .status { padding: 10px; background-color: #d4edda; color: #155724; border-radius: 4px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Pengirim Lokasi Live ðŸ”´</h1>
    <p>Mohon izinkan akses lokasi saat diminta oleh browser.</p>
    
    <div id="status" class="status">Menunggu inisialisasi...</div>
    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    
    <script>
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpI",
            authDomain: "nasukafoods1.firebaseapp.com",
            databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nasukafoods1",
            messagingSenderId: "84287800896",
            appId: "1:84287800896:web:83189d6766997b00f701a5"
        };
        
        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const database = firebase.database();
        // Node tempat lokasi akan disimpan. Pastikan node ini SAMA di file pelacak.
        const locationRef = database.ref('live_location/kurir_motor'); 

        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var currentMarker;
        const statusElement = document.getElementById('status');

        function sendLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const timestamp = new Date().toLocaleTimeString();

            // MENGIRIM lokasi ke Firebase
            locationRef.set({ 
                lat: lat, 
                lng: lng,
                time: timestamp
            })
            .then(() => {
                statusElement.innerHTML = `Lokasi terkirim. Terakhir: ${timestamp}. Lat: ${lat.toFixed(6)}`;
            });

            // Update peta lokal
            const latlng = [lat, lng];
            map.setView(latlng, 15);
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker(latlng).addTo(map)
                .bindPopup("Lokasi Saya Saat Ini")
                .openPopup();
        }

        function locationError(error) {
            statusElement.className = 'status';
            statusElement.style.backgroundColor = '#f8d7da';
            statusElement.style.color = '#721c24';
            statusElement.innerHTML = `Gagal melacak lokasi: ${error.message}`;
        }

        // Mulai melacak dan mengirim lokasi secara terus-menerus
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(sendLocation, locationError, {
                enableHighAccuracy: true,
                timeout: 10000 
            });
        } else {
            statusElement.innerHTML = "Geolocation tidak didukung oleh browser ini.";
        }
    </script>
</body>
</html>
