<!DOCTYPE html>
<html>
<head>
    <title>KIRIM Lokasi Live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 15px; }
        #map { height: 350px; border: 1px solid #ccc; border-radius: 8px; margin-top: 15px; }
        .status { padding: 10px; background-color: #d4edda; color: #155724; border-radius: 4px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>Kirim Lokasi Live ðŸŸ¢</h1>
    
    <div id="status" class="status">Menunggu inisialisasi...</div>
    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpI", 
            authDomain: "nasukafoods1.firebaseapp.com", 
            databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "nasukafoods1", 
            messagingSenderId: "84287800896", 
            appId: "1:84287800896:web:83189d6766997b00f701a5" 
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const database = firebase.database();
        const locationRef = database.ref('live_location/kurir_motor_osm'); 
        const statusElement = document.getElementById('status');
        
        let map;
        let currentMarker;
        const defaultLatLng = [-6.2088, 106.8456]; 
        
        const UPDATE_INTERVAL_MS = 15 * 60 * 1000; 

        function initMap() {
            map = L.map('map').setView(defaultLatLng, 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            currentMarker = L.marker(defaultLatLng).addTo(map)
                .bindPopup('Lokasi Saya')
                .openPopup();

            if (navigator.geolocation) {
                statusElement.innerHTML = "Mulai pelacakan dengan interval 15 menit...";
                
                getLocationAndSend(); 
                
                setInterval(getLocationAndSend, UPDATE_INTERVAL_MS);
                
            } else {
                statusElement.innerHTML = "Geolocation tidak didukung oleh browser Anda.";
            }
        }
        
        function getLocationAndSend() {
            navigator.geolocation.getCurrentPosition(sendLocation, locationError, {
                enableHighAccuracy: true,
                timeout: 10000 
            });
            statusElement.innerHTML = "Mencari lokasi baru...";
        }

        function sendLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const latLng = [lat, lng];
            const timestamp = new Date().toLocaleTimeString('id-ID'); 
            const nextUpdate = new Date(new Date().getTime() + UPDATE_INTERVAL_MS).toLocaleTimeString('id-ID');

            locationRef.set({ 
                lat: lat, 
                lng: lng,
                time: timestamp,
                accuracy: position.coords.accuracy
            }).then(() => {
                statusElement.innerHTML = `Lokasi **berhasil terkirim**. Terakhir: ${timestamp}. Lat: ${lat.toFixed(6)}. Update selanjutnya: ${nextUpdate}`;
            }).catch(error => {
                statusElement.innerHTML = `Gagal mengirim ke DB: ${error.message}`;
            });

            currentMarker.setLatLng(latLng);
            map.setView(latLng, 15); 
        }

        function locationError(error) {
            statusElement.innerHTML = `Gagal melacak lokasi: ${error.message}. Akan mencoba lagi dalam 15 menit.`;
        }
        
        initMap();
    </script>
</body>
</html>
