<!DOCTYPE html>  
<html lang="id">  
<head>  
  <meta charset="UTF-8" />  
  <title>Nasuka Chat</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>  
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>  
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>  
  <style>  
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #e5ddd5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      background-color: #075e54;
      color: white;
      padding: 10px;
      font-weight: bold;
      text-align: center;
      flex-shrink: 0;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    footer {
      position: sticky;
      bottom: 0;
      display: flex;
      padding: 10px;
      background: #f0f0f0;
      flex-shrink: 0;
    }
    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 10px;
      line-height: 1.4;
      word-break: break-word;
    }
    .me {
      background-color: #dcf8c6;
      align-self: flex-end;
    }
    .them {
      background-color: white;
      align-self: flex-start;
    }
    input[type="text"] {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 20px;
      outline: none;
    }
    button {
      margin-left: 8px;
      padding: 8px 12px;
      border: none;
      background: #075e54;
      color: white;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>  
</head>  
<body>  

<header id="chatHeader">Chat</header>
<div id="chat"></div>  

<footer>  
  <input type="text" id="messageInput" placeholder="Ketik pesan..."/>  
  <button id="sendBtn">Kirim</button>  
</footer>  

<script>  
const firebaseConfig = {  
  apiKey: "AIzaSyDE17I5nEIdrfQhfRP5ewloydX18Sw47ws",  
  authDomain: "nasukachat.firebaseapp.com",  
  databaseURL: "https://nasukachat-default-rtdb.asia-southeast1.firebasedatabase.app",  
  projectId: "nasukachat",  
  storageBucket: "nasukachat.appspot.com",  
  messagingSenderId: "759589458121",  
  appId: "1:759589458121:web:d5670da0d080017e2ffd18"  
};  
  
firebase.initializeApp(firebaseConfig);  
const db = firebase.database();  
  
const userID = localStorage.userID || '';  
const username = localStorage.username || '';  
const receiverID = localStorage.chatWithID || '';  
const receiverName = localStorage.chatWithName || 'Teman';  

document.getElementById('chatHeader').textContent = receiverName;

const chatRef = db.ref('privateChat/' + [userID, receiverID].sort().join('_'));  
const chatBox = document.getElementById('chat');  
const textInput = document.getElementById('messageInput');  
const sendBtn = document.getElementById('sendBtn');  
  
function appendMessage(msg, key) {
  const wrapper = document.createElement('div');
  wrapper.className = 'message ' + (msg.sender === userID ? 'me' : 'them');
  wrapper.dataset.key = key;

  const nameDiv = document.createElement('div');
  nameDiv.textContent = msg.nama;
  nameDiv.style.fontSize = '0.75em';
  nameDiv.style.color = '#555';
  nameDiv.style.marginBottom = '3px';

  const text = document.createElement('div');
  text.textContent = msg.text;

  wrapper.appendChild(nameDiv);
  wrapper.appendChild(text);
  chatBox.appendChild(wrapper);
  chatBox.scrollTop = chatBox.scrollHeight;

  if (msg.sender === userID) {
    wrapper.addEventListener('contextmenu', e => {
      e.preventDefault();
      if (confirm('Hapus pesan ini?')) {
        chatRef.child(key).remove();
      }
    });
  }
}

sendBtn.onclick = () => {  
  const text = textInput.value.trim();  
  if (!text) return;  

  const waktu = new Date().toISOString();  
  chatRef.push({  
    sender: userID,  
    nama: username,  
    text,  
    waktu  
  });  

  textInput.value = '';  
};  

chatRef.limitToLast(100).once('value', snapshot => {
  const list = [];
  snapshot.forEach(child => {
    list.push({ key: child.key, val: child.val() });
  });

  let i = 0;
  const interval = setInterval(() => {
    if (i >= list.length) {
      clearInterval(interval);
    } else {
      const { key, val } = list[i++];
      appendMessage(val, key);
    }
  }, 10);
});

chatRef.limitToLast(1).on('child_added', snapshot => {
  const data = snapshot.val();  
  const key = snapshot.key;  
  appendMessage(data, key);  
});
</script>  
</body>  
</html>
