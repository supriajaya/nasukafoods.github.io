<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Nasuka Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://nasukafoods.site/chat.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://nasukafoods.site/realtime.js"></script>
  <style>
  .msg {
  max-width: 70%;
  margin: 5px 0;
  padding: 8px 12px;
  border-radius: 10px;
  word-wrap: break-word;
  display: inline-block;
}

/* Pesan dari kamu (diri sendiri) */
.msg.me {
  background-color: #dcf8c6; /* Hijau muda */
  align-self: flex-end;
  border-top-right-radius: 0;
  text-align: right;
}

/* Pesan dari lawan bicara */
.msg:not(.me) {
  background-color: #ffffff; /* Putih */
  align-self: flex-start;
  border-top-left-radius: 0;
  text-align: left;
}
  
  </style>
</head>
<body>
  <div id="chatContainer">
    <div id="topBar" onclick="window.location.href='inbox.html?id=' + encodeURIComponent(targetID)">
      <img id="targetFotoEl" src="" alt="Foto">
      <span id="roomTitle">Chat</span>
    </div>
    <div id="chatBox"></div>
    <div id="inputContainer">
      <textarea id="inputMessage" rows="1" placeholder="Ketik pesan..."></textarea>
      <button id="sendBtn">&#9658;</button>
    </div>
  </div>

  <script>
    // Pastikan Firebase db sudah terdefinisi di realtime.js
    const ID = localStorage.getItem('ID') || '';
    const Username = localStorage.getItem('Username') || '';
    const Nama = localStorage.getItem('Nama') || '';
    const targetID = localStorage.getItem('targetID') || '';
    const targetNama = localStorage.getItem('targetNama') || '';
    const targetFoto = localStorage.getItem('targetFoto') || '';

    if (!ID || !targetID) {
      alert("Gagal memuat data pengguna atau target.");
    }

    const room = [ID, targetID].sort().join('_');
    const chatRef = db.ref('rooms/' + room + '/chats');

    const chatBox = document.getElementById('chatBox');
    const input = document.getElementById('inputMessage');
    const btn = document.getElementById('sendBtn');
    const targetFotoEl = document.getElementById('targetFotoEl');
    const roomTitle = document.getElementById('roomTitle');

    targetFotoEl.src = targetFoto || 'default.jpg';
    roomTitle.textContent = targetNama;

    btn.onclick = kirim;
    input.addEventListener('keypress', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        kirim();
      }
    });

    function kirim() {
      const msg = input.value.trim();
      if (msg) {
        const waktu = Date.now();
        const pesanData = {
          ID: ID,
          Username: Username,
          Nama: Nama,
          Pesan: msg,
          Waktu: waktu
        };

        // Kirim ke node percakapan
        chatRef.push(pesanData);

        // Update summary chat untuk pengirim
        db.ref('users/' + ID + '/chats/' + targetID).set({
          room: room,
          ID: targetID,
          Username: targetNama,
          Foto: targetFoto,
          Terakhir: msg,
          Waktu: waktu
        });

        // Update summary chat untuk penerima
        db.ref('users/' + targetID + '/chats/' + ID).set({
          room: room,
          ID: ID,
          Username: Nama,
          Foto: '', // Foto kamu, jika ada
          Terakhir: msg,
          Waktu: waktu
        });

        input.value = '';
        input.style.height = 'auto';
      }
    }

    // Menampilkan pesan real-time
    chatRef.on('child_added', function (snap) {
      const data = snap.val();
      const msgEl = document.createElement('div');
      msgEl.className = data.ID === ID ? 'msg me' : 'msg';
      msgEl.textContent = data.Pesan;
      chatBox.appendChild(msgEl);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // Auto resize textarea
    input.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  </script>
</body>
</html>
