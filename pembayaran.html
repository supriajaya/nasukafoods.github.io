<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pembayaran</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; color: #4CAF50; }
    .section { background: white; padding: 15px; margin: 10px 0; border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table th, table td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
    .total { font-weight: bold; color: #e67e22; }
    label { display: block; margin-top: 8px; }
    input[type="file"] { margin-top: 5px; }
    button {
      margin-top: 15px;
      padding: 10px;
      width: 100%;
      background: #4CAF50;
      color: white;
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:disabled { background: #ccc; }
    #kwitansi {
      background: #fff;
      border: 2px dashed #4CAF50;
      padding: 15px;
      margin-top: 20px;
      border-radius: 6px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Pembayaran</h1>

  <div class="section">
    <h2>Data Pesanan</h2>
    <table>
      <tr><th>Produk</th><td id="namaProduk">-</td></tr>
      <tr><th>Harga</th><td id="hargaProduk">-</td></tr>
      <tr><th>Kuantitas</th><td id="jumlahProduk">-</td></tr>
      <tr><th>Total</th><td id="totalHarga" class="total">-</td></tr>
    </table>
  </div>

  <div class="section">
    <h2>Data Pengguna</h2>
    <p><strong>Nama:</strong> <span id="namaUser">-</span></p>
    <p><strong>Telepon:</strong> <span id="teleponUser">-</span></p>
    <p><strong>Alamat:</strong> <span id="alamatUser">-</span></p>
    <p><strong>Saldo:</strong> <span id="saldoUser">-</span></p>
  </div>

  <div class="section">
    <h2>Metode Pembayaran</h2>
    <label><input type="radio" name="metode" value="SALDO" checked> Saldo</label>
    <label><input type="radio" name="metode" value="TRANSFER_BANK"> Transfer Bank</label>
    <label><input type="radio" name="metode" value="QRIS"> QRIS</label>
    <label><input type="radio" name="metode" value="TUNAI"> Tunai</label>
    <label id="buktiLabel">Upload Bukti (jika perlu): <input type="file" id="bukti" accept="image/*"></label>
  </div>

  <button onclick="submitOrder()">Bayar Sekarang</button>

  <div id="kwitansi">
    <h3>âœ… Pembayaran Berhasil</h3>
    <p><strong>Produk:</strong> <span id="kwitansiProduk"></span></p>
    <p><strong>Total Bayar:</strong> <span id="kwitansiTotal"></span></p>
    <p><strong>Sisa Saldo:</strong> <span id="kwitansiSaldo"></span></p>
    <button onclick="window.location.href='index.html'">Kembali ke Beranda</button>
  </div>

  <script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbwL9L9lI4GViVClRwcGN4dg2iyqhN_bPGnuwFL5v1Q_UMp5uZqdbQJmy9LIYwG81Dqy/exec";
    const order = JSON.parse(localStorage.getItem("currentOrder") || "{}");
    const username = localStorage.getItem("username");

    document.getElementById("namaProduk").textContent = order.name || "-";
    document.getElementById("hargaProduk").textContent = formatRupiah(order.price || 0);
    document.getElementById("jumlahProduk").textContent = order.quantity || 1;
    document.getElementById("totalHarga").textContent = formatRupiah(order.price * order.quantity);

    if (username) {
      fetch(`${URL_GAS}?action=getProfileByUsername&username=${encodeURIComponent(username)}`)
        .then(res => res.json())
        .then(data => {
          window.userData = data;
          document.getElementById("namaUser").textContent = data.Nama || "-";
          document.getElementById("teleponUser").textContent = data.Telepon || "-";
          document.getElementById("alamatUser").textContent = data.Alamat || "-";
          document.getElementById("saldoUser").textContent = formatRupiah(data.Saldo || 0);
        });
    }

    document.querySelectorAll('input[name="metode"]').forEach(radio => {
      radio.addEventListener('change', () => {
        const metode = document.querySelector('input[name="metode"]:checked').value;
        document.getElementById("buktiLabel").style.display = 
          (metode === "SALDO" || metode === "TUNAI") ? "none" : "block";
      });
    });

    async function submitOrder() {
      const metode = document.querySelector('input[name="metode"]:checked').value;
      const file = document.getElementById("bukti").files[0];
      const formData = new FormData();

      formData.append("action", "submitOrder");
      formData.append("product_name", order.name || "");
      formData.append("product_price", order.price || 0);
      formData.append("product_quantity", order.quantity || 1);
      formData.append("total_pembayaran", order.price * order.quantity);
      formData.append("metode_pembayaran", metode);
      if (username) formData.append("username", username);

      if (file && metode !== "SALDO" && metode !== "TUNAI") {
        const base64 = await fileToBase64(file);
        formData.append("bukti_pembayaran_base64", base64);
      }

      try {
        const res = await fetch(URL_GAS, { method: "POST", body: formData });
        const result = await res.json();

        if (result.status === "Success") {
          localStorage.removeItem("currentOrder");

          if (metode === "SALDO") {
            document.getElementById("kwitansiProduk").textContent = order.name;
            document.getElementById("kwitansiTotal").textContent = formatRupiah(order.price * order.quantity);
            document.getElementById("kwitansiSaldo").textContent = formatRupiah(result.saldo_terbaru || 0);
            document.getElementById("kwitansi").style.display = "block";
          } else {
            alert("Pembayaran berhasil!");
            window.location.href = "index.html";
          }
        } else {
          alert("Gagal: " + (result.message || "Tidak diketahui"));
        }
      } catch (e) {
        alert("Koneksi gagal");
        console.error(e);
      }
    }

    function formatRupiah(angka) {
      if (!angka || isNaN(angka)) return "Rp 0";
      return 'Rp ' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
