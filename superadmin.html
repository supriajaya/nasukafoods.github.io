<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Admin Mobile - Nasuka</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-size: 14px; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; height: calc(100vh - 120px); overflow-y: auto; padding-bottom: 80px; }
        .tab-content.active { display: block; }
        .nav-active { color: #ee4d2d !important; }
        .nav-active i { transform: translateY(-5px); color: #ee4d2d; }
        #chatDisplay { height: 60vh; }
        .msg-bubble { max-width: 85%; padding: 8px 12px; border-radius: 15px; font-size: 13px; line-height: 1.4; }
        .tag-admin { background: #ffebee; color: #c62828; font-size: 9px; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .tag-user { background: #e3f2fd; color: #1565c0; font-size: 9px; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        #historyModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        .card-post { border-left: 4px solid #ef4444; }
        .card-reply { border-left: 3px solid #94a3b8; background-color: #f8fafc; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">

    <header class="bg-slate-800 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
        <h1 class="font-bold tracking-tight">NASUKA <span class="text-orange-500">ADMIN</span></h1>
        <button onclick="toggleSidebar()" class="text-xl"><i class="fas fa-bars"></i></button>
    </header>

    <div id="sidebar" class="fixed inset-0 bg-black/50 z-[60] hidden transition-opacity" onclick="toggleSidebar()">
        <div class="w-64 bg-white h-full p-5 overflow-y-auto" onclick="event.stopPropagation()">
            <h2 class="font-bold border-b pb-3 mb-4 text-slate-700 text-sm">Panel Kontrol</h2>
            <nav class="space-y-4">
                <button onclick="openTab('tab-otoritas'); toggleSidebar()" class="flex items-center gap-3 w-full text-blue-700 font-bold"><i class="fas fa-user-shield"></i> Otoritas User</button>
                <button onclick="openTab('tab-mod-post'); toggleSidebar()" class="flex items-center gap-3 w-full text-red-600 font-bold"><i class="fas fa-stream"></i> Moderasi Postingan</button>
                <button onclick="openTab('tab-del'); toggleSidebar()" class="flex items-center gap-3 w-full text-red-500 font-bold"><i class="fas fa-trash-alt"></i> Kelola Hapus Chat</button>
                <button onclick="openTab('tab-part'); toggleSidebar()" class="flex items-center gap-3 w-full text-blue-600 font-bold"><i class="fas fa-handshake"></i> Manajemen Partner</button>
                <button onclick="openTab('tab-post'); toggleSidebar()" class="flex items-center gap-3 w-full text-slate-600"><i class="fas fa-history"></i> Pulihkan Kenangan</button>
                <button onclick="openTab('tab-sponsor'); toggleSidebar()" class="flex items-center gap-3 w-full text-orange-500"><i class="fas fa-ad"></i> Manajemen Sponsor</button>
                <div class="border-t pt-4 mt-4">
                    <p class="text-[10px] text-gray-400 font-bold uppercase">System: NasukaFoods1</p>
                </div>
            </nav>
        </div>
    </div>

    <main class="container mx-auto">
        
        <div id="tab-otoritas" class="tab-content p-4">
            <div class="mb-4">
                <input type="text" id="adminSearch" placeholder="Cari Nama, Username, HP, atau Alamat..." class="w-full p-3 border rounded-xl shadow-sm outline-none text-sm">
            </div>
            <div id="userListOtoritas" class="space-y-3"></div>
        </div>

        <div id="tab-chat" class="tab-content active">
            <div id="userListContainer" class="p-2">
                <div class="bg-white rounded-xl shadow-sm border p-4 mb-2 font-bold text-center">Inbox Pelanggan</div>
                <div id="userListChat" class="space-y-2"></div>
            </div>
            <div id="chatRoom" class="fixed inset-0 bg-white z-[55] hidden flex flex-col">
                <div class="p-4 bg-slate-100 border-b flex items-center gap-3">
                    <button onclick="closeChat()" class="text-lg"><i class="fas fa-arrow-left"></i></button>
                    <div id="activeUserName" class="font-bold text-sm truncate">...</div>
                </div>
                <div id="chatDisplay" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 bg-slate-50"></div>
                <div class="p-3 border-t bg-white flex gap-2">
                    <input type="text" id="adminInput" class="flex-1 p-2 border rounded-full px-4 text-sm outline-none" placeholder="Balas...">
                    <button onclick="sendReply()" class="bg-orange-600 text-white w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="tab-mod-post" class="tab-content p-4">
            <h2 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-shield-alt text-red-500"></i> Kelola Postingan Publik</h2>
            <div id="containerPostingan" class="space-y-4"></div>
        </div>

        <div id="tab-part" class="tab-content p-4">
            <div class="bg-white p-5 rounded-2xl border shadow-sm mb-4">
                <h2 class="font-bold text-blue-600 mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> Tambah Partner</h2>
                <input id="pNama" type="text" placeholder="Nama Partner" class="w-full p-3 bg-gray-50 border rounded-xl mb-3 text-sm outline-none">
                <input id="pImage" type="text" placeholder="URL Gambar/Logo" class="w-full p-3 bg-gray-50 border rounded-xl mb-3 text-sm outline-none">
                <input id="pUrl" type="text" placeholder="URL Link (Optional)" class="w-full p-3 bg-gray-50 border rounded-xl mb-4 text-sm outline-none">
                <button onclick="savePartner()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Simpan Partner</button>
            </div>
            <div id="listPartner" class="space-y-3"></div>
        </div>

        <div id="tab-del" class="tab-content p-4">
            <div class="bg-white p-4 rounded-2xl border mb-4">
                <h2 class="font-bold text-red-600 mb-2 flex items-center gap-2"><i class="fas fa-user-shield"></i> Moderasi Chat</h2>
                <div id="userListDel" class="space-y-2 max-h-40 overflow-y-auto border-b pb-4"></div>
            </div>
            <div id="messageManageArea" class="hidden">
                <div class="flex justify-between items-center mb-3">
                    <div id="targetNameDel" class="font-bold text-xs truncate max-w-[150px]"></div>
                    <button onclick="deleteAllChat()" class="bg-red-600 text-white text-[10px] px-3 py-1 rounded-full font-bold">HAPUS SEMUA</button>
                </div>
                <div id="messageList" class="space-y-2 bg-white p-3 rounded-xl border"></div>
            </div>
        </div>

        <div id="tab-topup" class="tab-content p-4">
            <div class="bg-white p-4 rounded-2xl border mb-4">
                <h2 class="font-bold mb-3 text-blue-600">Top Up Manual</h2>
                <input type="text" id="targetUsername" placeholder="Username" class="w-full p-3 bg-gray-50 border rounded-xl mb-2 text-sm outline-none">
                <input type="number" id="topupAmount" placeholder="Nominal Rp" class="w-full p-3 bg-gray-50 border rounded-xl mb-3 text-sm outline-none">
                <button onclick="prosesTopUpManual()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Kirim Saldo</button>
            </div>
            <div class="bg-white p-4 rounded-2xl border mb-4">
                <h2 class="font-bold mb-3 text-green-600">Voucher Saldo</h2>
                <div class="flex gap-2 mb-2">
                    <input type="number" id="sCode" placeholder="6-Digit" class="w-1/2 p-3 bg-gray-50 border rounded-xl text-sm outline-none">
                    <input type="number" id="sValue" placeholder="Nilai Rp" class="w-1/2 p-3 bg-gray-50 border rounded-xl text-sm outline-none">
                </div>
                <button onclick="addSaldoVoucher()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">Buat Voucher</button>
            </div>
            <div id="sList" class="grid grid-cols-2 gap-2"></div>
        </div>

        <div id="tab-voucher" class="tab-content p-4">
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-2xl border">
                    <h2 class="font-bold text-red-600 mb-2">Voucher Telkomsel (<span id="stokTsel">0</span>)</h2>
                    <textarea id="inputKodeTsel" class="w-full p-2 bg-gray-50 border rounded-lg h-20 text-xs mb-2" placeholder="Kode per baris..."></textarea>
                    <button onclick="simpanVoucherPath('vouchers_tsel', 'inputKodeTsel')" class="w-full bg-red-600 text-white py-2 rounded-lg text-sm font-bold">Input T-Sel</button>
                    <div id="listTsel" class="mt-3 space-y-1 max-h-40 overflow-y-auto"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border">
                    <h2 class="font-bold text-purple-600 mb-2">Voucher Axis (<span id="stokAxis">0</span>)</h2>
                    <textarea id="inputKodeAxis" class="w-full p-2 bg-gray-50 border rounded-lg h-20 text-xs mb-2" placeholder="Kode per baris..."></textarea>
                    <button onclick="simpanVoucherPath('vouchers_axis', 'inputKodeAxis')" class="w-full bg-purple-600 text-white py-2 rounded-lg text-sm font-bold">Input Axis</button>
                    <div id="listAxis" class="mt-3 space-y-1 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <div id="tab-wifi" class="tab-content p-4">
            <div class="bg-white p-4 rounded-2xl border mb-4">
                <h2 class="font-bold text-green-600 mb-2">Voucher WiFi (Stok: <span id="stokWifi">0</span>)</h2>
                <div class="flex gap-2">
                    <input type="text" id="vCodeWifi" class="flex-1 p-3 border rounded-xl text-sm outline-none" placeholder="Kode WiFi">
                    <button onclick="simpanWifi()" class="bg-green-600 text-white px-4 rounded-xl"><i class="fas fa-plus"></i></button>
                </div>
                <div id="listWifi" class="mt-3 flex flex-wrap gap-1"></div>
            </div>
            <div class="bg-white p-4 rounded-2xl border">
                <h2 class="font-bold text-slate-700 mb-2">Nitacell (Stok: <span id="stokNitacell">0</span>)</h2>
                <div class="flex gap-2">
                    <input type="text" id="pCodeNitacell" class="flex-1 p-3 border rounded-xl text-sm outline-none" placeholder="Kode Nita">
                    <button onclick="addNitacellVoucher()" class="bg-slate-700 text-white px-4 rounded-xl"><i class="fas fa-plus"></i></button>
                </div>
                <div id="listNitacell" class="mt-3 space-y-1"></div>
            </div>
        </div>

        <div id="tab-post" class="tab-content p-4">
            <div class="bg-white p-5 rounded-2xl border shadow-sm">
                <h2 class="font-bold text-slate-800 mb-4">Pemulihan Kenangan</h2>
                <input id="adminNama" type="text" placeholder="Nama Pengirim" class="w-full p-3 border rounded-xl mb-3 text-sm">
                <textarea id="adminPesan" placeholder="Isi Kenangan..." class="w-full p-3 border rounded-xl mb-3 h-24 text-sm"></textarea>
                <input id="adminTanggal" type="date" class="w-full p-3 border rounded-xl mb-4 text-sm">
                <button onclick="postSebagaiAdmin()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Posting Sekarang</button>
            </div>
        </div>

        <div id="tab-sponsor" class="tab-content p-4">
            <div class="bg-white p-4 rounded-2xl border">
                <h2 class="font-bold text-orange-600 mb-3">Input Sponsor</h2>
                <input type="text" id="spName" placeholder="Nama" class="w-full p-2 border rounded mb-2 outline-none text-sm">
                <input type="text" id="spUrl" placeholder="Link (http)" class="w-full p-2 border rounded mb-2 outline-none text-sm">
                <input type="text" id="spImg" placeholder="Link Icon" class="w-full p-2 border rounded mb-3 outline-none text-sm">
                <button onclick="saveSponsor()" class="w-full bg-orange-600 text-white py-2 rounded-lg font-bold mb-4">Simpan</button>
                <div id="sponsorList" class="space-y-2"></div>
            </div>
        </div>

    </main>

    <div id="historyModal" onclick="closeModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 overflow-hidden flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
            <h3 class="font-bold border-b pb-3 mb-4 flex justify-between">
                Riwayat Transaksi
                <button onclick="closeModal()" class="text-gray-400">&times;</button>
            </h3>
            <div id="historyContent" class="overflow-y-auto space-y-3 text-xs"></div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around items-center p-2 z-50 shadow-md">
        <button onclick="openTab('tab-chat')" class="nav-btn flex flex-col items-center gap-1 text-gray-400 nav-active" data-tab="tab-chat">
            <i class="fas fa-comment-dots text-lg"></i>
            <span class="text-[10px] font-bold">Chat</span>
        </button>
        <button onclick="openTab('tab-topup')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-tab="tab-topup">
            <i class="fas fa-wallet text-lg"></i>
            <span class="text-[10px] font-bold">Saldo</span>
        </button>
        <button onclick="openTab('tab-otoritas')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-tab="tab-otoritas">
            <i class="fas fa-users-cog text-lg"></i>
            <span class="text-[10px] font-bold">User</span>
        </button>
        <button onclick="openTab('tab-voucher')" class="nav-btn flex flex-col items-center gap-1 text-gray-400" data-tab="tab-voucher">
            <i class="fas fa-ticket-alt text-lg"></i>
            <span class="text-[10px] font-bold">Kupon</span>
        </button>
    </nav>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
            authDomain: "nasukafoods1.firebaseapp.com",
            databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nasukafoods1",
            messagingSenderId: "84287800896",
            appId: "1:84287800896:web:83189d6766997b00f701a5"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        // UI HELPERS
        function toggleSidebar() { $('#sidebar').toggleClass('hidden'); }
        function openTab(tabId) {
            $('.tab-content').removeClass('active');
            $('.nav-btn').removeClass('nav-active');
            $('#' + tabId).addClass('active');
            $(`[onclick="openTab('${tabId}')"]`).addClass('nav-active');
            window.scrollTo(0,0);
        }

        // --- 1. OTORITAS USER LOGIC (ALAMAT & HP) ---
        function loadUsers() {
            db.ref('users').on('value', (snap) => {
                const container = document.getElementById('userListOtoritas');
                container.innerHTML = "";
                snap.forEach((child) => {
                    const u = child.val();
                    const uID = child.key;
                    const alamat = u.Alamat || "Alamat belum diatur";
                    const nomorhp = u.NomorHP || u.Phone || "Tidak ada nomor";
                    const searchData = `${u.Nama} ${u.Username} ${nomorhp} ${alamat}`.toLowerCase();
                    
                    container.innerHTML += `
                        <div class="user-card bg-white p-4 rounded-2xl border shadow-sm" data-search="${searchData}">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-800 text-sm">${u.Nama} <span class="text-[10px] text-gray-400 font-normal">(@${u.Username})</span></div>
                                    <div class="text-[11px] text-blue-600 font-bold mt-1"><i class="fas fa-phone-alt"></i> ${nomorhp}</div>
                                    <div class="text-[11px] text-gray-500 mt-1 leading-tight"><i class="fas fa-map-marker-alt text-red-400"></i> ${alamat}</div>
                                </div>
                                <div class="text-right ml-2">
                                    <div class="text-xs font-bold text-orange-600">Rp ${u.Saldo ? u.Saldo.toLocaleString('id-ID') : 0}</div>
                                    <button onclick="editSaldo('${uID}', ${u.Saldo || 0})" class="text-[9px] bg-slate-100 px-2 py-1 rounded font-bold uppercase mt-1">Ubah Saldo</button>
                                </div>
                            </div>
                            <div class="flex gap-2 border-t pt-3">
                                <button onclick="viewHistory('${uID}')" class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg text-[10px] font-bold"><i class="fas fa-history"></i> RIWAYAT BELANJA</button>
                                <button onclick="deleteAccount('${uID}', '${u.Username}')" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-[10px] font-bold"><i class="fas fa-user-times"></i> HAPUS</button>
                            </div>
                        </div>`;
                });
            });
        }

        function editSaldo(userId, oldSaldo) {
            const val = prompt("Input Nominal Saldo Baru:", oldSaldo);
            if (val !== null && val !== "") db.ref(`users/${userId}`).update({ Saldo: parseInt(val) });
        }

        function viewHistory(userId) {
            $('#historyModal').css('display', 'flex');
            $('#historyContent').html('<p class="text-center py-10">Memuat riwayat...</p>');
            db.ref(`history/${userId}`).once('value', (snap) => {
                const content = document.getElementById('historyContent');
                content.innerHTML = "";
                if (snap.exists()) {
                    snap.forEach((child) => {
                        const d = child.val();
                        content.innerHTML += `
                            <div class="p-3 bg-gray-50 rounded-xl border-l-4 border-orange-500">
                                <div class="flex justify-between font-bold text-slate-700"><span>${d.produk}</span> <span class="text-red-600">-Rp ${d.total ? d.total.toLocaleString('id-ID') : 0}</span></div>
                                <div class="text-[10px] text-gray-400 mt-1">${d.tanggal} | ${d.status}</div>
                            </div>`;
                    });
                } else content.innerHTML = '<p class="text-center text-gray-400 py-10">Belum ada transaksi.</p>';
            });
        }

        function deleteAccount(id, name) {
            if (confirm(`Hapus akun ${name}? Semua data akan hilang.`)) {
                db.ref(`users/${id}`).remove();
                db.ref(`history/${id}`).remove();
                db.ref(`chats/${id}`).remove();
                db.ref(`admin_inbox/${id}`).remove();
            }
        }
        function closeModal() { $('#historyModal').hide(); }

        // --- 2. CHAT & MODERASI CHAT ---
        db.ref('admin_inbox').on('value', (snap) => {
            const list = document.getElementById('userListChat');
            const listDel = document.getElementById('userListDel');
            list.innerHTML = ""; listDel.innerHTML = "";
            snap.forEach(child => {
                const u = child.val();
                list.innerHTML += `<div class="bg-white p-4 rounded-xl border flex justify-between items-center" onclick="selectUser('${child.key}', '${u.nama}')">
                    <div class="truncate"><div class="font-bold text-sm">${u.nama}</div><div class="text-xs text-gray-400 truncate">${u.lastMsg}</div></div>
                    ${u.unread ? '<div class="w-2 h-2 bg-red-500 rounded-full"></div>' : ''}
                </div>`;
                listDel.innerHTML += `<div class="p-2 bg-slate-50 border rounded-lg text-xs font-bold flex justify-between items-center" onclick="loadUserMessages('${child.key}', '${u.nama}')">
                    ${u.nama} <i class="fas fa-chevron-right text-gray-400"></i>
                </div>`;
            });
        });

        let activeChatID = null;
        function selectUser(id, name) {
            activeChatID = id;
            $('#activeUserName').text(name);
            $('#chatRoom').removeClass('hidden');
            db.ref(`admin_inbox/${id}`).update({ unread: false });
            db.ref(`chats/${id}`).on('value', (snap) => {
                const display = document.getElementById('chatDisplay');
                display.innerHTML = "";
                snap.forEach(c => {
                    const m = c.val();
                    const style = m.sender === 'admin' ? 'self-end bg-slate-800 text-white' : 'self-start bg-white border';
                    display.innerHTML += `<div class="${style} msg-bubble shadow-sm">${m.text}</div>`;
                });
                display.scrollTop = display.scrollHeight;
            });
        }
        function closeChat() { $('#chatRoom').addClass('hidden'); }
        function sendReply() {
            const val = $('#adminInput').val().trim();
            if(!val || !activeChatID) return;
            db.ref(`chats/${activeChatID}`).push({ sender: 'admin', text: val, timestamp: Date.now() });
            db.ref(`admin_inbox/${activeChatID}`).update({ lastMsg: "Admin: "+val, timestamp: Date.now() });
            $('#adminInput').val('');
        }

        let activeDelUserID = null;
        function loadUserMessages(userId, userName) {
            activeDelUserID = userId;
            $('#messageManageArea').removeClass('hidden');
            $('#targetNameDel').text(`User: ${userName}`);
            db.ref(`chats/${userId}`).on('value', (snapshot) => {
                const msgList = document.getElementById('messageList');
                msgList.innerHTML = '';
                snapshot.forEach(child => {
                    const data = child.val();
                    msgList.innerHTML += `<div class="flex justify-between items-center p-2 border-b gap-2 text-[11px]">
                        <div class="flex-1"><span class="${data.sender === 'admin' ? 'tag-admin' : 'tag-user'}">${data.sender}</span> ${data.text}</div>
                        <button onclick="deleteSingleMessage('${child.key}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
            });
        }
        function deleteSingleMessage(msgId) { if(confirm('Hapus pesan?')) db.ref(`chats/${activeDelUserID}/${msgId}`).remove(); }
        function deleteAllChat() {
            if(confirm('Hapus seluruh chat user?')) {
                db.ref(`chats/${activeDelUserID}`).remove();
                db.ref(`admin_inbox/${activeDelUserID}`).remove();
                $('#messageManageArea').addClass('hidden');
            }
        }

        // --- 3. MODERASI POSTINGAN ---
        db.ref('testimoni_publik').on('value', (snapshot) => {
            const container = document.getElementById('containerPostingan');
            container.innerHTML = "";
            snapshot.forEach((child) => {
                const post = child.val();
                let balasanHtml = "";
                if (post.balasan) {
                    Object.keys(post.balasan).forEach((replyKey) => {
                        const r = post.balasan[replyKey];
                        balasanHtml += `
                            <div class="card-reply p-2 rounded mb-2 flex justify-between items-start">
                                <div class="text-[11px] leading-tight"><b class="text-slate-600">${r.nama}:</b> ${r.teks}</div>
                                <button onclick="hapusBalasan('${child.key}', '${replyKey}')" class="text-red-500 text-[10px] font-bold">HAPUS</button>
                            </div>`;
                    });
                }
                container.innerHTML += `
                    <div class="bg-white rounded-2xl p-4 shadow-sm border card-post">
                        <div class="flex justify-between items-start mb-2">
                            <div><h3 class="font-bold text-xs">${post.nama}</h3><p class="text-[9px] text-gray-400">${new Date(post.timestamp).toLocaleString('id-ID')}</p></div>
                            <button onclick="hapusPostingan('${child.key}')" class="text-red-600 text-[10px] font-bold">HAPUS POST</button>
                        </div>
                        <p class="text-xs text-slate-700 bg-slate-50 p-3 rounded-xl mb-3 border border-slate-100">${post.pesan}</p>
                        <div class="border-t pt-2">${balasanHtml || '<p class="text-[10px] text-gray-300 italic">Tidak ada balasan</p>'}</div>
                    </div>`;
            });
        });
        function hapusPostingan(key) { if(confirm("Hapus postingan?")) db.ref(`testimoni_publik/${key}`).remove(); }
        function hapusBalasan(postK, replyK) { if(confirm("Hapus balasan?")) db.ref(`testimoni_publik/${postK}/balasan/${replyK}`).remove(); }

        // --- 4. LAIN-LAIN (PARTNER, SPONSOR, VOUCHER) ---
        function savePartner() {
            const n = $('#pNama').val(), i = $('#pImage').val(), u = $('#pUrl').val();
            if(n && i) db.ref('partners_list').push({ nama: n, image: i, url: u }).then(() => { $('#pNama').val(''); $('#pImage').val(''); $('#pUrl').val(''); });
        }
        db.ref('partners_list').on('value', (snap) => {
            const container = document.getElementById('listPartner');
            container.innerHTML = '';
            snap.forEach(child => {
                const d = child.val();
                container.innerHTML += `<div class="bg-white p-3 rounded-xl border flex items-center justify-between">
                    <div class="flex items-center gap-3"><img src="${d.image}" class="w-10 h-10 rounded object-cover">
                    <div><div class="font-bold text-xs">${d.nama}</div></div></div>
                    <button onclick="hapusData('partners_list/${child.key}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        });

        function saveSponsor() {
            const n = $('#spName').val(), u = $('#spUrl').val(), i = $('#spImg').val();
            if(n && u && i) db.ref('sponsors_list').push({ nama: n, url: u, image: i }).then(() => { $('#spName').val(''); $('#spUrl').val(''); $('#spImg').val(''); });
        }
        db.ref('sponsors_list').on('value', snap => {
            const list = document.getElementById('sponsorList'); list.innerHTML = '';
            snap.forEach(c => {
                const d = c.val();
                list.innerHTML += `<div class="flex items-center gap-2 p-2 bg-white border rounded-lg text-xs">
                    <img src="${d.image}" class="w-6 h-6 rounded"><span class="flex-1 font-bold">${d.nama}</span>
                    <button onclick="hapusData('sponsors_list/${c.key}')" class="text-red-500"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        });

        function processesTopUpManual() {
            const u = $('#targetUsername').val().trim(), a = parseInt($('#topupAmount').val());
            if(!u || isNaN(a)) return;
            db.ref("users").orderByChild("Username").equalTo(u).once("value").then(snap => {
                if(snap.exists()) {
                    let key = Object.keys(snap.val())[0];
                    db.ref(`users/${key}/Saldo`).transaction(s => (s||0)+a);
                    alert("Saldo Berhasil Dikirim!");
                } else alert("User tidak ditemukan");
            });
        }

        function addSaldoVoucher() {
            const c = $('#sCode').val(), v = parseInt($('#sValue').val());
            if(c.length === 6 && v) db.ref('vouchers/'+c).set(v).then(() => alert("Voucher Aktif!"));
        }

        function monitor(path, listId, countId) {
            db.ref(path).on('value', snap => {
                const list = document.getElementById(listId);
                const count = document.getElementById(countId);
                let i = 0; if(list) list.innerHTML = '';
                snap.forEach(c => {
                    i++;
                    if(list) list.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 border-b text-[11px]">
                        <span>${c.val().kode || c.val().code || c.key}</span>
                        <button onclick="hapusData('${path}/${c.key}')" class="text-red-400"><i class="fas fa-times-circle"></i></button>
                    </div>`;
                });
                if(count) count.innerText = i;
            });
        }
        monitor('vouchers_tsel', 'listTsel', 'stokTsel');
        monitor('vouchers_axis', 'listAxis', 'stokAxis');
        monitor('vouchers', 'listWifi', 'stokWifi');
        monitor('Nitacell_vouchers', 'listNitacell', 'stokNitacell');
        monitor('vouchers', 'sList', null);

        function simpanVoucherPath(path, id) {
            const val = document.getElementById(id).value.trim();
            if(!val) return;
            val.split('\n').forEach(k => { if(k.trim()) db.ref(path).push({ kode: k.trim(), status: 'tersedia' }); });
            document.getElementById(id).value = ''; alert("Tersimpan!");
        }
        function simpanWifi() {
            const c = $('#vCodeWifi').val();
            if(c) db.ref('vouchers').push({ kode: c, status: 'tersedia' }); $('#vCodeWifi').val('');
        }
        function addNitacellVoucher() {
            const c = $('#pCodeNitacell').val();
            if(c) db.ref('Nitacell_vouchers').push({ code: c }); $('#pCodeNitacell').val('');
        }

        function postSebagaiAdmin() {
            const n = $('#adminNama').val(), p = $('#adminPesan').val(), t = $('#adminTanggal').val();
            if(!n || !p || !t) return alert("Isi Lengkap!");
            db.ref('testimoni_publik').push({ nama: n, pesan: p, timestamp: new Date(t).getTime(), userID: "ADMIN-RECOVERY" }).then(() => alert("Kenangan Dipulihkan!"));
        }

        function hapusData(path) { if(confirm("Hapus data?")) db.ref(path).remove(); }

        // --- SEARCH ENGINE ---
        $("#adminSearch").on("keyup", function() {
            const val = $(this).val().toLowerCase();
            $(".user-card").each(function() { $(this).toggle($(this).data("search").indexOf(val) > -1); });
        });

        $(document).ready(() => loadUsers());
    </script>
</body>
</html>
