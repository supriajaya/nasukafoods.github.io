<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pembayaran Gold</title>
  <link rel="manifest" href="/manifest.json" />
  <style>
    
  * { box-sizing: border-box; }
  
  body {
  font-family: 'Segoe UI', sans-serif;
  background: url('https://nasukafoods.site/gol.jpg') no-repeat center center fixed;
  background-size: cover;
  margin: 0;
  padding: 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #333;
}
  
  
  .produk-container {
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
    margin-bottom: 25px;
    scroll-snap-type: x mandatory;
  }
  .produk-card {
    display: inline-block;
    width: 160px;
    background: #ffffff;
    margin-right: 12px;
    padding: 12px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    scroll-snap-align: start;
    vertical-align: top;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .produk-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .produk-card img {
    width: 100%;
    height: 90px;
    object-fit: cover;
    border-radius: 6px;
  }
  .produk-card p {
    font-size: 15px;
    margin: 8px 0 0;
    font-weight: 600;
  }
  .produk-card .deskripsi {
    font-size: 13px;
    color: #666;
    margin-top: 5px;
    line-height: 1.3;
    height: 34px;
    overflow: hidden;
  }
  .struk {
    background: #fff;
    width: 100%;
    max-width: 420px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  }
  .struk h1 {
    text-align: center;
    font-size: 16px;
    color: #4CAF50;
    margin-bottom: 15px;
  }
  .struk p {
    margin: 6px 0;
    font-size: 15px;
  }
  .line {
    border-top: 1px solid #eee;
    margin: 20px 0;
  }
  .label {
    display: inline-block;
    width: 120px;
    font-weight: 500;
    color: #555;
  }
  input[type="text"], input[type="url"], select {
    width: 100%;
    margin-top: 6px;
    margin-bottom: 12px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 7px;
    font-family: inherit;
    font-size: 14px;
  }
  label {
    font-size: 14px;
    display: block;
    margin: 10px 0 4px;
    font-weight: 500;
  }
  button {
    margin-top: 20px;
    padding: 12px;
    width: 100%;
    background: #4CAF50;
    color: white;
    border: none;
    font-size: 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover {
    background: #43a047;
  }
  button:disabled {
    background: #bdbdbd;
    cursor: not-allowed;
  }
  #kwitansi, #customAlert {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #ffffff;
    z-index: 999;
    border-radius: 12px;
    padding: 22px;
    width: 90%;
    max-width: 340px;
    text-align: left;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    border: 2px solid #4CAF50;
  }
  #kwitansi p, #customAlert p {
    font-size: 14px;
    margin: 6px 0;
  }
  #customAlert button {
    margin-top: 12px;
    padding: 10px 18px;
    background: #4CAF50;
    border: none;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }
  #deskripsiOrder {
    font-size: 14px;
    color: #444;
    font-style: italic;
    margin-top: 6px;
  }
  @media (max-width: 480px) {
    .label { width: 100px; font-size: 14px; }
    .struk p, .struk h1 { font-size: 14px; }
    .produk-card { width: 130px; font-size: 13px; }
    .produk-card p { font-size: 13px; }
    button { font-size: 14px; }
  }
</style>
</head>
<body>

<div class="produk-container" id="produkContainer"></div>

<div class="struk">
  <h1>Layanan Premium</h1>
  <p><span class="label">Layanan</span><span id="layanan">-</span></p>
  <p><span class="label">Harga dalam gold</span><span id="harga">-</span></p>
  <div id="inputManualBox" style="margin-top:10px;"></div>
  <div id="deskripsiOrder"></div>
  <div class="line"></div>
  <p><span class="label">Nama</span><span id="nama">-</span></p>
  <p><span class="label">Telepon</span><span id="telepon">-</span></p>
  <p><span class="label">Username</span><span id="sosmed">-</span></p>
  <p><span class="label">Gold</span><span id="Gold">-</span></p>
  <div class="line"></div>
  <button id="btnBayar" style="display: none;" onclick="submitDigital()">Tukar Sekarang</button>
</div>

<div id="kwitansi">
  <p class="bold">âœ… PENUKARAN BERHASIL</p>
  <p>Layanan: <span id="kLayanan"></span></p>
  <p>Gold Yang Ditukar: <span id="kTotal"></span></p>
  <p>Nama: <span id="kNama"></span></p>
  <p>Telepon: <span id="kTelepon"></span></p>
  <p id="kGoldBox">Sisa Gold: <span id="kGold"></span></p>
  <p style="margin-top:10px; font-weight: bold;">Pesanan akan segera kami proses</p>
  <button onclick="location.href='penukaran-Gold.html'">Oke</button>
</div>

<div id="customAlert">
  <p id="customAlertMsg"></p>
  <button onclick="closeCustomAlert()">Tutup</button>
</div>

<script>
    
    document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnBayar").disabled = true;
});
    
    
    
  const URL_GAS = "https://script.google.com/macros/s/AKfycbwL9L9lI4GViVClRwcGN4dg2iyqhN_bPGnuwFL5v1Q_UMp5uZqdbQJmy9LIYwG81Dqy/exec";
  const username = localStorage.getItem("userID");
  let userGold = 0, userData = {};

  const produkList = [
    { name: "100.000 Followers", price: 5000, desc: "Tingkatkan jumlah followers anda untuk memperkuat value anda sebagai konten kreator. 100.000 Follower + Free 1.000 Follower", img: "https://nasukafoods.site/tiktokfoll.gif" },
    { name: "1.000 likes", price: 5, desc: "Tambahkan like ke video Anda agar makin viral.", img: "https://nasukafoods.site/tiktoklik.gif" },
    { name: "10.K Viewers", price: 1, desc: "Tampilkan jumlah viewers di video anda, buat konten anda makin Fyp.", img: "https://nasukafoods.site/sosial.gif" },
    { name: "100.K Viewers", price: 9, desc: "Sangat meningkatkan jumlah viewers pada video Anda, membuatnya sangat populer.", img: "https://nasukafoods.site/wingbiru.gif" }
  ];

  produkList.forEach(p => {
    const div = document.createElement("div");
    div.className = "produk-card";
    div.innerHTML = `<img src="${p.img}" alt="${p.name}"><p>${p.name}</p><p class="deskripsi">${p.desc}</p>`;
    div.onclick = () => pilihProduk(p);
    produkContainer.appendChild(div);
  });

  function pilihProduk(p) {
    const order = { name: p.name, price: p.price, desc: p.desc };
    localStorage.setItem("currentOrders", JSON.stringify(order));
    document.getElementById("layanan").textContent = order.name;
    document.getElementById("harga").textContent = formatRupiah(order.price);
    document.getElementById("deskripsiOrder").textContent = order.desc || "";
    const inputBox = document.getElementById("inputManualBox");

    if (order.name.toLowerCase().includes("viewer") || order.name.toLowerCase().includes("like")) {
      inputBox.innerHTML = '<label for="target">Link Video TikTok</label><input type="url" id="target" placeholder="https://www.tiktok.com/...">';
    } else {
      const usernameTikTok = extractTikTokUsername(userData["Tiktok"] || "");
      inputBox.innerHTML = '<label>Username TikTok</label><input type="text" id="target" value="' + usernameTikTok + '" readonly>';
    }

    document.getElementById("btnBayar").style.display = "block";
  }

  async function submitDigital() {
    const btn = document.getElementById("btnBayar");
    btn.disabled = true;
    btn.textContent = "Loading...";

    const order = JSON.parse(localStorage.getItem("currentOrders") || "{}");
    const price = parseInt(order.price || 0);
    const total = price;
    const target = document.getElementById("target").value.trim();

    if (!target) {
      showCustomAlert("Isi target/link TikTok terlebih dahulu!");
      btn.disabled = false;
      btn.textContent = "Tukar Sekarang";
      return;
    }

    document.getElementById("kLayanan").textContent = order.name;
    document.getElementById("kTotal").textContent = formatRupiah(total);
    document.getElementById("kNama").textContent = userData.Nama || "-";
    document.getElementById("kTelepon").textContent = userData.Telepon || "-";
    document.getElementById("kGoldBox").style.display = "block";
    document.getElementById("kGold").textContent = formatRupiah(userGold - total);
    document.getElementById("kwitansi").style.display = "block";

    


const formData = new URLSearchParams();
formData.append("action", "submitPesanan");
formData.append("id", username || "");
formData.append("nama", userData.Nama || "-");
formData.append("produk", order.name || "");
formData.append("nominal", price);
formData.append("metode", "Gold");
formData.append("foto", target);










    try {
      const res = await fetch(URL_GAS, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData
      });

      const resultText = await res.text();
      let result;
      try {
        result = JSON.parse(resultText);
      } catch (e) {
        showCustomAlert("Error parsing response: " + resultText);
        btn.disabled = false;
        btn.textContent = "Beli Sekarang";
        return;
      }

      if (result.status === "Success") {
        showCustomAlert("Order berhasil, biaya layanan " + formatRupiah(result.Gold_terbaru));
        localStorage.removeItem("currentOrders");
        userGold = parseFloat(result.Gold_terbaru || 0);
        document.getElementById("").textContent = formatRupiah(userGold);
        document.getElementById("kGold").textContent = formatRupiah(userGold);
        btn.style.display = "none";
      } else {
        showCustomAlert("Error: " + result.message);
        btn.disabled = false;
        btn.textContent = "Tukar Sekarang";
      }
    } catch (err) {
      showCustomAlert("Koneksi gagal: " + err.message);
      btn.disabled = false;
      btn.textContent = "Tukar Sekarang";
    }
  }

  if (username) {
  
  
    fetch(`${URL_GAS}?action=getProfil&id=${encodeURIComponent(username)}`)
  .then(res => res.json())
  .then(data => {
    userData = data;
    document.getElementById("nama").textContent = data.Nama || "-";
    document.getElementById("telepon").textContent = data.Telepon || "-";
    document.getElementById("sosmed").textContent = data["Tiktok"]?.trim() || "-";
    userGold = parseInt(data.Gold || 0);
    document.getElementById("Gold").textContent = formatRupiah(userGold);

 
    document.getElementById("btnBayar").disabled = false;
  })
  .catch(error => {
    showCustomAlert("Gagal memuat data pengguna.");
  });
      
      
      
  }







  function extractTikTokUsername(sosmed) {
    if (!sosmed) return "";
    if (sosmed.includes("tiktok.com")) {
      const match = sosmed.match(/tiktok\.com\/@([\w\d._]+)/);
      return match ? "@" + match[1] : "";
    }
    return sosmed.startsWith("@") ? sosmed : "@" + sosmed;
  }

  function showCustomAlert(msg) {
    document.getElementById("customAlertMsg").textContent = msg;
    document.getElementById("customAlert").style.display = "block";
  }

  function closeCustomAlert() {
    document.getElementById("customAlert").style.display = "none";
  }

  function formatRupiah(angka) {
    if (!angka || isNaN(angka)) return "";
    return '' + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
</script>

</body>
</html>
