<!DOCTYPE html>
<html>
<head>
    <title>Toko Online Saya</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f4f4; color: #333; line-height: 1.6; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #fff;
            border-bottom: 1px solid #eee;
        }
        .header h1 {
            margin: 0;
            color: #4CAF50;
            font-size: 1.8em;
        }
        .welcome-message {
            font-size: 1em;
            font-weight: bold;
            color: #555;
        }
        .container {
            width: 100%;
            max-width: 960px;
            margin: auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }
        nav {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        nav button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            flex-grow: 1;
            max-width: 150px;
            transition: background-color 0.3s ease;
        }
        nav button:hover { background-color: #0056b3; }
        .section { display: none; padding-top: 20px; }
        .section.active { display: block; }
        h2 { text-align: center; color: #555; margin-bottom: 25px; font-size: 1.8em; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.95em; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            max-width: 100%;
        }
        .form-group.hidden-for-member {
            display: none; /* Default hidden */
        }
        .form-group.member-readonly {
            display: none; /* Hide entirely for members */
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            width: 100%;
            max-width: 250px;
            margin: 20px auto 0;
            transition: background-color 0.3s ease;
            box-sizing: border-box;
        }
        .button:hover { background-color: #45a049; }
        .message { margin-top: 20px; padding: 15px; border-radius: 5px; text-align: center; font-weight: bold; font-size: 0.95em; }
        .message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .product-item {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }
        .product-item:hover { transform: translateY(-5px); }
        .product-item h3 { color: #333; margin-bottom: 8px; font-size: 1.15em; }
        .product-item p { color: #666; font-size: 0.9em; margin-bottom: 12px; }
        .product-item .product-price { font-size: 1.1em; font-weight: bold; color: #007bff; }
        .buy-now-button {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            width: auto;
            display: inline-block;
        }
        .buy-now-button:hover { background-color: #218838; }
        .profile-data p, .order-item p { margin-bottom: 8px; line-height: 1.5; font-size: 0.95em; }
        .profile-data strong, .order-item strong { display: inline-block; width: 120px; color: #555; }
        .order-item { border: 1px solid #e9ecef; background-color: #fefefe; padding: 12px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .order-detail-summary {
            background-color: #e9f7ef;
            border: 1px solid #cce8d6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .order-detail-summary p {
            margin-bottom: 8px;
        }
        .order-detail-summary strong {
            display: inline-block;
            width: 150px;
            color: #333;
        }

        /* Styles for hiding specific form groups */
        .form-group.hidden-field {
            display: none;
        }

        /* Media Queries for smaller screens */
        @media (max-width: 768px) {
            .header { padding: 10px 15px; }
            .header h1 { font-size: 1.5em; }
            .welcome-message { font-size: 0.9em; }
            .container {
                margin: 10px;
                padding: 15px;
            }
            nav button {
                padding: 8px 12px;
                font-size: 14px;
                max-width: 120px;
            }
            h2 { font-size: 1.6em; margin-bottom: 20px; }
            .button {
                padding: 10px 15px;
                font-size: 15px;
            }
            .product-list {
                grid-template-columns: 1fr;
            }
            .product-item { padding: 15px; }
            .product-item h3 { font-size: 1.1em; }
            .product-item p { font-size: 0.85em; }
            .product-item .product-price { font-size: 1.05em; }
            .buy-now-button { padding: 8px 15px; font-size: 14px; }
            .profile-data strong, .order-item strong { width: 100px; }
            .order-detail-summary strong { width: 120px; }
        }

        @media (max-width: 480px) {
            .header { flex-direction: column; align-items: flex-start; padding: 10px; }
            .header h1 { margin-bottom: 5px; }
            .welcome-message { margin-top: 5px; }
            nav button {
                flex-basis: 45%;
                max-width: none;
            }
            .container { padding: 10px; }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.4em; }
            .form-group label { font-size: 0.9em; }
            .form-group input, .form-group textarea, .form-group select { font-size: 14px; padding: 8px; }
            .message { font-size: 0.85em; padding: 10px; }
            .buy-now-button { font-size: 13px; padding: 7px 12px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="margin-bottom: 0;">Toko Online</h1>
        <div id="welcomeMessage" class="welcome-message">Hai, Tamu</div>
    </div>
    <div class="container">
        <nav>
            <button id="navHome" onclick="showSection('home')">Beranda</button>
            <button id="navLogin" onclick="showSection('login')">Login</button>
            <button id="navSignup" onclick="showSection('signup')">Daftar</button>
            <button id="navOrder" onclick="showSection('order')">Order</button>
            <button id="navProfile" onclick="showSection('profile')" style="display:none;">Profil</button>
            <button id="navOrderHistory" onclick="showSection('orderHistory')" style="display:none;">Riwayat Pesanan</button>
            <button id="navDeposit" onclick="showSection('deposit')" style="display:none;">Deposit</button>
            <button id="navLogout" onclick="logout()" style="display:none;">Logout</button>
        </nav>

        <div id="homeSection" class="section active">
            <h2>Produk Kami</h2>
            <div class="product-list">
                <div class="product-item">
                    <h3>Paket Internet Cepat</h3>
                    <p>Kuota 100 GB, kecepatan hingga 50 Mbps. Ideal untuk streaming dan gaming.</p>
                    <p>Harga: <span class="product-price">100000</span></p>
                    <button class="button buy-now-button" data-product-name="Paket Internet Cepat" data-product-price="100000">Beli Sekarang</button>
                </div>
                <div class="product-item">
                    <h3>Voucher Game Premium</h3>
                    <p>Voucher untuk game populer, dapatkan item eksklusif.</p>
                    <p>Harga: <span class="product-price">150000</span></p>
                    <button class="button buy-now-button" data-product-name="Voucher Game Premium" data-product-price="150000">Beli Sekarang</button>
                </div>
                <div class="product-item">
                    <h3>Langganan Streaming Film</h3>
                    <p>Akses tak terbatas ke ribuan film dan serial TV.</p>
                    <p>Harga: <span class="product-price">80000</span></p>
                    <button class="button buy-now-button" data-product-name="Langganan Streaming Film" data-product-price="80000">Beli Sekarang</button>
                </div>
                <div class="product-item">
                    <h3>Pulsa Elektrik All Operator</h3>
                    <p>Isi ulang pulsa instan untuk semua operator seluler.</p>
                    <p>Harga: <span class="product-price">50000</span></p>
                    <button class="button buy-now-button" data-product-name="Pulsa Elektrik All Operator" data-product-price="50000">Beli Sekarang</button>
                </div>
            </div>
        </div>

        <div id="loginSection" class="section">
            <h2>Login ke Akun Anda</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginNomorHP">Nomor HP:</label>
                    <input type="text" id="loginNomorHP" name="nomorHP" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" name="password" required>
                </div>
                <button type="submit" class="button">Login</button>
            </form>
            <div id="loginMessage" class="message" style="display:none;"></div>
        </div>

        <div id="signupSection" class="section">
            <h2>Daftar Akun Baru</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label for="namaLengkap">Nama Lengkap:</label>
                    <input type="text" id="namaLengkap" name="namaLengkap" required>
                </div>
                <div class="form-group">
                    <label for="alamatLengkap">Alamat Lengkap:</label>
                    <textarea id="alamatLengkap" name="alamatLengkap" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="nomorHP">Nomor HP:</label>
                    <input type="text" id="nomorHP" name="nomorHP" required>
                </div>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="tentangSaya">Tentang Saya (Opsional):</label>
                    <textarea id="tentangSaya" name="tentangSaya" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="button">Daftar</button>
            </form>
            <div id="signupMessage" class="message" style="display:none;"></div>
        </div>

        <div id="profileSection" class="section">
            <h2>Profil Pengguna</h2>
            <div id="profileData" class="profile-data">
                <p><strong>Customers ID:</strong> <span id="profileCustID"></span></p>
                <p><strong>Nama Lengkap:</strong> <span id="profileNamaLengkap"></span></p>
                <p><strong>Alamat Lengkap:</strong> <span id="profileAlamatLengkap"></span></p>
                <p><strong>Nomor HP:</strong> <span id="profileNomorHP"></span></p>
                <p><strong>Username:</strong> <span id="profileUsername"></span></p>
                <p><strong>Tentang Saya:</strong> <span id="profileTentangSaya"></span></p>
                <p><strong>Saldo:</strong> <span id="profileSaldo"></span></p>
                <p><strong>Tanggal Daftar:</strong> <span id="profileTanggalDaftar"></span></p>
                <button id="editProfileButton" class="button" style="display:none;">Edit Profil</button>
            </div>
            <div id="profileMessage" class="message" style="display:none;"></div>
        </div>

        <div id="editProfileSection" class="section">
            <h2>Edit Profil</h2>
            <form id="editProfileForm">
                <input type="hidden" id="editProfileCustomerID" name="customerID">
                <div class="form-group">
                    <label for="editNamaLengkap">Nama Lengkap:</label>
                    <input type="text" id="editNamaLengkap" name="namaLengkap" required>
                </div>
                <div class="form-group">
                    <label for="editAlamatLengkap">Alamat Lengkap:</label>
                    <textarea id="editAlamatLengkap" name="alamatLengkap" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="editNomorHP">Nomor HP:</label>
                    <input type="text" id="editNomorHP" name="nomorHP" required>
                </div>
                <div class="form-group">
                    <label for="editPassword">Password (kosongkan jika tidak ingin diubah):</label>
                    <input type="password" id="editPassword" name="password">
                </div>
                <div class="form-group">
                    <label for="editTentangSaya">Tentang Saya (Opsional):</label>
                    <textarea id="editTentangSaya" name="tentangSaya" rows="3"></textarea>
                </div>
                <button type="submit" class="button">Simpan Perubahan</button>
            </form>
            <div id="editProfileMessage" class="message" style="display:none;"></div>
        </div>

        <div id="orderHistorySection" class="section">
            <h2>Riwayat Pesanan</h2>
            <div id="orderHistoryList">
                <p id="noOrderHistoryMessage" style="display:none;">Tidak ada riwayat pesanan.</p>
            </div>
            <div id="orderHistoryMessage" class="message" style="display:none;"></div>
        </div>

        <div id="depositSection" class="section">
            <h2>Deposit Saldo</h2>
            <form id="depositForm">
                <div class="form-group">
                    <label for="depNamaPelanggan">Nama Pelanggan:</label>
                    <input type="text" id="depNamaPelanggan" name="namaPelanggan" required>
                </div>
                <div class="form-group">
                    <label for="depNomorHP">Nomor HP:</label>
                    <input type="text" id="depNomorHP" name="nomorHP" required>
                </div>
                <div class="form-group">
                    <label for="jumlahDeposit">Jumlah Deposit:</label>
                    <input type="number" id="jumlahDeposit" name="jumlahDeposit" min="1" required>
                </div>
                <div class="form-group">
                    <label for="metodePembayaranDep">Metode Pembayaran:</label>
                    <select id="metodePembayaranDep" name="metodePembayaran" required>
                        <option value="">Pilih Metode</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="E-Wallet">E-Wallet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="urlBuktiTransfer">URL Bukti Transfer:</label>
                    <input type="url" id="urlBuktiTransfer" name="urlBuktiTransfer" required>
                </div>
                <button type="submit" class="button">Ajukan Deposit</button>
            </form>
            <div id="depositMessage" class="message" style="display:none;"></div>
        </div>

        <div id="orderSection" class="section">
            <h2>Detail Pesanan</h2>
            <div id="orderDetailSummary" class="order-detail-summary" style="display:none;">
                <p><strong>Tipe Pelanggan:</strong> <span id="summaryTipePelanggan"></span></p>
                <p><strong>Nama Lengkap:</strong> <span id="summaryNamaLengkap"></span></p>
                <p><strong>Nomor HP:</strong> <span id="summaryNomorHP"></span></p>
                <p><strong>Alamat Pengiriman:</strong> <span id="summaryAlamat"></span></p>
                <p><strong>Username:</strong> <span id="summaryUsername"></span></p>
                <p><strong>Produk:</strong> <span id="summaryProduk"></span></p>
                <p><strong>Kuantitas:</strong> <span id="summaryKuantitas"></span></p>
                <p><strong>Total Harga:</strong> <span id="summaryTotalHarga"></span></p>
                <p><strong>Sisa Saldo:</strong> <span id="summarySisaSaldo"></span></p>
                <p><strong>Catatan:</strong> <span id="summaryCatatan"></span></p>
                <p><strong>Metode Pembayaran:</strong> <span id="summaryMetodePembayaran"></span></p>
                <p><strong>Status Pesanan:</strong> <span id="summaryStatusPesanan"></span></p>
                <p><strong>Bonus:</strong> <span id="summaryBonus"></span></p>
            </div>
            <form id="orderForm">
                <div class="form-group hidden-for-member" id="formGroupNomorHP">
                    <label for="ordNomorHP">Nomor HP Pelanggan:</label>
                    <input type="text" id="ordNomorHP" name="nomorHP">
                </div>
                <div class="form-group hidden-for-member" id="formGroupAlamat">
                    <label for="ordAlamat">Alamat Pengiriman:</label>
                    <textarea id="ordAlamat" name="alamat" rows="3"></textarea>
                </div>
                <div class="form-group hidden-for-member" id="formGroupUsername">
                    <label for="ordUsername">Username (Opsional):</label>
                    <input type="text" id="ordUsername" name="username">
                </div>
                <div class="form-group member-readonly" id="formGroupProduk">
                    <label for="produk">Produk:</label>
                    <input type="text" id="produk" name="produk" required>
                </div>
                <div class="form-group member-readonly" id="formGroupKuantitas">
                    <label for="kuantitas">Kuantitas:</label>
                    <input type="number" id="kuantitas" name="kuantitas" min="1" value="1" required>
                </div>
                <div class="form-group member-readonly" id="formGroupTotalHarga">
                    <label for="totalHarga">Total Harga:</label>
                    <input type="number" id="totalHarga" name="totalHarga" min="1" required>
                </div>
                <div class="form-group">
                    <label for="catatan">Catatan (Opsional):</label>
                    <textarea id="catatan" name="catatan" rows="3"></textarea>
                </div>
                <div class="form-group" id="formGroupMetodePembayaranOrd">
                    <label for="metodePembayaranOrd">Metode Pembayaran:</label>
                    <select id="metodePembayaranOrd" name="metodePembayaran" required>
                        <option value="">Pilih Metode</option>
                        <option value="Transfer Bank">Transfer Bank</option>
                        <option value="E-Wallet">E-Wallet</option>
                        <option value="Saldo Akun">Saldo Akun</option>
                        <option value="Cash on Delivery">Cash on Delivery</option>
                    </select>
                </div>
                <div class="form-group hidden-field" id="formGroupStatusPesanan">
                    <label for="statusPesanan">Status Pesanan:</label>
                    <select id="statusPesanan" name="statusPesanan">
                        <option value="Pending">Pending</option>
                        <option value="Diproses">Diproses</option>
                        <option value="Dikirim">Dikirim</option>
                        <option value="Selesai">Selesai</option>
                        <option value="Dibatalkan">Dibatalkan</option>
                    </select>
                </div>
                <div class="form-group hidden-field" id="formGroupBonus">
                    <label for="bonus">Bonus (Opsional):</label>
                    <input type="text" id="bonus" name="bonus">
                </div>
                <button type="submit" class="button">Bayar Sekarang</button>
            </form>
            <div id="orderMessage" class="message" style="display:none;"></div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyN2d6hEb_MR2fqXKFZXVoWZNtaqA5trsMvLEwt5X0Zor9GoQKAaA7Ufo2rahMtneftqQ/exec';
        let loggedInUser = null;

        function saveUserToLocalStorage(userData) {
            localStorage.setItem('loggedInUser', JSON.stringify(userData));
            loggedInUser = userData;
            updateWelcomeMessage();
        }

        function loadUserFromLocalStorage() {
            const userDataString = localStorage.getItem('loggedInUser');
            if (userDataString) {
                loggedInUser = JSON.parse(userDataString);
                updateWelcomeMessage();
                return true;
            }
            return false;
        }

        function removeUserFromLocalStorage() {
            localStorage.removeItem('loggedInUser');
            loggedInUser = null;
            updateWelcomeMessage();
        }

        function updateWelcomeMessage() {
            const welcomeMessageDiv = document.getElementById('welcomeMessage');
            if (loggedInUser && loggedInUser['Nama Lengkap']) {
                welcomeMessageDiv.innerText = `Hai, ${loggedInUser['Nama Lengkap']}`;
            } else {
                welcomeMessageDiv.innerText = 'Hai, Tamu';
            }
        }

        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId + 'Section').classList.add('active');

            if (sectionId === 'profile') {
                if (loggedInUser) {
                    displayProfile();
                    document.getElementById('editProfileButton').style.display = 'block';
                } else {
                    document.getElementById('profileMessage').classList.add('error');
                    document.getElementById('profileMessage').innerText = 'Anda harus login untuk melihat profil.';
                    document.getElementById('profileMessage').style.display = 'block';
                    document.getElementById('profileData').style.display = 'none';
                    document.getElementById('editProfileButton').style.display = 'none';
                }
            } else if (sectionId === 'editProfile') {
                if (loggedInUser) {
                    populateEditProfileForm();
                } else {
                    showSection('login');
                }
            } else if (sectionId === 'orderHistory') {
                if (loggedInUser) {
                    loadOrderHistory(loggedInUser['Nomor HP']);
                } else {
                    document.getElementById('orderHistoryMessage').classList.add('error');
                    document.getElementById('orderHistoryMessage').innerText = 'Anda harus login untuk melihat riwayat pesanan.';
                    document.getElementById('orderHistoryMessage').style.display = 'block';
                    document.getElementById('orderHistoryList').innerHTML = '';
                    document.getElementById('noOrderHistoryMessage').style.display = 'none';
                }
            } else if (sectionId === 'order') {
                updateOrderFormVisibility();
            }
        }

        function updateOrderFormVisibility() {
            const isMember = loggedInUser !== null;

            // Guest-specific fields (Nomor HP, Alamat, Username)
            document.getElementById('formGroupNomorHP').style.display = isMember ? 'none' : 'block';
            document.getElementById('formGroupAlamat').style.display = isMember ? 'none' : 'block';
            document.getElementById('formGroupUsername').style.display = isMember ? 'none' : 'block';

            if (isMember) {
                document.getElementById('ordNomorHP').removeAttribute('required');
                document.getElementById('ordAlamat').removeAttribute('required');
                document.getElementById('ordUsername').removeAttribute('required');
            } else {
                document.getElementById('ordNomorHP').setAttribute('required', 'required');
                document.getElementById('ordAlamat').setAttribute('required', 'required');
                document.getElementById('ordUsername').removeAttribute('required'); // Username is optional for guest
            }

            // Fields to be entirely hidden for members
            const memberHiddenFields = [
                'formGroupProduk', 'formGroupKuantitas', 'formGroupTotalHarga',
                'formGroupStatusPesanan', 'formGroupBonus'
            ];
            
            memberHiddenFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const inputElement = field.querySelector('input, textarea, select');
                
                if (isMember) {
                    field.style.display = 'none'; // Hide entirely for members
                    if (inputElement) {
                        inputElement.readOnly = true;
                        inputElement.disabled = true; // Disable to prevent any interaction/submission
                    }
                } else {
                    // Restore visibility for guests (if they are not hidden-field by default)
                    if (fieldId === 'formGroupStatusPesanan' || fieldId === 'formGroupBonus') {
                        field.style.display = 'none'; // Keep these hidden for guests too
                    } else {
                        field.style.display = 'block'; // Make visible for guests
                    }
                    if (inputElement) {
                        inputElement.readOnly = false;
                        inputElement.disabled = false;
                    }
                }
            });

            // Summary section visibility
            document.getElementById('orderDetailSummary').style.display = isMember ? 'block' : 'none';

            // Update summary details based on login status
            if (isMember) {
                document.getElementById('summaryTipePelanggan').innerText = 'Member';
                document.getElementById('summaryNamaLengkap').innerText = loggedInUser['Nama Lengkap'] || '-';
                document.getElementById('summaryNomorHP').innerText = loggedInUser['Nomor HP'] || '-';
                document.getElementById('summaryAlamat').innerText = loggedInUser['Alamat Lengkap'] || '-';
                document.getElementById('summaryUsername').innerText = loggedInUser['Username'] || '-';
                document.getElementById('summarySisaSaldo').innerText = loggedInUser['Saldo'] !== undefined ? `Rp ${loggedInUser['Saldo'].toLocaleString('id-ID')}` : '-';
            } else {
                document.getElementById('summarySisaSaldo').innerText = 'N/A'; // Guests don't have account balance
            }
        }

        async function submitForm(formId, actionType, messageId) {
            const form = document.getElementById(formId);
            const messageDiv = document.getElementById(messageId);
            const formData = new FormData(form);
            formData.append('action', actionType);

            messageDiv.style.display = 'none';
            messageDiv.className = 'message';

            if (actionType === 'order') {
                const metodePembayaran = formData.get('metodePembayaran');
                
                // For members, these fields are hidden, but their values must be included in formData
                // We ensure they have values when the "Beli Sekarang" button is clicked
                if (loggedInUser) {
                    formData.set('produk', document.getElementById('produk').value);
                    formData.set('kuantitas', document.getElementById('kuantitas').value);
                    formData.set('totalHarga', document.getElementById('totalHarga').value);
                    formData.set('statusPesanan', document.getElementById('statusPesanan').value);
                    formData.set('bonus', document.getElementById('bonus').value);

                    formData.set('tipePelanggan', 'Member');
                    formData.set('nomorHP', loggedInUser['Nomor HP']);
                    formData.set('alamat', loggedInUser['Alamat Lengkap'] || '');
                    formData.set('username', loggedInUser['Username'] || '');
                } else {
                    formData.set('tipePelanggan', 'Tamu');
                }

                if (metodePembayaran === 'Saldo Akun' && !loggedInUser) {
                    messageDiv.classList.add('error');
                    messageDiv.innerText = 'Anda harus login untuk membayar dengan Saldo Akun.';
                    messageDiv.style.display = 'block';
                    return;
                }
            }

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success') {
                    messageDiv.classList.add('success');
                    messageDiv.innerText = result.message;

                    if (actionType === 'login') {
                        saveUserToLocalStorage(result.data);
                        updateNavigationButtons(true);
                        showSection('home');
                    } else if (actionType === 'signup') {
                        showSection('login');
                    } else if (actionType === 'updateProfile' || (actionType === 'order' && formData.get('metodePembayaran') === 'Saldo Akun')) {
                        const refreshFormData = new FormData();
                        refreshFormData.append('action', 'refreshUserData');
                        refreshFormData.append('customerID', loggedInUser['Customers ID']);

                        const refreshResponse = await fetch(GAS_URL, {
                            method: 'POST',
                            body: refreshFormData
                        });
                        const refreshResult = await refreshResponse.json();

                        if (refreshResult.status === 'success') {
                            saveUserToLocalStorage(refreshResult.data);
                            displayProfile();
                            showSection('profile');
                        } else {
                            console.error('Gagal memperbarui data user setelah aksi:', refreshResult.message);
                            alert('Profil berhasil diperbarui, namun ada masalah dalam memuat data terbaru. Silakan refresh halaman.');
                        }
                    }
                    form.reset();
                    // Clear summary fields after successful order
                    document.getElementById('summaryProduk').innerText = '';
                    document.getElementById('summaryKuantitas').innerText = '';
                    document.getElementById('summaryTotalHarga').innerText = '';
                    document.getElementById('summaryCatatan').innerText = '';
                    document.getElementById('summaryMetodePembayaran').innerText = '';
                    document.getElementById('summaryStatusPesanan').innerText = '';
                    document.getElementById('summaryBonus').innerText = '';
                    document.getElementById('metodePembayaranOrd').value = ''; // Reset select
                } else {
                    messageDiv.classList.add('error');
                    messageDiv.innerText = result.message;
                }
                messageDiv.style.display = 'block';
            } catch (error) {
                messageDiv.classList.add('error');
                messageDiv.innerText = 'Terjadi kesalahan: ' + error.message;
                messageDiv.style.display = 'block';
            }
        }

        async function loadOrderHistory(nomorHP) {
            const orderHistoryListDiv = document.getElementById('orderHistoryList');
            const orderHistoryMessageDiv = document.getElementById('orderHistoryMessage');
            const noOrderHistoryMessage = document.getElementById('noOrderHistoryMessage');

            orderHistoryListDiv.innerHTML = '';
            orderHistoryMessageDiv.style.display = 'none';
            noOrderHistoryMessage.style.display = 'none';

            const formData = new FormData();
            formData.append('action', 'getOrderHistory');
            formData.append('nomorHP', nomorHP);

            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'success' && result.data.length > 0) {
                    result.data.forEach(order => {
                        const orderItemDiv = document.createElement('div');
                        orderItemDiv.classList.add('order-item');
                        orderItemDiv.innerHTML = `
                            <p><strong>Tanggal:</strong> ${order['Tanggal'] || '-'}</p>
                            <p><strong>Tipe Pelanggan:</strong> ${order['Tipe Pelanggan'] || '-'}</p>
                            <p><strong>Nomor HP:</strong> ${order['Nomor HP'] || '-'}</p>
                            <p><strong>Alamat:</strong> ${order['Alamat'] || '-'}</p>
                            <p><strong>Username:</strong> ${order['Username'] || '-'}</p>
                            <p><strong>Produk:</strong> ${order['Produk'] || '-'}</p>
                            <p><strong>Kuantitas:</strong> ${order['Kuantitas'] !== undefined ? order['Kuantitas'] : '-'}</p>
                            <p><strong>Total Harga:</strong> Rp ${order['Total Harga'] !== undefined ? order['Total Harga'].toLocaleString('id-ID') : '-'}</p>
                            <p><strong>Catatan:</strong> ${order['Catatan'] || '-'}</p>
                            <p><strong>Metode Pembayaran:</strong> ${order['Metode Pembayaran'] || '-'}</p>
                            <p><strong>Status Pesanan:</strong> ${order['Status Pesanan'] || '-'}</p>
                            <p><strong>Bonus:</strong> ${order['Bonus'] || '-'}</p>
                        `;
                        orderHistoryListDiv.appendChild(orderItemDiv);
                    });
                } else if (result.status === 'success' && result.data.length === 0) {
                    noOrderHistoryMessage.style.display = 'block';
                } else {
                    orderHistoryMessageDiv.classList.add('error');
                    orderHistoryMessageDiv.innerText = result.message || 'Gagal memuat riwayat pesanan.';
                    orderHistoryMessageDiv.style.display = 'block';
                }
            } catch (error) {
                orderHistoryMessageDiv.classList.add('error');
                orderHistoryMessageDiv.innerText = 'Terjadi kesalahan saat memuat riwayat pesanan: ' + error.message;
                orderHistoryMessageDiv.style.display = 'block';
            }
        }

        function displayProfile() {
            if (loggedInUser) {
                document.getElementById('profileCustID').innerText = loggedInUser['Customers ID'] || '-';
                document.getElementById('profileNamaLengkap').innerText = loggedInUser['Nama Lengkap'] || '-';
                document.getElementById('profileAlamatLengkap').innerText = loggedInUser['Alamat Lengkap'] || '-';
                document.getElementById('profileNomorHP').innerText = loggedInUser['Nomor HP'] || '-';
                document.getElementById('profileUsername').innerText = loggedInUser['Username'] || '-';
                document.getElementById('profileTentangSaya').innerText = loggedInUser['Tentang Saya'] || '-';
                document.getElementById('profileSaldo').innerText = loggedInUser['Saldo'] !== undefined ? `Rp ${loggedInUser['Saldo'].toLocaleString('id-ID')}` : '-';
                document.getElementById('profileTanggalDaftar').innerText = loggedInUser['Tanggal Daftar'] || '-';
                document.getElementById('profileData').style.display = 'block';
                document.getElementById('profileMessage').style.display = 'none';
            } else {
                document.getElementById('profileMessage').classList.add('error');
                document.getElementById('profileMessage').innerText = 'Anda belum login.';
                document.getElementById('profileMessage').style.display = 'block';
                document.getElementById('profileData').style.display = 'none';
            }
        }

        function populateEditProfileForm() {
            if (loggedInUser) {
                document.getElementById('editProfileCustomerID').value = loggedInUser['Customers ID'];
                document.getElementById('editNamaLengkap').value = loggedInUser['Nama Lengkap'] || '';
                document.getElementById('editAlamatLengkap').value = loggedInUser['Alamat Lengkap'] || '';
                document.getElementById('editNomorHP').value = loggedInUser['Nomor HP'] || '';
                document.getElementById('editTentangSaya').value = loggedInUser['Tentang Saya'] || '';
                document.getElementById('editPassword').value = '';
            }
        }

        function updateNavigationButtons(isLoggedIn) {
            document.getElementById('navLogin').style.display = isLoggedIn ? 'none' : 'inline-block';
            document.getElementById('navSignup').style.display = isLoggedIn ? 'none' : 'inline-block';
            document.getElementById('navOrder').style.display = 'inline-block';
            
            document.getElementById('navProfile').style.display = isLoggedIn ? 'inline-block' : 'none';
            document.getElementById('navOrderHistory').style.display = isLoggedIn ? 'inline-block' : 'none';
            document.getElementById('navDeposit').style.display = isLoggedIn ? 'inline-block' : 'none';
            document.getElementById('navLogout').style.display = isLoggedIn ? 'inline-block' : 'none';
        }

        function logout() {
            removeUserFromLocalStorage();
            alert('Anda telah logout.');
            updateNavigationButtons(false);
            showSection('home');
        }

        document.getElementById('signupForm').addEventListener('submit', function(event) {
            event.preventDefault();
            submitForm('signupForm', 'signup', 'signupMessage');
        });

        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            submitForm('loginForm', 'login', 'loginMessage');
        });

        document.getElementById('depositForm').addEventListener('submit', function(event) {
            event.preventDefault();
            submitForm('depositForm', 'deposit', 'depositMessage');
        });

        document.getElementById('orderForm').addEventListener('submit', function(event) {
            event.preventDefault();
            submitForm('orderForm', 'order', 'orderMessage');
        });

        document.getElementById('editProfileForm').addEventListener('submit', function(event) {
            event.preventDefault();
            submitForm('editProfileForm', 'updateProfile', 'editProfileMessage');
        });

        document.getElementById('editProfileButton').addEventListener('click', function() {
            showSection('editProfile');
        });

        document.querySelectorAll('.buy-now-button').forEach(button => {
            button.addEventListener('click', function() {
                const productName = this.dataset.productName;
                const productPrice = this.dataset.productPrice;

                document.getElementById('produk').value = productName;
                document.getElementById('kuantitas').value = 1;
                document.getElementById('totalHarga').value = productPrice;
                document.getElementById('catatan').value = `Pembelian: ${productName}`;
                
                // These are hidden fields, set their default value here
                document.getElementById('statusPesanan').value = 'Pending';
                document.getElementById('bonus').value = '';
                document.getElementById('metodePembayaranOrd').value = ''; // Reset metode pembayaran

                document.getElementById('summaryProduk').innerText = productName;
                document.getElementById('summaryKuantitas').innerText = 1;
                document.getElementById('summaryTotalHarga').innerText = `Rp ${parseFloat(productPrice).toLocaleString('id-ID')}`;
                document.getElementById('summaryCatatan').innerText = `Pembelian: ${productName}`;
                document.getElementById('summaryMetodePembayaran').innerText = 'Pilih Metode'; // Initial state
                document.getElementById('summaryStatusPesanan').innerText = 'Pending';
                document.getElementById('summaryBonus').innerText = '-';

                if (loggedInUser) {
                    document.getElementById('ordNomorHP').value = loggedInUser['Nomor HP'];
                    document.getElementById('ordAlamat').value = loggedInUser['Alamat Lengkap'] || '';
                    document.getElementById('ordUsername').value = loggedInUser['Username'] || '';

                    document.getElementById('summaryTipePelanggan').innerText = 'Member';
                    document.getElementById('summaryNamaLengkap').innerText = loggedInUser['Nama Lengkap'] || '-';
                    document.getElementById('summaryNomorHP').innerText = loggedInUser['Nomor HP'] || '-';
                    document.getElementById('summaryAlamat').innerText = loggedInUser['Alamat Lengkap'] || '-';
                    document.getElementById('summaryUsername').innerText = loggedInUser['Username'] || '-';
                    document.getElementById('summarySisaSaldo').innerText = loggedInUser['Saldo'] !== undefined ? `Rp ${loggedInUser['Saldo'].toLocaleString('id-ID')}` : '-';

                } else {
                    document.getElementById('ordNomorHP').value = '';
                    document.getElementById('ordAlamat').value = '';
                    document.getElementById('ordUsername').value = '';
                    document.getElementById('summaryTipePelanggan').innerText = 'Tamu';
                    document.getElementById('summaryNamaLengkap').innerText = 'N/A';
                    document.getElementById('summaryNomorHP').innerText = 'N/A';
                    document.getElementById('summaryAlamat').innerText = 'N/A';
                    document.getElementById('summaryUsername').innerText = 'N/A';
                    document.getElementById('summarySisaSaldo').innerText = 'N/A';
                    
                    alert('Silakan login atau masukkan Nomor HP dan Alamat Anda untuk melanjutkan pesanan.');
                }
                showSection('order');
                updateOrderFormVisibility(); // Re-apply visibility rules
            });
        });

        // Event listeners for summary updates when form fields change
        document.getElementById('catatan').addEventListener('input', () => document.getElementById('summaryCatatan').innerText = document.getElementById('catatan').value);
        document.getElementById('metodePembayaranOrd').addEventListener('change', () => document.getElementById('summaryMetodePembayaran').innerText = document.getElementById('metodePembayaranOrd').value);
        
        // Update summary for guest fields if not logged in
        document.getElementById('ordNomorHP').addEventListener('input', () => { if (!loggedInUser) document.getElementById('summaryNomorHP').innerText = document.getElementById('ordNomorHP').value; });
        document.getElementById('ordAlamat').addEventListener('input', () => { if (!loggedInUser) document.getElementById('summaryAlamat').innerText = document.getElementById('ordAlamat').value; });
        document.getElementById('ordUsername').addEventListener('input', () => { if (!loggedInUser) document.getElementById('summaryUsername').innerText = document.getElementById('ordUsername').value; });


        document.addEventListener('DOMContentLoaded', () => {
            if (loadUserFromLocalStorage()) {
                updateNavigationButtons(true);
            } else {
                updateNavigationButtons(false);
            }
            showSection('home');
        });
    </script>
</body>
</html>
