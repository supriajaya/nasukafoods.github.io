<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasuka Foods</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    
    <link rel="stylesheet" href="https://nasukafoods.site/index.css">
    
   
</head>

<body>
    
<div class="container">
    <div id="home-container" style="display: block;">
        <div class="header">
            <div class="header-content">
                <div class="top-nav">
                    <span class="welcome">Nasuka Foods</span> 
                    <div> 
                        <span id="userNameDisplay"></span> 
                    </div>
                </div>
            </div>
        </div>

        <div class="balance-card">
            <div class="balance-title">Koin</div>
            <div class="balance-details">
                <span class="balance-amount" id="KoinAmountDisplay">...</span> <i class="fas fa-mobile-alt balance-icon" onclick="showGudang()"></i>
            </div>
            
            <a href="https://nasukafoods.site/burung.html" target="_blank" class="all-accounts" style="text-decoration: none;">
                <span>Koin gratis</span>
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>

        <div class="main-features">
         
           
            
            
            <div class="other-feature-item">
                <div class="other-feature-icon top-up-icon">
                    <img src="https://nasukafoods.site/image/logoisian.jpg" alt="" class="product-icon-img">
                </div>
                <span>Unggulan</span>
            </div>
            
          <div class="other-feature-item" onclick="showChat()">
                <div class="other-feature-icon setor-tarik-icon">
                    <img src="https://nasukafoods.site/image/customers.jpg" alt="" class="product-icon-img">
                </div>
                <span>CS</span>
            </div>
        </div>

        <a href="https://nasukafoods.site/testimoni.html" target="_blank" class="banner" style="text-decoration: none; display: flex;">
            <div class="banner-text" style="padding: 0; text-align: center; flex-grow: 1;">
                <span id="blinking-txt" style="display: block; width: 100%; white-space: normal;">
                    <strong>Interaksi Pelanggan</strong>
                </span>
            </div>
            <div class="banner-button">
               Lihat
            </div>
        </a>

        <div class="other-features">
            
            
          
            
             
            
           
            
            
              
            
          
            </div>
        </div>
            
        <div class="search-bar" id="marquee-search-bar">
            <i class="fas fa-search"> Cara Membuat</i>
            <div class="marquee-content">
                <span id="running-text"></span>
            </div>
        </div>

        <div class="other-features">
            <div id="dynamic-sponsors" style="display: contents;"></div>
        </div>

        <div class="search-bar" id="marquee-search-bar">
            <i class="fas fa-search">Powered By Nasuka Wireless</i>
            <div class="marquee-content">
                <span id="running-text"></span>
            </div>
        </div>

        <div class="other-features" style="margin-top: 20px;">
            <div id="dynamic-partners" style="display: contents;"></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" id="nav-dokumen" onclick="showDokumen()">
                <i class="fas fa-list-alt"></i>
                <span>Informasi</span>
            </div>
            <div class="nav-item" onclick="localStorage.getItem('ID') ? showProfil() : showLogin()">
                <i class="fas fa-user-circle"></i>
                <span>Akun</span>
            </div>
        </div>
    </div> 
   
    <div id="login-container" style="display:none;">
        <div class="auth-card-new">
            <div class="header-text-new">SELAMAT DATANG</div>
            
            <div class="logo-circle-new">
                <img src="https://nasukafoods.site/image/logopremium.jpg" alt="Logo" class="logo-image-new">
            </div>
            <div class="company-name-new">Rasa yang dulu pernah ada</div>

            <div class="input-group-new">
                <span class="icon-new">ðŸ‘¤</span>
                <input type="number" id="authWA" placeholder="Nomor WhatsApp" required>
            </div>

            <div class="input-group-new">
                <span class="icon-new">ðŸ“±</span>
                <input type="password" id="authPIN" placeholder="Masukkan PIN" maxlength="6" inputmode="numeric">
            </div>

            <div class="terms-container-new">
                <input type="checkbox" checked>
                <span>Simpan dan ingat PIN anda untuk masuk selanjutnya</span>
            </div>

            <button onclick="handleAuth()" class="login-btn-new">MASUK</button>
            <div id="authStatus" style="margin-top:10px; font-weight:bold; color:#000;"></div>
            <button onclick="showHome()" style="background:none; border:none; color:#000; margin-top:10px; cursor:pointer; font-size:12px;">Kembali ke Beranda</button>

            <div class="register-text-new">
               Mode cepat register / login dengan 1 klik
            </div>

            <div class="footer-section-new">
                <div class="help-divider-new">
                    <span>Perlu Bantuan?</span>
                </div>
                
                <a href="https://wa.me/62859109819017" class="wa-link-new">
                    Hubungi Kami (Chat Only)
                </a>

                <div class="priority-text-new">Speed is our priority</div>
            </div>
        </div>
    </div>

    <div id="profil-container">
        <div class="profil-card">
            <div class="profil-header-nav">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3>Profil Saya</h3>
                <div>
                    <i class="fas fa-pencil-alt" onclick="showEditProfil()"></i>
                    <i class="fas fa-question-circle" style="margin-left: 15px;"></i>
                </div>
            </div>

            <div class="driver-info">
                <img id="profilFoto" class="driver-foto" src="https://nasukafoods.site/image/cover1.jpg" alt="Foto Profil">
                <div class="driver-text">
                    <h4 id="profilNamaDriver">...</h4>
                    <div class="driver-details">
                        Gabung bulan <span id="profilBulanJoin">...</span> | 
                        <span id="profilIDPlat">...</span> 
                    </div>
                </div>
            </div>
            
            <div class="rating-section" style="padding: 10px 15px; margin-bottom: 5px; background-color: #fff8e1; border-radius: 8px; border: 1px solid #ffecb3;">
                <div style="font-size: 14px; font-weight: 600; color: #ff9800;">Koin Anda</div>
                <div style="font-size: 20px; font-weight: 700; color: #333;" id="profilKoinDisplay">...</div>
            </div>
            
            <div class="safety-report" onclick="showHistory()"> 
                <div class="safety-report-left">
                    <div class="safety-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="safety-text">
                        Riwayat pembelian
                        <span>Lihat transaksi anda</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>

            <div class="rating-section" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                <div class="rating-main">
                    <div class="rating-score" id="profilRatingScore"></div>
                    <div class="rating-label">
                         <a href="https://nasukafoods.site/tukerkoin.html" target="_blank" style="text-decoration: none; color: inherit;">
                            <span>Tuker Koin</span>
                        </a>
                    </div>
                </div>
                <div class="rating-breakdown" id="contributor-list">
                    </div>
            </div>

            <div class="profil-tabs">
                <div class="profil-tab-item active" id="tabPencapaian">Umum</div>
                <div class="profil-tab-item" id="tabPerbaikan">Keluar</div>
            </div>

            <div id="contentPencapaian" class="tab-content-section">
                <div class="badge-section">
                    <h4>Informasi Pengiriman</h4>
                    <div class="badge-card">
                        <img src="https://nasukafoods.site/image/cover1.jpg" alt="" class="badge-image">
                        <div class="badge-text">
                            <strong>Alamat :</strong>
                            <span id="profilAlamatPengiriman">...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="contentPerbaikan" class="tab-content-section" style="display: none; text-align: center;">
                <p style="color: #666; font-style: italic;">Anda yakin ingin keluar ?.</p>
                <button id="btnLogout" class="btn-kembali" onclick="logoutUser()" style="background-color: #f44336; margin-top: 20px;">Keluar Sekarang</button>
            </div>
        </div>
    </div>

    <div id="editprofil-container"></div>

    <div id="dokumen-container" class="auth-container" style="display: none;">
        <div class="dokumen-card-modified">
            <div class="dokumen-header">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3 id="dokumen-title">Informasi</h3>
            </div>
            <div class="dokumen-content-section"></div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
    authDomain: "nasukafoods1.firebaseapp.com",
    databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nasukafoods1",
    messagingSenderId: "84287800896",
    appId: "1:84287800896:web:83189d6766997b00f701a5"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const localUser = {
  Username: localStorage.getItem("Username"),
  Nama: localStorage.getItem("Nama"),
  ID: localStorage.getItem("ID"),
  Koin: parseInt(localStorage.getItem("Koin")) || 0,
  Alamat: localStorage.getItem("Alamat") || "Alamat belum diatur",
  NomorHP: localStorage.getItem("NomorHP") || "Belum diatur",
  PIN: localStorage.getItem("PIN") || "",
  Foto: localStorage.getItem("Foto") || "https://nasukafoods.site/gambarkosong.jpg", 
};

if (localUser.ID) {
    db.ref(`users/${localUser.ID}`).on('value', (snapshot) => {
      const userData = snapshot.val();
      if (userData) {
        Object.assign(localUser, userData);
        localStorage.setItem("Koin", localUser.Koin);
        localStorage.setItem("Alamat", localUser.Alamat);
        localStorage.setItem("NomorHP", localUser.NomorHP);
        localStorage.setItem("Nama", localUser.Nama);
        localStorage.setItem("Username", localUser.Username);
        localStorage.setItem("PIN", localUser.PIN);
        updateHomeDisplay();
      }
    });
}

function hideAllContainers() {
    document.querySelectorAll('#home-container, #login-container, #profil-container, #editprofil-container, #dokumen-container').forEach(el => { 
        if (el) el.style.display = 'none';
    });
}

function updateHomeDisplay() {
    const userNameEl = document.getElementById('userNameDisplay');
    const KoinEl = document.getElementById('KoinAmountDisplay');
    if (userNameEl && localUser.ID) {
        userNameEl.textContent = localUser.Nama ? localUser.Nama.split(' ')[0] : "User";
        KoinEl.textContent = (localUser.Koin || 0).toLocaleString('id-ID'); 
    } else if (KoinEl) {
        KoinEl.textContent = "0"; 
    }
}

function showHome() { hideAllContainers(); document.getElementById('home-container').style.display = 'block'; updateHomeDisplay(); }
function showLogin() { hideAllContainers(); document.getElementById('login-container').style.display = 'flex'; }

async function handleAuth() {
    const noWA = document.getElementById('authWA').value.trim();
    const pin = document.getElementById('authPIN').value.trim();
    const statusDiv = document.getElementById('authStatus');

    if (noWA.length < 10) return alert("Nomor WA tidak valid");
    if (pin.length !== 6) return alert("PIN harus 6 digit");

    statusDiv.innerHTML = "Memproses...";

    const snapshot = await db.ref("users").orderByChild("NomorHP").equalTo(noWA).once("value");
    
    if (snapshot.exists()) {
        const user = Object.values(snapshot.val())[0];
        if (user.PIN === pin) {
            loginSuccess(user);
        } else {
            statusDiv.innerHTML = "PIN SALAH!";
        }
    } else {
        const newID = "NSK" + Math.floor(1000 + Math.random() * 9000);
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        const newUser = {
            ID: newID, 
            NomorHP: noWA, 
            PIN: pin, 
            Nama: "Pelanggan Baru",
            Username: "NS-" + randomNum,
            Koin: 0, 
            Alamat: "Belum diatur", 
            TanggalJoin: new Date().toISOString()
        };
        await db.ref(`users/${newID}`).set(newUser);
        loginSuccess(newUser);
    }
}

function loginSuccess(user) {
    localStorage.setItem("ID", user.ID);
    localStorage.setItem("Username", user.Username || user.ID);
    localStorage.setItem("Nama", user.Nama);
    localStorage.setItem("NomorHP", user.NomorHP);
    localStorage.setItem("PIN", user.PIN);
    
    const pesan = `Halo Admin, saya login/daftar Nasuka Foods. %0AHP: ${user.NomorHP}%0AID: ${user.ID}`;
    window.open(`https://wa.me/62859109819017?text=${pesan}`, '_blank');
    location.reload();
}

function showGudang() {
    if(!localUser.ID) return showLogin();
    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = 'Input Koin';
    doc.querySelector('.dokumen-content-section').innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <input type="number" id="inputVoucher" placeholder="6 Digit Voucher" style="width: 80%; padding: 10px; margin-bottom:10px;">
            <input type="password" id="confirmPIN" placeholder="PIN 6-Digit" maxlength="6" style="width: 80%; padding: 10px; margin-bottom:10px; text-align:center;">
            <button onclick="prosesVoucher()" class="btn-primary">Klaim</button>
        </div>
    `;
}

async function prosesVoucher() {
    const kode = document.getElementById('inputVoucher').value;
    const pin = document.getElementById('confirmPIN').value;
    const userSnap = await db.ref(`users/${localUser.ID}`).once('value');
    
    if (pin !== userSnap.val().PIN) return alert("PIN SALAH!");

    const vRef = db.ref(`vouchers/${kode}`);
    const vSnap = await vRef.once('value');
    if (vSnap.exists()) {
        const nominal = vSnap.val();
        await vRef.remove();
        await db.ref(`users/${localUser.ID}/Koin`).transaction(s => (s || 0) + nominal);
        alert("Berhasil klaim " + nominal.toLocaleString('id-ID') + " Koin");
        showHome();
    } else { alert("Voucher tidak valid"); }
}

function showProfil() {
    hideAllContainers();
    document.getElementById('profil-container').style.display = 'block';
    document.getElementById('profilNamaDriver').textContent = localUser.Nama;
    document.getElementById('profilKoinDisplay').textContent = localUser.Koin.toLocaleString('id-ID');
    document.getElementById('profilAlamatPengiriman').textContent = localUser.Alamat;
    document.getElementById('profilIDPlat').textContent = 'HP: ' + localUser.NomorHP;
    const tgl = new Date(localStorage.getItem("TanggalJoin") || new Date());
    document.getElementById('profilBulanJoin').textContent = tgl.toLocaleString('id-ID', { month: 'short', year: 'numeric' });
}

function logoutUser() { localStorage.clear(); location.reload(); }

function showEditProfil() {
    hideAllContainers();
    const editContainer = document.getElementById('editprofil-container');
    editContainer.style.display = 'flex';
    editContainer.innerHTML = `
        <div class="edit-header">
            <i class="fas fa-arrow-left" onclick="showProfil()"></i>
            <h1>Edit profil</h1>
        </div>
        <div class="images-container">
            <div class="cover-photo"></div>
            <div class="profile-wrapper">
                <div class="profile-pic-edit" style="background-image: url('${localUser.Foto}')"></div>
            </div>
        </div>
        <div class="section-edit">
            <div class="section-header-edit">
                <span class="section-title-edit">Akun</span>
            </div>
            <div class="item-row-edit">
                <div class="item-icon-edit"><i class="fas fa-user"></i></div>
                <div class="item-content-edit">
                    <div class="item-label-edit">Nama</div>
                    <input type="text" id="enama" class="edit-input" value="${localUser.Nama}">
                </div>
            </div>
        </div>
        <div class="section-edit">
            <div class="section-header-edit">
                <span class="section-title-edit">Akses Keamanan</span>
            </div>
            <div class="item-row-edit">
                <div class="item-icon-edit"><i class="fab fa-whatsapp"></i></div>
                <div class="item-content-edit">
                    <div class="item-label-edit">Nomor Whatsapp</div>
                    <input type="number" id="ewa" class="edit-input" value="${localUser.NomorHP}">
                </div>
            </div>
            <div class="item-row-edit">
                <div class="item-icon-edit"><i class="fas fa-key"></i></div>
                <div class="item-content-edit">
                    <div class="item-label-edit">PIN Keamanan (6 Digit)</div>
                    <input type="password" id="epin" class="edit-input" value="${localUser.PIN}" maxlength="6" inputmode="numeric">
                </div>
            </div>
        </div>
        <div class="section-edit">
            <div class="section-header-edit">
                <span class="section-title-edit">Detail pengiriman</span>
            </div>
            <div class="item-row-edit">
                <div class="item-icon-edit"><i class="fas fa-map-marker-alt"></i></div>
                <div class="item-content-edit">
                    <div class="item-label-edit">Alamat Lengkap</div>
                    <textarea id="ealamat" style="width:100%; border:1px solid #eee; border-radius:4px; padding:5px; font-size:14px;">${localUser.Alamat}</textarea>
                </div>
            </div>
        </div>
        <div class="save-btn-container">
            <button onclick="saveProfil()" class="btn-save-new">SIMPAN PERUBAHAN</button>
        </div>
    `;
}

function saveProfil() {
    const n = document.getElementById('enama').value.trim();
    const a = document.getElementById('ealamat').value.trim();
    const w = document.getElementById('ewa').value.trim();
    const p = document.getElementById('epin').value.trim();

    if (w.length < 10) return alert("Nomor WhatsApp tidak valid");
    if (p.length !== 6) return alert("PIN harus 6 digit");

    db.ref(`users/${localUser.ID}`).update({ 
        Nama: n, 
        Alamat: a,
        NomorHP: w,
        PIN: p
    }).then(() => {
        alert("Profil berhasil diperbarui");
        showProfil();
    }).catch(err => {
        alert("Gagal menyimpan: " + err.message);
    });
}

function showDokumen() {
    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = 'Informasi';
    doc.querySelector('.dokumen-content-section').innerHTML = `<div class="dokumen-item"><h4>âœ¨ Nasuka Foods</h4><p>Sistem Cilok Premium Berbasis Digital.</p></div>`;
}

function showHistory() {
    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = 'Riwayat';
    db.ref(`history/${localUser.ID}`).once('value').then(snap => {
        let h = '';
        snap.forEach(c => {
            const d = c.val();
            h += `<div class="dokumen-item" style="border-left:4px solid #ee4d2d; margin-bottom:10px;"><b>${d.produk}</b><br><small>${d.tanggal}</small><br><span style="color:#ee4d2d">-${d.total.toLocaleString()} Koin</span></div>`;
        });
        doc.querySelector('.dokumen-content-section').innerHTML = h || '<p>Belum ada transaksi.</p>';
    });
}

function showChat() {
    let chatId = localUser.ID;
    let isAnonymous = false;

    if (!chatId) {
        isAnonymous = true;
        chatId = localStorage.getItem("AnonID");
        if (!chatId) {
            chatId = "ANON-" + Math.floor(100000 + Math.random() * 900000);
            localStorage.setItem("AnonID", chatId);
        }
    }

    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = isAnonymous ? 'Chat Pengunjung' : 'Chat Admin';
    
    doc.querySelector('.dokumen-content-section').innerHTML = `
        <div id="chatBox" class="chat-messages"></div>
        <div style="display:flex; gap:5px; margin-top:10px;">
            <input type="text" id="chatInput" placeholder="Tulis pesan..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="sendChat('${chatId}')" class="btn-primary" style="width:auto; padding:0 15px;">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    `;

    db.ref(`chats/${chatId}`).on('value', (snap) => {
        const box = document.getElementById('chatBox');
        if(!box) return;
        box.innerHTML = '';
        snap.forEach(c => { 
            const m = c.val(); 
            box.innerHTML += `<div class="msg ${m.sender === 'admin' ? 'msg-admin' : 'msg-user'}">${m.text}</div>`; 
        });
        box.scrollTop = box.scrollHeight;
    });
}

function sendChat(targetId) {
    const i = document.getElementById('chatInput');
    const t = i.value.trim();
    if(!t) return;
    
    db.ref(`chats/${targetId}`).push({ 
        sender: 'user', 
        text: t, 
        timestamp: Date.now(),
        type: localUser.ID ? 'member' : 'anonymous'
    });
    i.value = '';
}

function loadDynamicKatalogs() {
    db.ref('sponsors_list').on('value', (snapshot) => {
        const container = document.getElementById('dynamic-sponsors');
        if (!container) return;
        let htmlContent = '';
        snapshot.forEach((child) => {
            const data = child.val();
            htmlContent += `<a href="${data.url}" target="_blank" class="other-feature-item"><div class="other-feature-icon sponsor-frame"><img src="${data.image}" class="product-icon-img"></div><span style="font-weight: bold; color: #b38728;">${data.nama}</span></a>`;
        });
        container.innerHTML = htmlContent;
    });
}

function loadDynamicPartners() {
    db.ref('partners_list').on('value', (snapshot) => {
        const container = document.getElementById('dynamic-partners');
        if (!container) return;
        let htmlContent = '';
        snapshot.forEach((child) => {
            const data = child.val();
            htmlContent += `<a href="${data.url || '#'}" target="_blank" class="other-feature-item"><div class="other-feature-icon"><img src="${data.image}" class="product-icon-img" onerror="this.src='https://nasukafoods.site/gambarkosong.jpg'"></div><span>${data.nama}</span></a>`;
        });
        container.innerHTML = htmlContent;
    });
}

$(document).ready(() => {
    showHome();
    loadDynamicKatalogs(); 
    loadDynamicPartners();
    $('#tabPencapaian').on('click', function() { $('.profil-tab-item').removeClass('active'); $(this).addClass('active'); $('#contentPencapaian').show(); $('#contentPerbaikan').hide(); });
    $('#tabPerbaikan').on('click', function() { $('.profil-tab-item').removeClass('active'); $(this).addClass('active'); $('#contentPencapaian').hide(); $('#contentPerbaikan').show(); });
});
</script>
</body>
</html>
