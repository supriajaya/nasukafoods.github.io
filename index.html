<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasuka Foods</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <link rel="stylesheet" href="https://nasukafoods.site/lain.css">
    <link rel="stylesheet" href="https://nasukafoods.site/index.css">
    
    <style>
.moving-text-container {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 15s linear infinite;
}

.moving-text {
    font-weight: bold;
    color: #333;
}

@keyframes marquee {
    0% { transform: translate(0, 0); }
    100% { transform: translate(-100%, 0); }
}

/* Style Tambahan untuk Chat */
.chat-messages {
    height: 300px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
}
.msg {
    max-width: 80%;
    padding: 8px 12px;
    border-radius: 15px;
    font-size: 14px;
    line-height: 1.4;
}
.msg-user {
    align-self: flex-end;
    background: #ee4d2d;
    color: white;
}
.msg-admin {
    align-self: flex-start;
    background: #e0e0e0;
    color: #333;
}

/* Modifikasi Navigasi Bawah Transparan Penuh */
.bottom-nav {
    background: rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: none !important;
    position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 1000;
}

.container {
    padding-bottom: 70px; 
}

.sponsor-frame {
    position: relative;
    padding: 3px;
    background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 10px rgba(191, 149, 63, 0.5);
    animation: gold-glow 3s infinite alternate;
}

.sponsor-frame img {
    border: 2px solid #fff;
    background: white;
}

@keyframes gold-glow {
    0% { box-shadow: 0 0 5px rgba(191, 149, 63, 0.4); }
    100% { box-shadow: 0 0 15px rgba(251, 245, 183, 0.8); }
}

/* Style tambahan untuk input auth baru */
.auth-input-group input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-top: 5px;
    box-sizing: border-box;
    font-size: 16px;
}
</style>
</head>

<body>
    
<div class="container">
    <div id="home-container" style="display: block;">
        <div class="header">
            <div class="header-content">
                <div class="top-nav">
                    <span class="welcome">Nasuka Foods</span> 
                    <div> 
                        <span id="userNameDisplay"></span> 
                    </div>
                </div>
            </div>
        </div>

        <div class="balance-card">
            <div class="balance-title">Koin</div>
            <div class="balance-details">
                <span class="balance-amount" id="KoinAmountDisplay">...</span> <i class="fas fa-mobile-alt balance-icon" onclick="showDownload()"></i>
            </div>
            
            <a href="https://nasukafoods.site/tukerkoin.html" target="_blank" class="all-accounts" style="text-decoration: none;">
                <span>Tukar Koin</span>
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>

        <div class="main-features">
           <a href="https://nasukafoods.site/album.html" target="_blank" class="feature-link">
                <div class="feature-icon-circle transfer-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <span>Video</span>
            </a>
            
            <a href="https://nasukafoods.site/burung.html" target="_blank" class="feature-link">
                <div class="feature-icon-circle pulsa-icon" style="overflow: hidden; padding: 0;">
                    <img src="https://nasukafoods.site/image/nasukabird.jpg" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                </div>
                <span>Koin Gratis</span>
            </a>
            
            <a href="javascript:void(0)" onclick="showGudang()" class="feature-link">
                <div class="feature-icon-circle pdam-icon">
                    <i class="fas fa-plus"></i> 
                </div>
                <span>Input Koin</span>
            </a>

            <a href="https://nasukafoods.site/posisi-mang-cilok.html" target="_blank" class="feature-link">
                <div class="feature-icon-circle pulsa-icon" style="overflow: hidden; padding: 0;">
                    <img src="https://nasukafoods.site/image/dokumen.jpg" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                </div>
                <span>Pustaka</span>
            </a>
        </div>

        <a href="https://nasukafoods.site/testimoni.html" target="_blank" class="banner" style="text-decoration: none; display: flex;">
            <div class="banner-text" style="padding: 0; text-align: center; flex-grow: 1;">
                <span id="blinking-txt" style="display: block; width: 100%; white-space: normal;">
                    <strong>Interaksi Pelanggan</strong>
                </span>
            </div>
            <div class="banner-button">
               Lihat
            </div>
        </a>

        <div class="other-features">
            <div class="other-feature-item">
                <div class="other-feature-icon top-up-icon">
                    <img src="https://nasukafoods.site/image/logoisian.jpg" alt="" class="product-icon-img">
                </div>
                <span>Unggulan</span>
            </div>
            
            <div class="other-feature-item">
                <div class="other-feature-icon brizzi-icon">
                    <img src="https://nasukafoods.site/image/logopremium.jpg" alt="" class="product-icon-img">
                </div>
                <span>Premium</span>
            </div>
            
            <div class="other-feature-item">
                <div class="other-feature-icon tagihan-icon">
                    <img src="https://nasukafoods.site/image/order.jpg" alt="" class="product-icon-img">
                </div>
                <span>ORDER</span>
            </div>
            
            <div class="other-feature-item" onclick="showChat()">
                <div class="other-feature-icon setor-tarik-icon">
                    <img src="https://nasukafoods.site/image/customers.jpg" alt="" class="product-icon-img">
                </div>
                <span>CHAT</span>
            </div>
        </div>
            
        <div class="search-bar" id="marquee-search-bar">
            <i class="fas fa-search"> Sponsor</i>
            <div class="marquee-content">
                <span id="running-text"></span>
            </div>
        </div>

        <div class="other-features">
            <div id="dynamic-sponsors" style="display: contents;"></div>
        </div>

        <div class="search-bar" id="marquee-search-bar">
            <i class="fas fa-search">Partner</i>
            <div class="marquee-content">
                <span id="running-text"></span>
            </div>
        </div>

        <div class="other-features" style="margin-top: 20px;">
            <div id="dynamic-partners" style="display: contents;"></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" id="nav-dokumen" onclick="showDokumen()">
                <i class="fas fa-list-alt"></i>
                <span>Informasi</span>
            </div>
            <div class="nav-item" onclick="localStorage.getItem('ID') ? showProfil() : showLogin()">
                <i class="fas fa-user-circle"></i>
                <span>Akun</span>
            </div>
        </div>
    </div> 
   
    <div id="login-container" class="auth-container" style="display:none;">
        <div class="auth-card">
            <div class="auth-logo-section">
                <img src="https://nasukafoods.site/nasukafoods.jpg" alt="Nasuka Foods" class="auth-logo">
            </div>
            <h2>Masuk / Daftar</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 15px;">Akses cepat dengan nomor WA & PIN</p>
            
            <div class="auth-input-group">
                <label>Nomor WhatsApp</label>
                <input type="number" id="authWA" placeholder="Contoh: 08123456789" required>
            </div>
            <div class="auth-input-group" style="margin-top:10px;">
                <label>PIN Keamanan (6 Digit)</label>
                <input type="password" id="authPIN" placeholder="Masukkan 6 Angka" maxlength="6" inputmode="numeric" style="text-align:center; letter-spacing: 5px;">
            </div>
            
            <button onclick="handleAuth()" class="btn-primary" style="margin-top:20px;">Lanjutkan</button>
            <div id="authStatus" class="auth-status"></div>
            <button onclick="showHome()" class="btn-secondary" style="margin-top:10px;">Kembali</button>
        </div>
    </div>

    <div id="profil-container">
        <div class="profil-card">
            <div class="profil-header-nav">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3>Profil Saya</h3>
                <div>
                    <i class="fas fa-pencil-alt" onclick="showEditProfil()"></i>
                    <i class="fas fa-question-circle" style="margin-left: 15px;"></i>
                </div>
            </div>

            <div class="driver-info">
                <img id="profilFoto" class="driver-foto" src="https://nasukafoods.site/image/cover1.jpg" alt="Foto Profil">
                <div class="driver-text">
                    <h4 id="profilNamaDriver">...</h4>
                    <div class="driver-details">
                        Gabung bulan <span id="profilBulanJoin">...</span> | 
                        <span id="profilIDPlat">...</span> 
                    </div>
                </div>
            </div>
            
            <div class="rating-section" style="padding: 10px 15px; margin-bottom: 5px; background-color: #fff8e1; border-radius: 8px; border: 1px solid #ffecb3;">
                <div style="font-size: 14px; font-weight: 600; color: #ff9800;">Koin Anda</div>
                <div style="font-size: 20px; font-weight: 700; color: #333;" id="profilKoinDisplay">...</div>
            </div>
            
            <div class="safety-report" onclick="showHistory()"> 
                <div class="safety-report-left">
                    <div class="safety-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="safety-text">
                        Riwayat pembelian
                        <span>Lihat transaksi anda</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>

            <div class="rating-section" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                <div class="rating-main">
                    <div class="rating-score" id="profilRatingScore">Kontributor</div>
                    <div class="rating-label">
                         <a href="https://nasukafoods.site/kontributor-Koin-publik.html" target="_blank" style="text-decoration: none; color: inherit;">
                            <span>Pelanggan</span>
                        </a>
                    </div>
                </div>
                <div class="rating-breakdown" id="contributor-list">
                    </div>
            </div>

            <div class="profil-tabs">
                <div class="profil-tab-item active" id="tabPencapaian">Umum</div>
                <div class="profil-tab-item" id="tabPerbaikan">Keluar</div>
            </div>

            <div id="contentPencapaian" class="tab-content-section">
                <div class="badge-section">
                    <h4>Informasi Pengiriman</h4>
                    <div class="badge-card">
                        <img src="https://nasukafoods.site/image/cover1.jpg" alt="" class="badge-image">
                        <div class="badge-text">
                            <strong>Alamat :</strong>
                            <span id="profilAlamatPengiriman">...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="contentPerbaikan" class="tab-content-section" style="display: none; text-align: center;">
                <p style="color: #666; font-style: italic;">Anda yakin ingin keluar ?.</p>
                <button id="btnLogout" class="btn-kembali" onclick="logoutUser()" style="background-color: #f44336; margin-top: 20px;">Keluar Sekarang</button>
            </div>
        </div>
    </div>

    <div id="editprofil-container" class="auth-container"></div>

    <div id="download-container">
        <div class="download-header"><i class="fas fa-arrow-left" onclick="showHome()"></i> Kembali</div>
        <div class="download-content">
            <div class="app-info-top">
                <img src="https://nasukafoods.site/nasukafoods.jpg" class="app-logo">
                <div class="app-text">
                    <div class="app-title">Nasuka.Apk</div>
                    <div class="app-publisher">Nasuka Wireless</div>
                </div>
            </div>
        </div>
        <a href="https://nasukafoods.site/nasuka.apk" target="_blank" class="download-footer-bar">
            <div>Download sekarang</div>
            <i class="fas fa-download"></i>
        </a>
    </div>

    <div id="dokumen-container" class="auth-container" style="display: none;">
        <div class="dokumen-card-modified">
            <div class="dokumen-header">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3 id="dokumen-title">Informasi</h3>
            </div>
            <div class="dokumen-content-section"></div>
        </div>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
    authDomain: "nasukafoods1.firebaseapp.com",
    databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nasukafoods1",
    messagingSenderId: "84287800896",
    appId: "1:84287800896:web:83189d6766997b00f701a5"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const localUser = {
  Username: localStorage.getItem("Username"),
  Nama: localStorage.getItem("Nama"),
  ID: localStorage.getItem("ID"),
  Koin: parseInt(localStorage.getItem("Koin")) || 0,
  Alamat: localStorage.getItem("Alamat") || "Alamat belum diatur",
  NomorHP: localStorage.getItem("NomorHP") || "Belum diatur",
  Foto: localStorage.getItem("Foto") || "https://nasukafoods.site/gambarkosong.jpg", 
};

if (localUser.ID) {
    db.ref(`users/${localUser.ID}`).on('value', (snapshot) => {
      const userData = snapshot.val();
      if (userData) {
        Object.assign(localUser, userData);
        localStorage.setItem("Koin", localUser.Koin);
        localStorage.setItem("Alamat", localUser.Alamat);
        localStorage.setItem("NomorHP", localUser.NomorHP);
        localStorage.setItem("Nama", localUser.Nama);
        localStorage.setItem("Username", localUser.Username);
        updateHomeDisplay();
      }
    });
}

function hideAllContainers() {
    document.querySelectorAll('#home-container, #login-container, #profil-container, #editprofil-container, #download-container, #dokumen-container').forEach(el => { 
        if (el) el.style.display = 'none';
    });
}

function updateHomeDisplay() {
    const userNameEl = document.getElementById('userNameDisplay');
    const KoinEl = document.getElementById('KoinAmountDisplay');
    if (userNameEl && localUser.ID) {
        userNameEl.textContent = localUser.Nama ? localUser.Nama.split(' ')[0] : "User";
        KoinEl.textContent = (localUser.Koin || 0).toLocaleString('id-ID'); 
    } else if (KoinEl) {
        KoinEl.textContent = "0"; 
    }
}

function showHome() { hideAllContainers(); document.getElementById('home-container').style.display = 'block'; updateHomeDisplay(); }
function showLogin() { hideAllContainers(); document.getElementById('login-container').style.display = 'flex'; }
function showDownload() { hideAllContainers(); document.getElementById('download-container').style.display = 'block'; }

// LOGIKA AUTH WA & PIN BARU
async function handleAuth() {
    const noWA = document.getElementById('authWA').value.trim();
    const pin = document.getElementById('authPIN').value.trim();
    const statusDiv = document.getElementById('authStatus');

    if (noWA.length < 10) return alert("Nomor WA tidak valid");
    if (pin.length !== 6) return alert("PIN harus 6 digit");

    statusDiv.innerHTML = "Memproses...";

    const snapshot = await db.ref("users").orderByChild("NomorHP").equalTo(noWA).once("value");
    
    if (snapshot.exists()) {
        const user = Object.values(snapshot.val())[0];
        if (user.PIN === pin) {
            loginSuccess(user);
        } else {
            statusDiv.innerHTML = "PIN SALAH!";
        }
    } else {
        const newID = "NSK" + Math.floor(1000 + Math.random() * 9000);
        const randomNum = Math.floor(1000 + Math.random() * 9000);
        const newUser = {
            ID: newID, 
            NomorHP: noWA, 
            PIN: pin, 
            Nama: "Pelanggan Baru",
            Username: "NS-" + randomNum,
            Koin: 0, 
            Alamat: "Belum diatur", 
            TanggalJoin: new Date().toISOString()
        };
        await db.ref(`users/${newID}`).set(newUser);
        loginSuccess(newUser);
    }
}

function loginSuccess(user) {
    localStorage.setItem("ID", user.ID);
    localStorage.setItem("Username", user.Username || user.ID);
    localStorage.setItem("Nama", user.Nama);
    localStorage.setItem("NomorHP", user.NomorHP);
    
    const pesan = `Halo Admin, saya login/daftar Nasuka Foods. %0AHP: ${user.NomorHP}%0AID: ${user.ID}`;
    window.open(`https://wa.me/62859109819017?text=${pesan}`, '_blank');
    location.reload();
}

function showGudang() {
    if(!localUser.ID) return showLogin();
    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = 'Input Koin';
    doc.querySelector('.dokumen-content-section').innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <input type="number" id="inputVoucher" placeholder="6 Digit Voucher" style="width: 80%; padding: 10px; margin-bottom:10px;">
            <input type="password" id="confirmPIN" placeholder="PIN 6-Digit" maxlength="6" style="width: 80%; padding: 10px; margin-bottom:10px; text-align:center;">
            <button onclick="prosesVoucher()" class="btn-primary">Klaim</button>
        </div>
    `;
}

async function prosesVoucher() {
    const kode = document.getElementById('inputVoucher').value;
    const pin = document.getElementById('confirmPIN').value;
    const userSnap = await db.ref(`users/${localUser.ID}`).once('value');
    
    if (pin !== userSnap.val().PIN) return alert("PIN SALAH!");

    const vRef = db.ref(`vouchers/${kode}`);
    const vSnap = await vRef.once('value');
    if (vSnap.exists()) {
        const nominal = vSnap.val();
        await vRef.remove();
        await db.ref(`users/${localUser.ID}/Koin`).transaction(s => (s || 0) + nominal);
        alert("Berhasil klaim " + nominal.toLocaleString('id-ID') + " Koin");
        showHome();
    } else { alert("Voucher tidak valid"); }
}

function showProfil() {
    hideAllContainers();
    document.getElementById('profil-container').style.display = 'block';
    document.getElementById('profilNamaDriver').textContent = localUser.Nama;
    document.getElementById('profilKoinDisplay').textContent = localUser.Koin.toLocaleString('id-ID');
    document.getElementById('profilAlamatPengiriman').textContent = localUser.Alamat;
    document.getElementById('profilIDPlat').textContent = 'HP: ' + localUser.NomorHP;
    const tgl = new Date(localStorage.getItem("TanggalJoin") || new Date());
    document.getElementById('profilBulanJoin').textContent = tgl.toLocaleString('id-ID', { month: 'short', year: 'numeric' });
}

function logoutUser() { localStorage.clear(); location.reload(); }

function showEditProfil() {
    hideAllContainers();
    const editContainer = document.getElementById('editprofil-container');
    editContainer.style.display = 'flex';
    editContainer.innerHTML = `
        <div class="auth-card">
            <h3>Edit Profil</h3>
            <input type="text" id="enama" value="${localUser.Nama}" style="width:100%; padding:10px; margin-bottom:10px;">
            <textarea id="ealamat" style="width:100%; padding:10px; height:80px;">${localUser.Alamat}</textarea>
            <button onclick="saveProfil()" class="btn-primary">Simpan</button>
            <button onclick="showProfil()" class="btn-secondary" style="margin-top:5px;">Batal</button>
        </div>
    `;
}

function saveProfil() {
    const n = document.getElementById('enama').value;
    const a = document.getElementById('ealamat').value;
    db.ref(`users/${localUser.ID}`).update({ Nama: n, Alamat: a }).then(() => showProfil());
}

function showDokumen() {
    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = 'Informasi';
    doc.querySelector('.dokumen-content-section').innerHTML = `<div class="dokumen-item"><h4>âœ¨ Nasuka Foods</h4><p>Sistem Cilok Premium Berbasis Digital.</p></div>`;
}

function showHistory() {
    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = 'Riwayat';
    db.ref(`history/${localUser.ID}`).once('value').then(snap => {
        let h = '';
        snap.forEach(c => {
            const d = c.val();
            h += `<div class="dokumen-item" style="border-left:4px solid #ee4d2d; margin-bottom:10px;"><b>${d.produk}</b><br><small>${d.tanggal}</small><br><span style="color:#ee4d2d">-${d.total.toLocaleString()} Koin</span></div>`;
        });
        doc.querySelector('.dokumen-content-section').innerHTML = h || '<p>Belum ada transaksi.</p>';
    });
}

function showChat() {
    if (!localUser.ID) return showLogin();
    hideAllContainers();
    const doc = document.getElementById('dokumen-container');
    doc.style.display = 'flex';
    document.getElementById('dokumen-title').textContent = 'Chat Admin';
    doc.querySelector('.dokumen-content-section').innerHTML = `<div id="chatBox" class="chat-messages"></div><div style="display:flex; gap:5px; margin-top:10px;"><input type="text" id="chatInput" placeholder="Pesan..." style="flex:1; padding:10px;"><button onclick="sendChat()" class="btn-primary" style="width:auto; padding:0 15px;"><i class="fas fa-paper-plane"></i></button></div>`;
    db.ref(`chats/${localUser.ID}`).on('value', (snap) => {
        const box = document.getElementById('chatBox');
        if(!box) return;
        box.innerHTML = '';
        snap.forEach(c => { const m = c.val(); box.innerHTML += `<div class="msg ${m.sender === 'admin' ? 'msg-admin' : 'msg-user'}">${m.text}</div>`; });
        box.scrollTop = box.scrollHeight;
    });
}

function sendChat() {
    const i = document.getElementById('chatInput');
    const t = i.value.trim();
    if(!t) return;
    db.ref(`chats/${localUser.ID}`).push({ sender: 'user', text: t, timestamp: Date.now() });
    i.value = '';
}

function loadDynamicSponsors() {
    db.ref('sponsors_list').on('value', (snapshot) => {
        const container = document.getElementById('dynamic-sponsors');
        if (!container) return;
        let htmlContent = '';
        snapshot.forEach((child) => {
            const data = child.val();
            htmlContent += `<a href="${data.url}" target="_blank" class="other-feature-item"><div class="other-feature-icon sponsor-frame"><img src="${data.image}" class="product-icon-img"></div><span style="font-weight: bold; color: #b38728;">${data.nama}</span></a>`;
        });
        container.innerHTML = htmlContent;
    });
}

function loadDynamicPartners() {
    db.ref('partners_list').on('value', (snapshot) => {
        const container = document.getElementById('dynamic-partners');
        if (!container) return;
        let htmlContent = '';
        snapshot.forEach((child) => {
            const data = child.val();
            htmlContent += `<a href="${data.url || '#'}" target="_blank" class="other-feature-item"><div class="other-feature-icon"><img src="${data.image}" class="product-icon-img" onerror="this.src='https://nasukafoods.site/gambarkosong.jpg'"></div><span>${data.nama}</span></a>`;
        });
        container.innerHTML = htmlContent;
    });
}

$(document).ready(() => {
    showHome();
    loadDynamicSponsors(); 
    loadDynamicPartners();
    $('#tabPencapaian').on('click', function() { $('.profil-tab-item').removeClass('active'); $(this).addClass('active'); $('#contentPencapaian').show(); $('#contentPerbaikan').hide(); });
    $('#tabPerbaikan').on('click', function() { $('.profil-tab-item').removeClass('active'); $(this).addClass('active'); $('#contentPencapaian').hide(); $('#contentPerbaikan').show(); });
});
</script>
</body>
</html>
