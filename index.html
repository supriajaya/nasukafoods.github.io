<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nasuka Foods</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
  
     
    <link rel="stylesheet" href="https://nasukafoods.site/cuss.css">

    <style>
        /* Definisikan keyframes untuk animasi berkedip */
        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }

        /* Terapkan animasi berkedip ke teks di dalam marquee */
        #blinking-text {
            animation: blinker 1s linear infinite; /* Animasi berjalan setiap 1 detik, berulang tak terbatas */
            color: #ffffff; /* Menggunakan warna putih agar menonjol di banner */
            font-size: 14px; /* Ukuran font opsional */
            font-weight: 700;
            text-shadow: 0 0 5px #000; /* Opsional: sedikit bayangan untuk keterbacaan */
        }
        
        /* Pastikan marquee di dalam banner-text terlihat baik */
        .banner-text {
            overflow: hidden; /* Penting untuk mengontrol marquee */
            padding-right: 10px;
        }
        
        .banner-text marquee {
            width: 100%;
            line-height: 1.2; 
        }
    </style>
       
</head>
<body>
    
<div class="container">
    
    <div id="home-container" style="display: block;">
        
        <div class="header">
            <div class="header-content">
                <div class="top-nav">
                    <span class="welcome">Nasuka Foods<br></span> 
                    <div class="help-center" id="Profil">
                        <i class="fas fa-user"></i>
                        <span id="userNameDisplay">...</span> </div>
                </div>
            </div>
        </div>

        <div class="balance-card">
            <div class="balance-title">Saldo</div>
            <div class="balance-details">
                <span class="balance-amount" id="SaldoAmountDisplay">...</span> <i class="fas fa-mobile-alt balance-icon" onclick="showDownload()"></i>
            </div>
            <div class="all-accounts">
                <span>Tarik dana</span>
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>

        <div class="main-features">
            <a href="https://nasukafoods.site/giveaway.html" target="_blank" class="feature-link">
                <div class="feature-icon-circle transfer-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <span>Give Away</span>
            </a>
            
            <div class="feature-item" onclick="showVideo()">
                <div class="feature-icon-circle briva-icon">
                    <i class="fas fa-video"></i>
                </div>
                <span>Video</span>
            </div>
            
            <a href="" target="_blank" class="feature-link">
                <div class="feature-icon-circle pdam-icon">
                    <i class="fas fa-plus"></i> 
                </div>
                <span>Saldo</span>
            </a>
            
            <a href="https://nasukafoods.site/posisi-mang-cilok.html" target="_blank" class="feature-link">
                <div class="feature-icon-circle pulsa-icon" style="overflow: hidden; padding: 0;">
                    <img src="https://nasukafoods.site/lacak-lokasi.gif" alt="Lacak Lokasi" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                </div>
                <span>Lihat Posisi</span>
            </a>
            </div>

        <div class="banner">
            <div class="banner-text">
                <marquee behavior="scroll" direction="left" scrollamount="5" style="white-space: nowrap;">
                    <span id="blinking-text">
                        <strong>Gratis Ongkos Kirim Secibaduyut Raya âœ¨</strong>
                    </span>
                </marquee>
            </div>
          
        </div>
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <span>Produk</span>
        </div>

        <div class="other-features">
            <div class="other-feature-item" onclick="showPayment(' Cilok Premium', 'Cilok dengan kualitas terbaik, rasa original gurih.', 900, ['https://nasukafoods.site/cilokpro.jpg'], 'Isi 1 biji.')">
                <div class="other-feature-icon top-up-icon">
                    <img src="https://nasukafoods.site/cilokpro.jpg" alt="cilok 1" class="product-icon-img">
                </div>
                <span>Rp 900</span>
            </div>
            
            
            <div class="other-feature-item" onclick="showPayment('Paket Hemat ', 'Paket hemat diskon 20%.', 44000, ['https://nasukafoods.site/cilokpro.jpg'], 'Isi 50 Pcs.')">
                <div class="other-feature-icon brizzi-icon">
                    <img src="https://nasukafoods.site/cilokpro.jpg" alt="Paket hemat" class="product-icon-img">
                </div>
                <span>Rp 44.000</span>
            </div>
            <div class="other-feature-item" onclick="showPayment('Cilok Premium: Paket Keluarga', 'Porsi besar untuk acara keluarga.', 87000, ['https://nasukafoods.site/cilokpro.jpg'], 'Isi 100 pc. Promo terbatas!')">
                <div class="other-feature-icon tagihan-icon">
                    <img src="https://nasukafoods.site/cilokpro.jpg" alt="Paket premium" class="product-icon-img">
                </div>
                <span>Rp 87.000</span>
            </div>
            <div class="other-feature-item" onclick="showPayment('Paket Sultan', 'Cilok frozen siap masak untuk stok di rumah, Cilok isian gajih berkualitas super, isi 1000 pcs', 850000, ['https://nasukafoods.site/cilokpro.jpg'], 'Gratis ongkos kirim seluruh kota bandung.')">
                <div class="other-feature-icon setor-tarik-icon">
                    <img src="https://nasukafoods.site/cilokpro.jpg" alt="Sultan" class="product-icon-img">
                </div>
                <span>Rp 850.000</span>
            </div>
            </div>
            
              <div class="search-bar" id="marquee-search-bar">
                <i class="fas fa-search"></i>
                <div class="marquee-content">
                    <span id="running-text"></span>
                </div>
            </div>
        </div> 
        
 <div class="other-features">
            
            <div class="other-feature-item">
                <div class="other-feature-icon lifestyle-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <span>Kado</span>
            </div>
            
            <a href="https://nasukafoods.site/test-giveaway.html" target="_blank" class="other-feature-item" style="text-decoration: none; color: inherit;">
                <div class="other-feature-icon virtual-icon">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <span>Simulasi</span>
            </a>
            
            <a href="https://nasukafoods.site/burung.html" target="_blank" class="other-feature-item" style="text-decoration: none; color: inherit;">
                <div class="other-feature-icon catatan-icon" style="overflow: hidden; padding: 0;">
                    <img src="https://nasukafoods.site/nasukabird.jpg" alt="Daftar" class="product-icon-img">
                </div>
                <span>Tap Bird</span>
            </a>
            
            <a href="https://nasukafoods.site/roll.html" target="_blank" class="other-feature-item" style="text-decoration: none; color: inherit;">
                <div class="other-feature-icon investasi-icon" style="overflow: hidden; padding: 0;">
                    <img src="https://nasukafoods.site/roll.jpg" alt="Masuk" class="product-icon-img">
                </div>
                <span>Roll</span>
            </a>
            
        </div>
        
        
        
        
        
        <div class="other-feature-icon investasi-icon" style="margin: 0 auto; display: block; width: 50px; height: 50px;"> 
            <i class="fas fa-chart-line"></i>
        </div>
      
        
        <div class="qris-button" onclick="showQris()"> <i class="fas fa-qrcode"></i>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="nav-home" onclick="showHome()">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" id="nav-leaderboard" onclick="showLeaderboard()">
                <img src="https://nasukafoods.site/wingbiru.gif" alt="Leaderboard" class="leaderboard-img">
                <span>Leaderboard</span>
            </div>
            <div class="nav-item">
                <i class="fas fa-list-alt"></i>
                <span>Kontak Admin</span>
            </div>
            <div class="nav-item" onclick="localStorage.getItem('ID') ? showProfil() : showLogin()">
                <i class="fas fa-user-circle"></i>
                <span>Akun</span>
            </div>
        </div>
        
        
 
            
            
            
        </div> 
   
    
    
    
    
    
    
    
    
    
    
    
    
    <div id="login-container" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo-section">
                <img src="1000362604.jpg" alt="Nasuka Foods Logo" class="auth-logo">
            </div>
            <h2>Masuk Akun Anda</h2>
            <form id="loginForm">
                <div class="auth-input-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" placeholder="Masukkan Username Anda" required>
                </div>
                <div class="auth-input-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Masukkan Password Anda" required>
                </div>
                <button type="submit" class="btn-primary">Login</button>
                <div id="loginStatus" class="auth-status"></div>
            </form>
            <div class="link-switch">Belum punya akun? <a href="#" onclick="showSignup()">Daftar di sini</a></div>
            <button onclick="showHome()" class="btn-secondary">Batal / Kembali ke Beranda</button>
        </div>
    </div>

    <div id="signup-container" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo-section">
                <img src="1000362604.jpg" alt="Nasuka Foods Logo" class="auth-logo">
            </div>
            <h2>Daftar Akun Baru</h2>
            <form id="signupForm">
                <div class="auth-input-group">
                    <label for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" placeholder="Buat Username" required>
                </div>
                <div class="auth-input-group">
                    <label for="signupNama">Nama Lengkap</label>
                    <input type="text" id="signupNama" placeholder="Nama Lengkap Anda" required>
                </div>
                <div class="auth-input-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" placeholder="Buat Password" required>
                </div>
                <button type="submit" class="btn-primary">Daftar</button>
                <div id="signupStatus" class="auth-status"></div>
            </form>
            <div class="link-switch">Sudah punya akun? <a href="#" onclick="showLogin()">Masuk di sini</a></div>
            <button onclick="showHome()" class="btn-secondary">Batal / Kembali ke Beranda</button>
        </div>
    </div>

    <div id="profil-container">
        <div class="profil-card">
            
            <div class="profil-header-nav">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3>Profil Saya</h3>
                <div>
                    <i class="fas fa-pencil-alt" onclick="showEditProfil()"></i>
                    <i class="fas fa-question-circle" style="margin-left: 15px;"></i>
                </div>
            </div>

            <div class="driver-info">
                <img id="profilFoto" class="driver-foto" src="https://nasukafoods.site/gambarkosong.jpg" alt="Foto Profil">
                <div class="driver-text">
                    <h4 id="profilNamaDriver">...</h4>
                    <div class="driver-details">
                        Gabung bulan <span id="profilBulanJoin">...</span> | 
                        <span id="profilIDPlat">...</span> 
                    </div>
                </div>
            </div>
            
            <div class="rating-section" style="padding: 10px 15px; margin-bottom: 5px; background-color: #fff8e1; border-radius: 8px; border: 1px solid #ffecb3;">
                <div style="font-size: 14px; font-weight: 600; color: #ff9800;">Saldo Anda</div>
                <div style="font-size: 20px; font-weight: 700; color: #333;" id="profilSaldoDisplay">...</div>
            </div>


            <div class="safety-report" onclick="showHistory()"> <div class="safety-report-left">
                    <div class="safety-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="safety-text">
                        Riwayat pembelian
                        <span>Lihat transaksi anda</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="rating-section" style="padding-bottom: 5px;">
                <div class="rating-breakdown" style="margin-right: 0;">
                    <div style="font-size: 10px; color: #666; margin-bottom: 5px;">Aktivitas 10 order terakhir</div>
                    <div style="font-size: 10px; color: #666; margin-bottom: 10px;">Diperbarui setiap hari</div>
                </div>
            </div>

            <div class="rating-section" style="margin-top: -10px; padding-top: 0; border-top: 1px solid #eee;">
                <div class="rating-main">
                    <div class="rating-score" id="profilRatingScore">5.00</div>
                    <div class="rating-label">Penilaian</div>
                </div>
                <div class="rating-breakdown">
                    <div class="rating-bar-row">
                        <span>5</span>
                        <div class="rating-bar"><div class="rating-fill" style="width: 100%;"></div></div>
                        <span id="ratingCount5">10</span>
                    </div>
                    <div class="rating-bar-row">
                        <span>4</span>
                        <div class="rating-bar"><div class="rating-fill" style="width: 0%;"></div></div>
                        <span id="ratingCount4">0</span>
                    </div>
                    <div class="rating-bar-row">
                        <span>3</span>
                        <div class="rating-bar"><div class="rating-fill" style="width: 0%;"></div></div>
                        <span id="ratingCount3">0</span>
                    </div>
                    <div class="rating-bar-row">
                        <span>2</span>
                        <div class="rating-bar"><div class="rating-fill" style="width: 0%;"></div></div>
                        <span id="ratingCount2">0</span>
                    </div>
                    <div class="rating-bar-row">
                        <span>1</span>
                        <div class="rating-bar"><div class="rating-fill" style="width: 0%;"></div></div>
                        <span id="ratingCount1">0</span>
                    </div>
                </div>
            </div>

            <div class="profil-tabs">
                <div class="profil-tab-item active" id="tabPencapaian">Umum</div>
                <div class="profil-tab-item" id="tabPerbaikan">Keluar</div>
            </div>

            <div id="contentPencapaian" class="tab-content-section">
                <div class="badge-section">
                    <h4>Informasi</h4>
                    <div class="badge-card">
                        <img src="https://nasukafoods.site/sayapunggu.gif" alt="Lencana" class="badge-image">
                        <div class="badge-text">
                            <strong>Alamat pengiriman</strong>
                            <span id="profilAlamatPengiriman">...</span>
                          
                        </div>
                    </div>
                </div>
                
                <div class="passenger-comments">
                    <h4>Apa Kata Anda</h4>
                    <img src="https://nasukafoods.site/pitasebar.gif" alt="Mencari Komentar" class="magnifying-glass">
                    <p style="text-align: center; color: #666; margin-top: 10px;">Belum ada kata kata untuk ditampilkan</p>
                </div>
            </div>

            <div id="contentPerbaikan" class="tab-content-section" style="display: none; text-align: center;">
                <p style="color: #666; font-style: italic;">Anda yakin ingin keluar ?.</p>
                <button id="btnLogout" class="btn-kembali" onclick="logoutUser()" style="background-color: #f44336; margin-top: 20px;">Keluar Sekarang</button>
            </div>
            
        </div>
    </div>
    <div id="editprofil-container" class="auth-container">
    </div>

    <div id="payment-container">
    </div>
    
    <div id="receipt-popup" class="auth-container">
        <div class="auth-card" style="max-width: 350px; padding: 20px; text-align: left; background: #fff;">
            <div id="receipt-content">
                </div>
            <button onclick="hideReceiptAndShowHome()" style="width: 100%; padding: 15px; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; margin-top: 20px;">
                Selesai
            </button>
        </div>
    </div>

    <div id="video-container" class="auth-container">
        <div class="video-card-modified">
            <div class="video-header">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3>Pilihan Video</h3>
            </div>
            
            <div class="video-content-section">
                <div id="video-list">
                    <p style="text-align: center; color: #666; margin-top: 20px;">Memuat video...</p>
                </div>
            </div>
            
        </div>
    </div>
    
    <div id="download-container">
        <div class="download-header">
            <i class="fas fa-arrow-left" onclick="showHome()"></i>
            Kembali
        </div>
        
        <div class="download-content">
            <div class="app-info-top">
                <img src="https://nasukafoods.site/nasukafoods.jpg" alt="App Logo" class="app-logo">
                <div class="app-text">
                    <div class="app-title">Nasuka.Apk</div>
                    <div class="app-version">Versi: 7.0.2</div>
                    <div class="app-publisher">Nasuka Wireless</div>
                </div>
            </div>
            
            <div class="app-stats">
                <div class="stat-item">
                    <div class="stat-value"><i class="fas fa-star" style="color: #ffc107;"></i> 4.9</div>
                    <div class="stat-label">Rating</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">400+</div>
                    <div class="stat-label">Ulasan</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">4 MB</div>
                    <div class="stat-label">Ukuran File</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">700+</div>
                    <div class="stat-label">Unduhan</div>
                </div>
            </div>
            
            <div class="download-description">
                <h4>Deskripsi Aplikasi</h4>
                <p>
                    Aplikasi resmi Nasuka Foods hadir untuk memudahkan Anda memesan produk favorit kami, mengumpulkan Poin, dan mendapatkan berbagai promo eksklusif. Rasakan pengalaman berbelanja Cilok dan menu lainnya dengan lebih cepat dan praktis!
                </p>
                <p>
                    <strong>Fitur Unggulan:</strong>
                    <ul>
                        <li>Pemesanan Cepat Dan Aman.</li>
                        <li>Integrasi Poin & Hadiah.</li>
                        
                        <li>Notifikasi Promo Terbaru.</li>
                    </ul>
                </p>
                
                <h4>Informasi Tambahan</h4>
                <p>
                    Diperbarui: 23 Okt 2025<br>
                    
                </p>
                <div style="height: 60px;"></div> 
            </div>
        </div>
        
        <a href="https://nasukafoods.site/nasuka.apk" target="_blank" class="download-footer-bar">
            <div>
                <div class="download-footer-text">Dapatkan versi terbaru</div>
                <div class="download-footer-version">1.0.2 â€¢ 15 Okt 2025</div>
            </div>
            <i class="fas fa-download download-footer-icon"></i>
        </a>
    </div>

    <div id="qris-container">
        <div class="qris-card-modified">
            <div class="qris-header">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3>Pembayaran QRIS</h3>
            </div>
            
            <div class="qris-content-section">
                <div class="qris-logo-section">
                    <img src="1000362604.jpg" alt="Nasuka Foods Logo" class="qris-logo">
                    <div class="qris-title">NASUKA FOODS</div>
                    <div class="qris-subtitle">Cibaduyut - Kota Bandung</div>
                </div>
                
                <div class="qris-code-box">
                    <img src="https://nasukafoods.site/aqris.jpg" alt="QRIS Code Placeholder" class="qris-code-image" id="qrisCodeImage">
                    <div class="qris-info">
                        <p style="text-align: center; font-weight: 700; color: #007bff; margin-bottom: 10px;">QUICK RESPON INDONESIAN STANDARD</p>
                        <p><strong>Merchant ID:</strong> ID2025NF001</p>
                        <p><strong>Powered by:</strong> BANK BRI</p>
                    </div>
                </div>
                
                <div class="qris-promo-section">
                    <i class="fas fa-gift"></i> &nbsp; Dapatkan diskon 5% untuk pembelian di atas 50.000 menggunakan E-Wallet!
                </div>
                
                <div class="qris-instruction-box">
                    <h4>Cara Pembayaran</h4>
                    <ul>
                        <li>Catat total nominal belanja Anda.</li>
                        <li>Buka aplikasi Bank / E-Wallet Anda (Gopay, Dana, OVO, dll.) yang mendukung QRIS.</li>
                       
                        <li>Pindai kode QRIS di atas.</li>
                        <li>Masukkan nominal yang sesuai dengan total belanja Anda.</li>
                        <li>Selesaikan pembayaran, dan konfirmasi ke admin kami.</li>
                    </ul>
                </div>
                
                <div class="qris-warning">
                    <i class="fas fa-exclamation-triangle"></i> Periksa kembali! Pastikan nama Merchant yang muncul adalah **NASUKA FOODS**.
                </div>
                
            </div>
            <div style="height: 20px;"></div> 
        </div>
    </div>
    
    <div id="leaderboard-container">
        <div class="leaderboard-card-modified">
            <div class="leaderboard-header">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3>Leaderboard</h3>
            </div>
            <div class="leaderboard-content-section">
                <div style="background-color: white; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);">
                    <img src="https://nasukafoods.site/wingbiru.gif" alt="Leaderboard Wings" style="width: 50px; height: 50px; margin-bottom: 10px;">
                    <p style="font-size: 16px; font-weight: 600; color: #007bff; margin: 0;">Peringkat 10 Besar Pelanggan Istimewa</p>
                    <p style="font-size: 14px; color: #666; margin-top: 5px;"> Best Sultan Cibaduyut!</p>
                </div>

                <div id="leaderboard-list">
                    <p style="text-align: center; color: #666; margin-top: 20px;">Leaderboard masih kosong.</p>
                </div>
            </div>
        </div>
    </div>
    </div>
    
    <div id="formal-confirmation-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 300000; justify-content: center; align-items: center;">
        <div style="background-color: white; max-width: 350px; width: 90%; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); text-align: left; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
            <h4 style="margin-top: 0; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; font-size: 18px; font-weight: 700;">
                <i class="fas fa-file-signature" style="margin-right: 8px;"></i>Persetujuan Pembayaran
            </h4>
            <p style="font-size: 14px; color: #333; line-height: 1.5; margin-bottom: 20px;">
                Saya memastikan bahwa semua detail pesanan termasuk produk, harga, dan alamat pengiriman ($$ALAMAT$$), telah diverifikasi. Dengan menekan tombol "Setuju & Bayar", Saya menyetujui pemotongan Saldo sebesar  $$JUMLAH$$ untuk pembelian $$PRODUK$$.
            </p>
            <div style="display: flex; justify-content: space-between; gap: 10px;">
                <button id="modal-cancel-btn" style="flex: 1; padding: 12px; background-color: #f44336; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Batal
                </button>
                <button id="modal-confirm-btn" style="flex: 1; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Setuju & Bayar
                </button>
            </div>
        </div>
    </div>
    
<script>
    
const firebaseConfig = {
    apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
    authDomain: "nasukafoods1.firebaseapp.com",
    databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nasukafoods1",
    messagingSenderId: "84287800896",
    appId: "1:84287800896:web:83189d6766997b00f701a5"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

const localUser = {
  Username: localStorage.getItem("Username"),
  Nama: localStorage.getItem("Nama"),
  ID: localStorage.getItem("ID"),
  Saldo: parseInt(localStorage.getItem("Saldo")) || 0,
  Alamat: localStorage.getItem("Alamat") || "Alamat belum diatur",
  NomorHP: localStorage.getItem("NomorHP") || "Nomor HP belum diatur",
  Foto: localStorage.getItem("Foto") || "https://nasukafoods.site/nasukafoods.jpg", 
};

if (localUser.ID) {
    const userRef = db.ref(`users/${localUser.ID}`);
    userRef.on('value', (snapshot) => {
      const userData = snapshot.val();
      if (userData !== null) {
        localUser.Saldo = userData.Saldo || 0;
        localUser.Alamat = userData.Alamat || "Alamat belum diatur";
        localUser.NomorHP = userData.NomorHP || "Nomor HP belum diatur";
        localUser.Foto = userData.Foto || "1000362604.jpg"; 
        localUser.Nama = userData.Nama || localUser.Nama;
        
        localStorage.setItem("Saldo", localUser.Saldo);
        localStorage.setItem("Alamat", localUser.Alamat);
        localStorage.setItem("NomorHP", localUser.NomorHP);
        localStorage.setItem("Foto", localUser.Foto);
        localStorage.setItem("Nama", localUser.Nama);
        
        updateSaldoDisplay();
      }
    });
}

function updateHomeDisplay() {
    const userNameEl = document.getElementById('userNameDisplay');
    const SaldoEl = document.getElementById('SaldoAmountDisplay');
    const welcomeEl = document.querySelector('.welcome');
    const isLoggedIn = !!localUser.ID;
    
    const navHome = document.getElementById('nav-home');
    const navLeaderboard = document.getElementById('nav-leaderboard');
    
    if (navHome) navHome.classList.add('active');
    if (navLeaderboard) navLeaderboard.classList.remove('active');

    if (!userNameEl || !SaldoEl || !welcomeEl) return;

    if (isLoggedIn) {
        const displayName = localUser.Nama ? localUser.Nama.split(' ')[0] : localUser.Username || 'Pengguna';
        
        userNameEl.textContent = displayName;
        SaldoEl.textContent = (localUser.Saldo || 0).toLocaleString('id-ID');
        
        welcomeEl.innerHTML = `Selamat Datang,<br><strong>${displayName}!</strong>`;
        
    } else {
        userNameEl.textContent = "Masuk";
        SaldoEl.textContent = "0"; 
        
        welcomeEl.innerHTML = `Nasuka Foods<br>`; 
    }
}

function updateSaldoDisplay() {
    updateHomeDisplay();
}


function initializeHome() {
  initializeUserProfile();
  updateHomeDisplay();
  
  const runningTextEl = document.getElementById('running-text');
  if (runningTextEl) {
    const marqueeEl = document.createElement('marquee');
    marqueeEl.setAttribute('behavior', 'scroll');
    marqueeEl.setAttribute('direction', 'left');
    marqueeEl.setAttribute('scrollamount', '8'); 
    marqueeEl.textContent = '----------';
    
    runningTextEl.parentNode.replaceChild(marqueeEl, runningTextEl);
  }
}

function initializeUserProfile() {
  const userID = localStorage.getItem("ID") || "";
  const profilLink = document.getElementById("Profil");
  
  
  if (!userID) {
    if (profilLink) {
      profilLink.href = "#";
      profilLink.onclick = () => { if (!localStorage.getItem('ID')) showLogin(); else showProfil(); };
    }
    return;
  }
  
  if (profilLink) {
    profilLink.href = "#";
    profilLink.onclick = showProfil;
  }

  if (!localUser.Nama) {
      fetchUserProfileFromDB(userID);
  } else {
      updateProfileDisplay(localUser.Nama, localUser.Foto, userID);
  }
}

function updateProfileDisplay(nama, foto, userID) {
  const profilLink = document.getElementById("Profil");
  if (profilLink) {
    profilLink.onclick = showProfil;
  }
  updateHomeDisplay();
}

function fetchUserProfileFromDB(userID) {
  db.ref(`users/${userID}`).once("value").then(snapshot => {
    const val = snapshot.val();
    if (val) {
      const nama = val.Nama || "Tanpa Nama";
      const foto = val.Foto || "1000362604.jpg"; 
      
      localUser.Nama = nama;
      localUser.Foto = foto;
      localUser.Alamat = val.Alamat || "Alamat belum diatur";
      localUser.NomorHP = val.NomorHP || "Nomor HP belum diatur";
      localUser.Saldo = val.Saldo || 0;
      
      localStorage.setItem("Nama", nama);
      localStorage.setItem("Foto", foto);
      localStorage.setItem("Alamat", localUser.Alamat);
      localStorage.setItem("NomorHP", localUser.NomorHP);
      localStorage.setItem("Saldo", localUser.Saldo);

      updateProfileDisplay(nama, foto, userID);
    } else {
      localUser.ID = null;
      localStorage.clear();
      updateHomeDisplay(); 
    }
  }).catch(error => {
      console.error("Error fetching user profile:", error);
      updateHomeDisplay();
  });
}

function hideAllContainers() {
    document.querySelectorAll('#home-container, #login-container, #signup-container, #profil-container, #payment-container, #editprofil-container, #receipt-popup, #video-container, #download-container, #qris-container, #leaderboard-container, #formal-confirmation-modal').forEach(el => { 
        if (el) el.style.display = 'none';
    });
}


function showHome() {
    hideAllContainers();
    const homeContainer = document.getElementById('home-container');
    if (homeContainer) {
        homeContainer.style.display = 'block';
        initializeHome();
    }
}

function showLogin() {
    hideAllContainers();
    document.getElementById('login-container').style.display = 'flex';
    document.getElementById('loginStatus').innerHTML = '';
    document.getElementById('loginForm').reset();
}

function showSignup() {
    hideAllContainers();
    document.getElementById('signup-container').style.display = 'flex';
    document.getElementById('signupStatus').innerHTML = '';
    document.getElementById('signupForm').reset();
}

function showDownload() {
    hideAllContainers();
    const downloadContainer = document.getElementById('download-container');
    if (downloadContainer) {
        downloadContainer.style.display = 'block'; 
        downloadContainer.scrollTop = 0; 
    }
}

function showQris() {
    hideAllContainers();
    const qrisContainer = document.getElementById('qris-container');
    if (qrisContainer) {
        qrisContainer.style.display = 'flex'; 
        qrisContainer.scrollTop = 0; 
    }
}

function showLeaderboard() {
    hideAllContainers();
    const leaderboardContainer = document.getElementById('leaderboard-container');
    const navLeaderboard = document.getElementById('nav-leaderboard');
    const navHome = document.getElementById('nav-home');
    
    if (leaderboardContainer) {
        leaderboardContainer.style.display = 'flex';
        leaderboardContainer.scrollTop = 0;
    }
    
    if (navLeaderboard) navLeaderboard.classList.add('active');
    if (navHome) navHome.classList.remove('active');

    const leaderboardListEl = document.getElementById('leaderboard-list');
    if (leaderboardListEl) {
        const mockLeaderboardData = [
            { rank: 1, name: "Setya Ningsih", score: 2650900 },
            { rank: 2, name: "Anipkah", score: 1965900 },
            { rank: 3, name: "Salwa Aqila", score: 1830500 },
            { rank: 4, name: "Apri Wijaya", score: 1235000 },
            { rank: 5, name: "Nanda", score: 934500 },
            { rank: 6, name: "Bambang", score: 815000 },
            { rank: 7, name: "Cicilia", score: 690000 },
            { rank: 8, name: "Rehan", score: 515500 },
            { rank: 9, name: "Amanda", score: 370900 },                
            { rank: 10, name: "Indra", score: 355000 },        
            
            
            
        ];

        let listHTML = '';
        mockLeaderboardData.forEach(item => {
            const isMe = item.name.includes('(Anda)');
            listHTML += `
                <div class="leaderboard-item" style="${isMe ? 'border: 2px solid #007bff; background-color: #e6f7ff;' : ''}">
                    <span class="leaderboard-rank">${item.rank}</span>
                    <span class="leaderboard-name" style="${isMe ? 'font-weight: 700; color: #007bff;' : ''}">${item.name}</span>
                    <span class="leaderboard-score">Rp ${item.score.toLocaleString('id-ID')}</span>
                </div>
            `;
        });
        
        if (mockLeaderboardData.length > 0) {
            leaderboardListEl.innerHTML = listHTML;
        } else {
             leaderboardListEl.innerHTML = '<p style="text-align: center; color: black; margin-top: 20px;">Belum ada data Leaderboard.</p>';
        }
    }
}
function loginUser() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const statusDiv = document.getElementById('loginStatus');
    statusDiv.className = 'auth-status';
    statusDiv.innerHTML = 'Memproses...';
    if (!username || !password) {
        statusDiv.innerHTML = 'Username dan Password wajib diisi.';
        statusDiv.classList.add('error');
        return;
    }
    db.ref("users").orderByChild("Username").equalTo(username).once("value")
        .then(snapshot => {
            const userData = snapshot.val();
            if (userData) {
                const userKey = Object.keys(userData)[0];
                const user = userData[userKey];
                if (user.Password === password) {
                    localStorage.setItem("ID", user.ID);
                    localStorage.setItem("Username", user.Username);
                    localStorage.setItem("Nama", user.Nama || 'Tanpa Nama');
                    localStorage.setItem("Saldo", user.Saldo || 0);
                    localStorage.setItem("Foto", user.Foto || "1000362604.jpg"); 
                    localStorage.setItem("Alamat", user.Alamat || "Alamat belum diatur");
                    localStorage.setItem("NomorHP", user.NomorHP || "Nomor HP belum diatur");
                    localStorage.setItem("TanggalJoin", user.TanggalJoin || new Date().toISOString());

                    localUser.ID = user.ID;
                    localUser.Username = user.Username;
                    localUser.Nama = user.Nama || 'Tanpa Nama';
                    localUser.Saldo = user.Saldo || 0;
                    localUser.Foto = user.Foto || "1000362604.jpg"; 
                    localUser.Alamat = user.Alamat || "Alamat belum diatur";
                    localUser.NomorHP = user.NomorHP || "Nomor HP belum diatur";
                    
                    statusDiv.innerHTML = 'Login Berhasil! Mengalihkan...';
                    statusDiv.classList.add('success');
                    setTimeout(showHome, 1500);
                } else {
                    statusDiv.innerHTML = 'Password salah.';
                    statusDiv.classList.add('error');
                }
            } else {
                statusDiv.innerHTML = 'Username tidak ditemukan.';
                statusDiv.classList.add('error');
            }
        })
        .catch(error => {
            statusDiv.innerHTML = 'Terjadi kesalahan saat login.';
            statusDiv.classList.add('error');
        });
}

function signupUser() {
    const username = document.getElementById('signupUsername').value.trim();
    const nama = document.getElementById('signupNama').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    const statusDiv = document.getElementById('signupStatus');
    statusDiv.className = 'auth-status';
    statusDiv.innerHTML = 'Memproses...';
    if (!username || !nama || !password) {
        statusDiv.innerHTML = 'Semua field wajib diisi.';
        statusDiv.classList.add('error');
        return;
    }
    if (username.length < 5 || password.length < 5) {
        statusDiv.innerHTML = 'Username dan Password harus minimal 5 karakter.';
        statusDiv.classList.add('error');
        return;
    }
    db.ref("users").orderByChild("Username").equalTo(username).once("value")
        .then(snapshot => {
            if (snapshot.exists()) {
                statusDiv.innerHTML = 'Username sudah digunakan. Silakan pilih yang lain.';
                statusDiv.classList.add('error');
            } else {
                const newID = db.ref().child('users').push().key;
                const newUser = {
                    ID: newID,
                    Username: username,
                    Nama: nama,
                    Password: password,
                    Saldo: 500,
                    Foto: "1000362604.jpg", 
                    Jenis: "Member",
                    Alamat: "Alamat belum diatur",
                    NomorHP: "Nomor HP belum diatur",
                    TanggalJoin: new Date().toISOString(), 
                };
                db.ref(`users/${newID}`).set(newUser)
                    .then(() => {
                        localStorage.setItem("ID", newUser.ID);
                        localStorage.setItem("Username", newUser.Username);
                        localStorage.setItem("Nama", newUser.Nama);
                        localStorage.setItem("Saldo", newUser.Saldo);
                        localStorage.setItem("Foto", newUser.Foto);
                        localStorage.setItem("Alamat", newUser.Alamat);
                        localStorage.setItem("NomorHP", newUser.NomorHP);
                        localStorage.setItem("TanggalJoin", newUser.TanggalJoin);
                        
                        localUser.ID = newUser.ID;
                        localUser.Username = newUser.Username;
                        localUser.Nama = newUser.Nama;
                        localUser.Saldo = newUser.Saldo;
                        localUser.Foto = newUser.Foto;
                        localUser.Alamat = newUser.Alamat;
                        localUser.NomorHP = newUser.NomorHP;
                        
                        statusDiv.innerHTML = 'Pendaftaran Berhasil! Anda mendapatkan 500 Saldo gratis. Mengalihkan ke Beranda...';
                        statusDiv.classList.add('success');
                        setTimeout(showHome, 1500);
                    })
                    .catch(error => {
                        statusDiv.innerHTML = 'Gagal mendaftar. Silakan coba lagi.';
                        statusDiv.classList.add('error');
                    });
            }
        })
        .catch(error => {
            statusDiv.innerHTML = 'Terjadi kesalahan sistem. Silakan coba lagi.';
            statusDiv.classList.add('error');
        });
}

function logoutUser() {
    if (confirm("Anda yakin ingin keluar?")) {
        localStorage.clear(); 
        
        localUser.ID = null;
        localUser.Username = null;
        localUser.Nama = null;
        localUser.Saldo = 0;
        localUser.Alamat = "Alamat belum diatur";
        localUser.NomorHP = "Nomor HP belum diatur";
        localUser.Foto = "1000362604.jpg"; 
        
        alert("Anda telah keluar.");
        showHome();
    }
}

function showProfil() {
    hideAllContainers();
    const userID = localStorage.getItem("ID");
    if (!userID) {
        alert("Silahkan login terlebih dahulu.");
        showLogin();
        return;
    }
    
    const profilContainer = document.getElementById('profil-container');
    profilContainer.style.display = 'block'; 
    
    document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
        item.classList.remove('active');
    });
    const navAkun = document.querySelector('.bottom-nav').lastElementChild;
    if(navAkun) navAkun.classList.add('active');


    const renderProfil = () => {
        const nama = localUser.Nama || 'Nama belum diatur';
        const foto = localUser.Foto || "1000362604.jpg"; 
        const Saldo = (localUser.Saldo || 0).toLocaleString('id-ID');
        
        const tanggalJoinISO = localStorage.getItem("TanggalJoin") || new Date().toISOString();
        const tanggalObj = new Date(tanggalJoinISO);
        const bulanJoin = tanggalObj.toLocaleString('id-ID', { month: 'short', year: 'numeric' });
        
        const displayNomorHP = localUser.NomorHP || 'Nomor HP belum diatur'; 
        
        
        document.getElementById('profilFoto').src = foto;
        document.getElementById('profilNamaDriver').textContent = nama;
        document.getElementById('profilBulanJoin').textContent = bulanJoin;
        
        
        document.getElementById('profilIDPlat').textContent = 'Nomor HP: ' + displayNomorHP; 
        
        document.getElementById('profilSaldoDisplay').textContent = Saldo + ' Saldo';
        
        const alamatPengirimanEl = document.getElementById('profilAlamatPengiriman');
        if (alamatPengirimanEl) {
            alamatPengirimanEl.textContent = localUser.Alamat || "Alamat belum diatur";
        }
        
        const safetyReport = document.querySelector('.safety-report');
        if (safetyReport) {
             safetyReport.onclick = showHistory;
        }

        
        document.getElementById('profilRatingScore').textContent = '5.00';
        document.getElementById('ratingCount5').textContent = '10';
        document.getElementById('ratingCount4').textContent = '0';
        document.getElementById('ratingCount3').textContent = '0';
        document.getElementById('ratingCount2').textContent = '0';
        document.getElementById('ratingCount1').textContent = '0';
        
        updateHomeDisplay();
    };
    
    renderProfil(); 
    
    const tabPencapaian = document.getElementById('tabPencapaian');
    const tabPerbaikan = document.getElementById('tabPerbaikan');
    const contentPencapaian = document.getElementById('contentPencapaian');
    const contentPerbaikan = document.getElementById('contentPerbaikan');
    
    const switchTab = (activeTab) => {
        tabPencapaian.classList.remove('active');
        tabPerbaikan.classList.remove('active');
        contentPencapaian.style.display = 'none';
        contentPerbaikan.style.display = 'none';

        if (activeTab === 'pencapaian') {
            tabPencapaian.classList.add('active');
            contentPencapaian.style.display = 'block';
             if (contentPencapaian.querySelector('#history-list')) {
                contentPencapaian.innerHTML = `
                    <div class="badge-section">
                        <h4>Informasi</h4>
                        <div class="badge-card">
                            <img src="1000362604.jpg" alt="Lencana" class="badge-image">
                            <div class="badge-text">
                                <strong>Alamat pengiriman</strong>
                                <span id="profilAlamatPengiriman">${localUser.Alamat || "Alamat belum diatur"}</span>
                            </div>
                        </div>
                    </div>
                    <div class="passenger-comments">
                        <h4>Apa Kata Anda</h4>
                        <img src="1000362604.jpg" alt="Mencari Komentar" class="magnifying-glass">
                        <p style="text-align: center; color: #666; margin-top: 10px;">Belum ada kata kata untuk ditampilkan</p>
                    </div>
                `;
            }
        } else {
            tabPerbaikan.classList.add('active');
            contentPerbaikan.style.display = 'block';
        }
    };
    
    tabPencapaian.onclick = () => switchTab('pencapaian');
    tabPerbaikan.onclick = () => switchTab('perbaikan');
    
    switchTab('pencapaian');
}





// ... (Kode JavaScript sebelumnya)

function showHistory() {
    const contentPencapaian = document.getElementById('contentPencapaian');
    
    // Pastikan tab yang benar aktif
    document.getElementById('tabPencapaian').classList.add('active');
    document.getElementById('tabPerbaikan').classList.remove('active');

    // Kosongkan dan siapkan konten riwayat pembelian
    contentPencapaian.innerHTML = `
        <div style="text-align: center; padding: 20px;">
            <h4 style="margin-top: 0; color: #333; font-size: 16px; font-weight: 600;">Riwayat Pembelian</h4>
            <div id="history-list" style="margin-top: 15px; background-color: white; padding: 10px; border-radius: 8px;">
                <p style="color: #007bff;"><i class="fas fa-spinner fa-spin"></i> Memuat riwayat...</p>
            </div>
            <button onclick="showProfil()" style="margin-top: 20px; padding: 10px 20px; background-color: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                Kembali ke Profil
            </button>
        </div>
    `;
    
    // Ambil data transaksi dari Firebase
    db.ref(`transactions/${localUser.ID}`).orderByChild('timestamp').limitToLast(20).once('value')
        .then(snapshot => {
            const historyListEl = document.getElementById('history-list');
            historyListEl.innerHTML = ''; 
            const transactions = [];
            snapshot.forEach(childSnapshot => {
                transactions.push(childSnapshot.val());
            });
            
            if (transactions.length === 0) {
                historyListEl.innerHTML = '<p style="color: #666; font-style: italic;">Belum ada riwayat pembelian.</p>';
                return;
            }

            transactions.reverse(); // Urutkan terbaru di atas

            transactions.forEach(tx => {
                const date = new Date(tx.timestamp).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });
                const txItem = document.createElement('div');
                txItem.style.cssText = `
                    padding: 10px 0;
                    border-bottom: 1px solid #eee;
                    text-align: left;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    transition: background-color 0.1s;
                `;
                txItem.onmouseover = function() { this.style.backgroundColor = '#f9f9f9'; };
                txItem.onmouseout = function() { this.style.backgroundColor = 'white'; };
                
                // Ubah behavior onclick
                txItem.onclick = () => {
                    showReceiptPopup(tx); // Panggil fungsi baru untuk menampilkan kwitansi
                };

                txItem.innerHTML = `
                    <div>
                        <strong style="color: ${tx.status === 'Success' ? '#28a745' : '#f44336'};">${tx.productName}</strong><br>
                        <span style="font-size: 12px; color: #666;">${date} | ID: ${tx.transactionID.substring(0, 8)}...</span><br>
                        <span style="font-size: 14px; font-weight: 500;">Total: -Rp ${tx.amount.toLocaleString('id-ID')}</span>
                    </div>
                    <i class="fas fa-chevron-right" style="font-size: 12px; color: #999;"></i>
                `;
                historyListEl.appendChild(txItem);
            });
        })
        .catch(error => {
            document.getElementById('history-list').innerHTML = `<p style="color: red;">Gagal memuat riwayat: ${error.message}</p>`;
        });
}

/**
 * Menampilkan pop-up kwitansi (receipt-popup) dengan data transaksi spesifik.
 * @param {object} txData - Objek data transaksi dari Firebase.
 */
function showReceiptPopup(txData) {
    hideAllContainers();
    
    // Perlu sedikit penyesuaian data untuk memastikan format kwitansi benar
    const tempTxData = {
        ...txData,
        // Asumsi data yang disimpan di Firebase sudah lengkap, jika tidak, perlu diisi default/fallback
        initialSaldo: txData.initialSaldo || (txData.finalSaldo + txData.amount),
        deliveryAddress: txData.deliveryAddress || localUser.Alamat || 'Alamat tidak tercatat'
    };
    
    // Generate dan tampilkan HTML kwitansi
    document.getElementById('receipt-content').innerHTML = generateReceiptHTML(tempTxData);
    
    // Tampilkan pop-up
    const receiptPopup = document.getElementById('receipt-popup');
    receiptPopup.style.display = 'flex';
    
    // Ubah tombol "Selesai" di kwitansi untuk kembali ke Profil, bukan Home.
    const finishButton = receiptPopup.querySelector('button');
    if(finishButton) {
        finishButton.onclick = showProfil;
        finishButton.textContent = 'Kembali ke Riwayat';
    }
}

// ... (Sisa Kode JavaScript Anda)







function showEditProfil() {
    hideAllContainers();
    const editContainer = document.getElementById('editprofil-container');
    editContainer.style.display = 'flex'; 

    const currentUsername = localUser.Username || '';
    const currentNama = localUser.Nama || '';
    const currentNomorHP = localUser.NomorHP === 'Nomor HP belum diatur' ? '' : localUser.NomorHP; 
    const currentAlamat = localUser.Alamat === 'Alamat belum diatur' ? '' : localUser.Alamat; 
    const currentFoto = localUser.Foto || "1000362604.jpg"; 
    
    editContainer.style.position = 'fixed';
    editContainer.style.top = '0';
    editContainer.style.left = '0';
    editContainer.style.width = '100%';
    editContainer.style.height = '100%';
    editContainer.style.zIndex = '200003';
    editContainer.style.padding = '0';
    editContainer.style.backgroundColor = '#f0f2f5'; 
    editContainer.style.alignItems = 'flex-start'; 
    editContainer.style.overflowY = 'auto'; 

    editContainer.innerHTML = `
        <div class="auth-card">
            
            <div class="edit-header-nav">
                <i class="fas fa-arrow-left" onclick="showProfil()"></i>
                <h3>Edit Profil</h3>
                <i class="fas fa-question-circle"></i>
            </div>
            
            <div class="edit-profile-photo-section">
                <img id="editFotoProfil" class="edit-profile-photo" src="${currentFoto}" alt="Foto Profil">
                <div class="change-photo-text" onclick="alert('Fitur ganti foto belum tersedia.')">Ubah foto profil</div>
            </div>

            <form id="editProfilForm">
                <div class="edit-form-section">
                    <h4>Informasi Akun</h4>
                    <div class="form-group">
                        <label for="editUsername">Username</label>
                        <input type="text" id="editUsername" placeholder="Username" value="${currentUsername}" required>
                    </div>
                    <div class="form-group">
                        <label for="editNama">Nama Lengkap</label>
                        <input type="text" id="editNama" placeholder="Nama Lengkap" value="${currentNama}" required>
                    </div>
                    <div class="form-group">
                        <label for="editPassword">Password Baru (Kosongkan jika tidak ingin ganti)</label>
                        <input type="password" id="editPassword" placeholder="Password Baru">
                    </div>
                </div>

                <div class="edit-form-section">
                    <h4>Informasi Kontak & Pengiriman</h4>
                    <div class="form-group">
                        <label for="editNomorHP">Nomor HP</label>
                        <input type="text" id="editNomorHP" placeholder="Nomor HP" value="${currentNomorHP}" required>
                    </div>
                    <div class="form-group">
                        <label for="editAlamat">Alamat Pengiriman</label>
                        <textarea id="editAlamat" placeholder="Alamat Pengiriman" rows="3" required>${currentAlamat}</textarea>
                    </div>
                </div>

                <button type="submit">Simpan Perubahan</button>
                <div id="editStatus" class="auth-status" style="margin-bottom: 10px; margin-top: 0;"></div>
            </form>
            
            <div class="edit-footer-buttons" style="padding-bottom: 20px;">
                <button onclick="showProfil()" class="btn-batal">Batal</button>
               
            </div>
        </div>
    `;
    document.getElementById('editProfilForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateProfile();
    });
}

function updateProfile() {
    const userID = localUser.ID;
    const newUsername = document.getElementById('editUsername').value.trim();
    const nama = document.getElementById('editNama').value.trim();
    const nomorHP = document.getElementById('editNomorHP').value.trim();
    const alamat = document.getElementById('editAlamat').value.trim();
    const password = document.getElementById('editPassword').value.trim();
    const statusDiv = document.getElementById('editStatus');
    statusDiv.className = 'auth-status';
    statusDiv.innerHTML = 'Menyimpan...';
    
    if (!newUsername || !nama || !nomorHP || !alamat) {
        statusDiv.innerHTML = 'Username, Nama, Nomor HP, dan Alamat wajib diisi.';
        statusDiv.classList.add('error');
        return;
    }
    if (newUsername.length < 5) {
        statusDiv.innerHTML = 'Username minimal 5 karakter.';
        statusDiv.classList.add('error');
        return;
    }
    if (password && password.length < 5) {
        statusDiv.innerHTML = 'Password minimal 5 karakter.';
        statusDiv.classList.add('error');
        return;
    }

    const updates = {
        Nama: nama,
        NomorHP: nomorHP,
        Alamat: alamat
    };
    if (password) {
        updates.Password = password;
    }

    const processUpdate = () => {
        db.ref(`users/${userID}`).update(updates)
            .then(() => {
                localUser.Username = newUsername;
                localUser.Nama = nama;
                localUser.NomorHP = nomorHP;
                localUser.Alamat = alamat;
                localStorage.setItem("Username", newUsername);
                localStorage.setItem("Nama", nama);
                localStorage.setItem("NomorHP", nomorHP);
                localStorage.setItem("Alamat", alamat);
                
                statusDiv.innerHTML = 'Profil berhasil diperbarui!';
                statusDiv.classList.add('success');
                updateProfileDisplay(localUser.Nama, localUser.Foto, localUser.ID);
                setTimeout(showProfil, 1500);
            })
            .catch(error => {
                statusDiv.innerHTML = 'Gagal memperbarui profil. Silakan coba lagi.';
                statusDiv.classList.add('error');
            });
    };

    if (newUsername !== localUser.Username) {
        db.ref("users").orderByChild("Username").equalTo(newUsername).once("value")
            .then(snapshot => {
                let isTaken = false;
                snapshot.forEach(child => {
                    if (child.val().ID !== userID) {
                        isTaken = true;
                    }
                });
                if (isTaken) {
                    statusDiv.innerHTML = 'Username sudah digunakan oleh pengguna lain. Silakan pilih yang lain.';
                    statusDiv.classList.add('error');
                } else {
                    updates.Username = newUsername;
                    processUpdate();
                }
            })
            .catch(error => {
                statusDiv.innerHTML = 'Terjadi kesalahan saat memeriksa username.';
                statusDiv.classList.add('error');
            });
    } else {
        processUpdate();
    }
}


function logPurchaseToDB(productName, amount, newSaldo) {
    const userID = localUser.ID;
    if (!userID) return; 

    const transactionRef = db.ref(`transactions/${userID}`).push();
    const transactionID = transactionRef.key;
    const timestamp = new Date().toISOString();
    
    const transactionData = {
        transactionID: transactionID,
        userID: userID,
        productName: productName,
        amount: amount,
        timestamp: timestamp,
        status: 'Success',
        initialSaldo: localUser.Saldo + amount, 
        finalSaldo: newSaldo,
        deliveryAddress: localUser.Alamat,
        deliveryContact: localUser.NomorHP
    };

    transactionRef.set(transactionData)
        .then(() => {
            console.log("Transaction logged successfully with ID:", transactionID);
        })
        .catch(error => {
            console.error("Failed to log transaction:", error);
        });
        
    return transactionData;
}

function generateReceiptHTML(txData) {
    const date = new Date(txData.timestamp);
    const dateString = date.toLocaleString('id-ID', { dateStyle: 'medium' });
    const timeString = date.toLocaleString('id-ID', { timeStyle: 'short' });
    const totalSaldo = txData.amount.toLocaleString('id-ID');

    return `
        <div style="font-family: 'Courier New', Courier, monospace; font-size: 14px; color: #333; line-height: 1.4;">
            <h3 style="text-align: center; margin: 0 0 5px 0; font-size: 18px; font-weight: bold;">NASUKA FOODS</h3>
            <div style="text-align: center; margin-bottom: 15px;">Cibaduyut - Kota Bandung</div>
            <div style="border-top: 1px dashed #333; border-bottom: 1px dashed #333; padding: 10px 0; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>TGL/JAM:</span>
                    <span>${dateString} ${timeString}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>TRX ID:</span>
                    <span>${txData.transactionID.substring(0, 15)}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>PELANGGAN:</span>
                    <span>${localUser.Nama}</span>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px;">
                    <span>PRODUK</span>
                    <span>Harga</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>1 x ${txData.productName}</span>
                    <span>Rp ${totalSaldo}</span>
                </div>
            </div>

            <div style="border-top: 1px dashed #333; padding-top: 10px;">
                <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 16px;">
                    <span>Dibayar lunas:</span>
                    <span style="color: #f44336;">Rp ${totalSaldo}</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px;">
                <div style="font-weight: bold;">SISA Saldo ANDA:</div>
                <div style="font-size: 18px; color: #007bff; text-align: right; margin-top: 5px;">
                    Rp ${txData.finalSaldo.toLocaleString('id-ID')}
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px; font-size: 12px; font-style: italic;">
                Terima kasih telah berbelanja! <br> Pesanan akan dikirim ke: <br> ${txData.deliveryAddress}
            </div>
        </div>
    `;
}

function hideReceiptAndShowHome() {
    document.getElementById('receipt-popup').style.display = 'none';
    showHome();
}

// === FUNGSI BARU UNTUK MENAMPILKAN MODAL KONFIRMASI FORMAL ===
function showFormalConfirmation(amount, productName, onConfirm) {
    const modal = document.getElementById('formal-confirmation-modal');
    const userAddress = localUser.Alamat || "Alamat belum di seting";
    
    // Ambil konten paragraf dan placeholder
    const contentP = modal.querySelector('p');
    let originalHtml = `Saya memastikan bahwa semua detail pesanan termasuk produk, harga, dan alamat pengiriman ($$ALAMAT$$), telah diverifikasi. Dengan menekan tombol "Setuju & Bayar", Saya menyetujui pemotongan Saldo sebesar $$JUMLAH$$ untuk pembelian $$PRODUK$$}.`;
    
    // Ganti placeholder dengan nilai yang sebenarnya
    contentP.innerHTML = originalHtml
        .replace(/\$\$ALAMAT\$\$/g, `${userAddress}`)
        .replace(/\$\$JUMLAH\$\$/g, `Rp ${amount.toLocaleString('id-ID')}`)
        .replace(/\$\$PRODUK\$\$/g, `${productName}`);

    const confirmBtn = document.getElementById('modal-confirm-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');
    
    // Hapus event listener lama
    confirmBtn.onclick = null;
    cancelBtn.onclick = null;

    // Set event listener baru
    confirmBtn.onclick = () => {
        modal.style.display = 'none';
        onConfirm(); // Panggil fungsi pembayaran sebenarnya
    };
    cancelBtn.onclick = () => {
        modal.style.display = 'none';
        // Opsional: Beri pesan status batal di halaman pembayaran
        document.getElementById('payment-status').innerHTML = `<div class="auth-status error" style="margin-top: 0; margin-bottom: 0;">Pembayaran dibatalkan oleh pengguna.</div>`;
    };

    modal.style.display = 'flex';
}
// === AKHIR FUNGSI BARU ===


function processSaldoPayment(amount, productName) {
    const statusDiv = document.getElementById('payment-status');
    statusDiv.innerHTML = '';
    
    if (localUser.Saldo < amount) {
        statusDiv.innerHTML = `<div class="auth-status error" style="margin-top: 0; margin-bottom: 0;">Saldo Anda (Rp ${(localUser.Saldo || 0).toLocaleString('id-ID')}) tidak cukup untuk membeli ${productName} (Rp ${amount.toLocaleString('id-ID')}).</div>`;
        return;
    }
    
    // FUNGSI INTI PEMBAYARAN
    const executePayment = () => {
        const initialSaldo = localUser.Saldo;
        const newSaldo = initialSaldo - amount;
        statusDiv.innerHTML = `<div class="auth-status" style="background-color: #fff3e0; color: #ff9800; margin-top: 0; margin-bottom: 0;">Memproses pembelian...</div>`;
        
        db.ref(`users/${localUser.ID}`).update({ Saldo: newSaldo })
            .then(() => {
                localUser.Saldo = newSaldo;
                localStorage.setItem("Saldo", newSaldo);
                updateSaldoDisplay();
                
                const transactionData = logPurchaseToDB(productName, amount, newSaldo);
                
                statusDiv.innerHTML = `
                    <div class="auth-status success" style="margin-top: 0; margin-bottom: 0;">
                        Pembelian Berhasil! âœ… Menampilkan struk...
                    </div>
                `;
                
                document.getElementById('receipt-content').innerHTML = generateReceiptHTML(transactionData);
                document.getElementById('payment-container').style.display = 'none';
                document.getElementById('receipt-popup').style.display = 'flex';
    
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="auth-status error" style="margin-top: 0; margin-bottom: 0;">Pembelian gagal. Silakan coba lagi.</div>`;
            });
    };

    // Ganti konfirmasi 'confirm()' dengan modal kustom formal
    showFormalConfirmation(amount, productName, executePayment); 
}

function showPayment(productName, productDescription, productPrice, productImageUrls, manualDescription) {
    hideAllContainers();
    if (!localStorage.getItem("ID")) {
        alert("Silahkan login terlebih dahulu untuk melanjutkan pembelian.");
        showLogin();
        return;
    }
    if (localUser.Alamat === "Alamat belum diatur" || localUser.NomorHP === "Nomor HP belum diatur") {
         alert("Mohon lengkapi Alamat Pengiriman dan Nomor HP Anda di menu Edit Profil sebelum melakukan pembelian.");
         showEditProfil();
         return;
    }
    
    const userName = localUser.Nama || "Nama belum di seting";
    const userAddress = localUser.Alamat || "Alamat pengantaran belum di seting";
    const userNomorHP = localUser.NomorHP || "Nomor HP belum di seting";
    const productPriceInSaldo = productPrice; 
    const paymentContainer = document.getElementById('payment-container');
    
    paymentContainer.style.display = 'flex';
    paymentContainer.style.backgroundColor = '#f0f2f5'; 

    const imageUrl = (productImageUrls && productImageUrls.length > 0) ? productImageUrls[0] : 'https://nasukafoods.site/cilokpro.jpg';


    paymentContainer.innerHTML = `
        <div class="payment-card-modified">
            
            <div class="payment-header">
                <i class="fas fa-arrow-left" onclick="showHome()"></i>
                <h3>Detail Produk</h3>
            </div>
            
            <div class="product-image-container">
                <img src="${imageUrl}" alt="${productName}">
            </div>

            <div class="product-details-section">
                <h4>${productName}</h4>
                <div class="product-price-display">
                    Harga: Rp ${productPriceInSaldo.toLocaleString('id-ID')}
                </div>
                <p class="product-description-text">
                    ${productDescription}
                </p>
                <p class="product-keterangan-manual">
                    ${manualDescription}
                </p>
            </div>

            <div class="payment-info-section">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #333;">Info Pembeli & Pengiriman</div>
                
                <div class="info-row">
                    <span class="info-label">Pelanggan</span>
                    <span class="info-value">${userName}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Nomor HP</span>
                    <span class="info-value">${userNomorHP}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Alamat Pengiriman</span>
                    <span class="info-value address">${userAddress}</span>
                </div>
                <div class="info-row Saldo-row">
                    <span class="info-label">Saldo Anda</span>
                    <span class="info-value" style="color: #007bff;">Rp ${(localUser.Saldo || 0).toLocaleString('id-ID')}</span>
                </div>
                <div class="info-row total-bayar-row">
                    <span class="info-label" style="color: #333;">Harga yang akan di bayar</span>
                    <span class="info-value">Rp ${productPriceInSaldo.toLocaleString('id-ID')}</span>
                </div>
            </div>
            
            <div id="payment-status" style="margin: 0 15px 15px 15px;"></div>

            <div class="payment-action-section">
                <button class="btn-bayar-Saldo" onclick="processSaldoPayment(${productPriceInSaldo}, '${productName}')">
                    Bayar Rp ${productPriceInSaldo.toLocaleString('id-ID')} Sekarang
                </button>
            </div>
            
        </div>
    `;
    
}

function showVideo() {
    hideAllContainers();
    const videoContainer = document.getElementById('video-container');
    if (videoContainer) {
        videoContainer.style.display = 'flex';
    }

    const videoListEl = document.getElementById('video-list');
    if (!videoListEl) return;

    const videos = [
        { 
            title: "Nasuka Foods (Cilok Isian Gajih)", 
            uploader: "Natasya", 
            views: "2.2 Juta ", 
            videoUrl: "https://nasukafoods.site/nasukaads1.mp4", 
            posterUrl: "https://nasukafoods.site/cilokpro.jpg" 
        },
        { 
            title: "Logo", 
            uploader: "Supria", 
            views: "1.7 Juta ", 
            videoUrl: "https://nasukafoods.site/nasukaads2.mp4", 
            posterUrl: "1000362604.jpg" 
        },
        { 
            title: "Produksi", 
            uploader: "Karlina", 
            views: "1.2 Juta ", 
            videoUrl: "https://nasukafoods.site/nasukaads3.mp4", 
            posterUrl: "https://nasukafoods.site/gambarkosong.jpg" 
        }
    ];

    videoListEl.innerHTML = ''; 

    videos.forEach(video => {
        const videoItem = document.createElement('div');
        videoItem.className = 'video-item';
        
        videoItem.innerHTML = `
            <div class="video-thumbnail">
                <video controls controlslist="nodownload" poster="${video.posterUrl}">
                    <source src="${video.videoUrl}" type="video/mp4">
                    Browser Anda tidak mendukung tag video.
                </video>
            </div>
            <div class="video-details">
                <h4>${video.title}</h4>
                <p>Oleh: ${video.uploader} | ${video.views}x ditonton</p>
            </div>
        `;
        
        videoListEl.appendChild(videoItem);
    });
    
    if (videos.length === 0) {
        videoListEl.innerHTML = '<p style="text-align: center; color: #666; margin-top: 20px;">Tidak ada video untuk saat ini.</p>';
    }
}


document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    loginUser();
});
document.getElementById('signupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    signupUser();
});


$(document).ready(function() {
    showHome(); 
});
</script>

</body>
</html>
