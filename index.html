<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024">
  <title>Beranda - INDUK</title>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <link rel="stylesheet" href="https://nasukafoods.site/home.css">
  <link rel="stylesheet" href="https://nasukafoods.site/profil.css">
  
  <style>
    /* CSS specific to the home page */
    .user-search-result {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .user-profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
    }
    .profile-link {
      color: #2196F3;
      text-decoration: none;
    }
  </style>
</head>
<body class="home-bg">

<div id="home-container">
  <div style="padding:2px; text-align:center; margin-top: 10px;">
    <input id="cariUser" placeholder="Cari akun....." />
    <div id="hasilUser" style="margin-top:8px"></div>
  </div>
  
  <div class="arya-bar raya" style="position: relative;">
    <div class="profil-overlay">
      <a id="Profil" href="#">
        <img src="https://nasukafoods.site/gambarkosong.jpg" class="arya-item raya" id="Foto" />
      </a>
      <span id="Nama" class="blink-glow">Memuat....</span>
    </div>
    
    <div class="profil-overlay" style="position: relative; display: inline-flex; align-items: center; gap: 6px;">
      <img src="https://nasukafoods.site/gambarkosong.jpg" class="arya-item raya" id="fol" />
      <span></span>
      <span id="notifInbox"></span>
    </div>
    
    <div class="arya-scol">
      <div class="arya-overlay">
        <a href="#" onclick="showBurung()">
          <img src="https://nasukafoods.site/nasukabird.jpg" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/roll.jpg" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="https://nasukafoods.site/nasuka.apk"><img src="https://nasukafoods.site/download.png" /><span></span></a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showBurung()">
          <img src="https://nasukafoods.site/nasukabird.jpg" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/roll.jpg" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="https://nasukafoods.site/nasuka.apk"><img src="https://nasukafoods.site/download.png" /><span></span></a>
      </div>
    </div>
  </div>
  
  REWARD
  
  <div class="arya-bar raya" style="position: relative;">
    <div class="arya-scol">
      <div class="arya-overlay">
        <a href="#" onclick="showBurung()">
          <img src="https://nasukafoods.site/tiktokfoll.gif" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/nasukachat.png" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/nasukachat.png" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/nasukachat.png" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/nasukachat.png" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/nasukachat.png" />
        </a>
      </div>
      
      <div class="arya-overlay">
        <a href="#" onclick="showRoll()">
          <img src="https://nasukafoods.site/nasukachat.png" />
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = { apiKey: "AIzaSyASa57fEz1c31GwQ_1SR0UyLPbWOEuk8vs", authDomain: "nasukaapp.firebaseapp.com", databaseURL: "https://nasukaapp-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "nasukaapp", messagingSenderId: "853986671478", appId: "1:853986671478:web:25b1c3f0b72149c5885857" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  // These functions would be defined in a separate `fungsi-show.js` or `home.js` file
  // and need to be included here for the page to work correctly.
  function showLogin() {
    window.location.href = "login.html"; // Redirect to a separate login page
  }
  function showSignup() {
    window.location.href = "signup.html"; // Redirect to a separate signup page
  }
  function showBurung() {
    window.location.href = "burung.html"; // Redirect to the 'burung' game page
  }
  function showRoll() {
    window.location.href = "roll.html"; // Redirect to the 'roll' game page
  }
  function showProfil() {
    const userID = localStorage.getItem("ID");
    if (userID) {
        window.location.href = `profil.html?id=${userID}`; // Redirect to the user's profile page
    } else {
        showLogin();
    }
  }
  function showInbox(targetID) {
    console.log(`Navigating to inbox with target ID: ${targetID}`);
    // This is a placeholder. You would need to create an inbox page (inbox.html)
    // that can handle the targetID to display messages from that user.
    window.location.href = `inbox.html?target=${targetID}`;
  }

  function initializeHome() {
    console.log('Home page successfully loaded and initialized.');
    initializeUserProfile();
    setupChatNotifications();
    setupSearchFunctionality();
  }
  
  function initializeUserProfile() {
    const userID = localStorage.getItem("ID") || "";
    const fotoEl = document.getElementById("Profil");
    const namaEl = document.getElementById("Nama");
    const profilLink = document.getElementById("Profil");
        
    if (!userID) {
      if (namaEl) namaEl.textContent = "Silahkan Masuk";
      if (fotoEl) fotoEl.src = "https://nasukafoods.site/gambarkosong.jpg";
      if (profilLink) {
        profilLink.href = "#";
        profilLink.onclick = showLogin;
      }
      return;
    }
    
    fetchUserProfileFromDB(userID);
  }
  
  function updateProfileDisplay(nama, foto, userID) {
    const namaEl = document.getElementById("Nama");
    const fotoEl = document.getElementById("Foto");
    const profilLink = document.getElementById("Profil");
    if (namaEl) namaEl.textContent = nama;
    if (fotoEl) fotoEl.src = foto;
    
    if (profilLink) {
      profilLink.href = "#";
      profilLink.onclick = showProfil;
    }
  }
  
  function fetchUserProfileFromDB(userID) {
    db.ref("users").orderByChild("ID").equalTo(userID).once("value").then(snap => {
      let userFound = false;
      snap.forEach(child => {
        const val = child.val();
        const nama = val.Nama || "Tanpa Nama";
        const foto = val.Foto || "https://nasukafoods.site/gambarkosong.jpg";
        localStorage.setItem("Nama", nama);
        localStorage.setItem("Foto", foto);
        updateProfileDisplay(nama, foto, userID);
        userFound = true;
      });
      if (!userFound) {
        updateProfileDisplay("Tanpa Nama", "https://nasukafoods.site/gambarkosong.jpg", userID);
      }
    });
  }
  
  function setupChatNotifications() {
    const userID = localStorage.getItem("ID") || "";
    const notifInbox = document.getElementById("notifInbox");
    if (!userID || !notifInbox) return;
    
    const userChatsRef = db.ref(`users/${userID}/chats`);
    
    userChatsRef.on('value', snapshot => {
      const chats = snapshot.val() || {};
      let unreadCount = 0;
      for (const key in chats) {
        if ((chats[key].read === false || chats[key].read === undefined) && chats[key].ID !== userID) {
          unreadCount++;
        }
      }
    
      if (unreadCount > 0) {
        notifInbox.style.display = 'inline-block';
        notifInbox.textContent = unreadCount > 99 ? '99+' : unreadCount;
      } else {
        notifInbox.style.display = 'none';
        notifInbox.textContent = '';
      }
    });
    
    notifInbox.onclick = () => {
      showChatSendersList(userID);
    };
  }
  
  async function showChatSendersList(userID) {
    const snapshot = await db.ref(`users/${userID}/chats`).once('value');
    const chats = snapshot.val() || {};
    
    if (Object.keys(chats).length === 0) {
      alert('No message senders');
      return;
    }
    
    const pengirimData = [];
    for (const chatID of Object.keys(chats)) {
      const userSnap = await db.ref('users').orderByChild('ID').equalTo(chatID).once('value');
      userSnap.forEach(u => {
        const nama = u.val().Nama || 'User';
        pengirimData.push({ id: chatID, nama });
      });
    }
    
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.top = '50%';
    container.style.left = '50%';
    container.style.transform = 'translate(-50%, -50%)';
    container.style.background = '#fff';
    container.style.border = '1px solid #ccc';
    container.style.borderRadius = '8px';
    container.style.padding = '12px';
    container.style.zIndex = '9999';
    container.style.maxHeight = '300px';
    container.style.overflowY = 'auto';
    container.style.minWidth = '200px';
    container.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'x';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '6px';
    closeBtn.style.right = '6px';
    closeBtn.style.background = 'transparent';
    closeBtn.style.border = 'none';
    closeBtn.style.fontSize = '18px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.onclick = () => document.body.removeChild(container);
    container.appendChild(closeBtn);
    
    pengirimData.forEach(({ id, nama }) => {
      const btn = document.createElement('button');
      btn.textContent = nama;
      btn.style.display = 'block';
      btn.style.width = '100%';
      btn.style.margin = '6px 0';
      btn.style.padding = '8px';
      btn.style.border = 'none';
      btn.style.borderRadius = '4px';
      btn.style.background = '#2196F3';
      btn.style.color = '#fff';
      btn.style.cursor = 'pointer';
      btn.onclick = () => {
        document.body.removeChild(container);
        showInbox(id);
      };
      container.appendChild(btn);
    });
    document.body.appendChild(container);
  }
  
  function setupSearchFunctionality() {
    const hasilUserEl = document.getElementById("hasilUser");
    const cariUserInput = document.getElementById("cariUser");
    if (!cariUserInput || !hasilUserEl) return;
    cariUserInput.addEventListener("input", function() {
      const k = this.value.trim().toLowerCase();
      hasilUserEl.innerHTML = "";
      if (k.length < 2) return;
      db.ref("users").orderByChild("NamaLower").startAt(k).endAt(k + "\uf8ff").limitToFirst(10).once("value").then(snap => {
        snap.forEach(child => {
          const v = child.val();
          const d = document.createElement("div");
          d.classList.add("user-search-result");
          d.innerHTML = `
            <img src="${v.Foto || "https://nasukafoods.site/gambarkosong.jpg"}" alt="User Profile" class="user-profile-img" />
            <div class="user-info">
              <b>${v.Nama || "Tanpa Nama"}</b>
              <br />
              <a href="profil.html?id=${encodeURIComponent(v.ID)}" class="profile-link">Lihat Profil</a>
            </div>
          `;
          hasilUserEl.appendChild(d);
        });
      });
    });
  }
  
  // Call the initialization function when the page loads
  document.addEventListener('DOMContentLoaded', initializeHome);
</script>
</body>
</html>
