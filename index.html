<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nasuka</title>
  <style>
    /* (gaya CSS tidak diubah dari versi sebelumnya) */
  </style>
</head>
<body>

  <!-- (semua elemen HTML tetap seperti sebelumnya, tidak diubah) -->

  <!-- SCRIPT BARU SESUAI KODE.GS REVISI -->
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzZ-BSqSdaMcMrTZQqofVXw2dwIoYqddG5VzYe8Wz81GvCwvt1rnujzigzHBNo5hXZ5/exec';

    const guestPaymentForm = document.getElementById('guestPaymentForm');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const submitOrderButton = document.getElementById('submitOrderButton');
    const submitLoginButton = document.getElementById('submitLoginButton');
    const submitRegisterButton = document.getElementById('submitRegisterButton');
    const hiddenProductImageInput = document.getElementById('hiddenProductImage');

    guestPaymentForm.addEventListener('submit', function(event) {
      event.preventDefault();
      submitOrderButton.disabled = true;
      submitOrderButton.textContent = 'Memproses...';

      const formData = new FormData(this);
      const data = {};
      for (let [key, value] of formData.entries()) {
        if (key !== 'Bukti Pembayaran') data[key] = value;
      }

      const file = formData.get('Bukti Pembayaran');
      if (file && file instanceof File) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileData = {
            fileName: file.name,
            mimeType: file.type,
            data: btoa(e.target.result)
          };
          sendToGAS('processGuestOrder', { formData: data, fileData });
        };
        reader.readAsBinaryString(file);
      } else {
        sendToGAS('processGuestOrder', { formData: data });
      }
    });

    loginForm.addEventListener('submit', function(event) {
      event.preventDefault();
      submitLoginButton.disabled = true;
      submitLoginButton.textContent = 'Memproses...';

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      sendToGAS('loginUser', data, function(response) {
        submitLoginButton.disabled = false;
        submitLoginButton.textContent = 'Login';
        if (response.success) {
          alert('Login berhasil: ' + response.message);
          localStorage.setItem('isLoggedIn', 'true');
          localStorage.setItem('loggedInUsername', response.username);
          document.getElementById("loginModal").style.display = "none";
        } else {
          alert('Login gagal: ' + response.message);
        }
      });
    });

    registerForm.addEventListener('submit', function(event) {
      event.preventDefault();
      submitRegisterButton.disabled = true;
      submitRegisterButton.textContent = 'Memproses...';

      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      sendToGAS('registerUser', { formData: data }, function(response) {
        submitRegisterButton.disabled = false;
        submitRegisterButton.textContent = 'Daftar Sekarang';
        if (response.success) {
          alert('Pendaftaran berhasil! ' + response.message);
          registerForm.reset();
          document.getElementById("registerModal").style.display = "none";
          document.getElementById("loginModal").style.display = "block";
        } else {
          alert('Pendaftaran gagal: ' + response.message);
        }
      });
    });

    function sendToGAS(funcName, payload, callback = null) {
      const body = {
        function: funcName,
        ...payload
      };

      fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(body),
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(response => {
        if (funcName === 'processGuestOrder') {
          submitOrderButton.disabled = false;
          submitOrderButton.textContent = 'Konfirmasi Pesanan';
          if (response.success) {
            alert('Pesanan berhasil: ' + response.message);
            const orderData = { ...payload.formData };
            orderData['ID Orders'] = response.orderId;
            orderData['Tanggal'] = new Date().toLocaleString('id-ID');
            orderData['Status Pesanan'] = 'Menunggu Konfirmasi';
            orderData['Gambar Produk'] = hiddenProductImageInput.value;
            const existingOrders = JSON.parse(localStorage.getItem('guestOrders')) || [];
            existingOrders.push(orderData);
            localStorage.setItem('guestOrders', JSON.stringify(existingOrders));
            guestPaymentForm.reset();
            document.getElementById("paymentModal").style.display = "none";
            showSection('order-history');
          } else {
            alert('Gagal membuat pesanan: ' + response.message);
          }
        } else if (callback) {
          callback(response);
        }
      })
      .catch(err => {
        alert('Terjadi kesalahan saat menghubungi server: ' + err.message);
        console.error('GAS Error:', err);
        if (funcName === 'processGuestOrder') {
          submitOrderButton.disabled = false;
          submitOrderButton.textContent = 'Konfirmasi Pesanan';
        }
        if (callback) callback({ success: false, message: err.message });
      });
    }
  </script>

</body>
</html>
