<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024">
  <title>Nasuka Foods</title>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script> 
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 

  <link rel="stylesheet" href="https://nasukafoods.site/home-payment.css">
  <link rel="stylesheet" href="https://nasukafoods.site/show.css">
  
  <style>

#editprofil-container textarea {
    width: 100%;
    padding: 15px;
    margin-bottom: 15px;
    border: 2px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 24px;
    resize: vertical;
}

    .auth-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 200001;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
    }
    .auth-card {
        background: white;
        padding: 40px;
        border-radius: 15px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        text-align: center;
    }
    .auth-card h2 {
        font-size: 32px;
        margin-bottom: 20px;
        color: #333;
    }
    .auth-card input[type="text"],
    .auth-card input[type="password"] {
        width: 100%;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 24px;
    }
    .auth-card button {
        width: 100%;
        padding: 15px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 28px;
        margin-top: 10px;
        transition: background-color 0.3s;
    }
    .auth-card button:hover {
        background-color: #45a049;
    }
    .auth-card .link-switch {
        margin-top: 20px;
        font-size: 20px;
    }
    .auth-card .link-switch a {
        color: #2196F3;
        text-decoration: none;
        font-weight: bold;
    }
    .auth-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        font-size: 22px;
    }
    .auth-status.error {
        background-color: #fdd;
        color: red;
        border: 1px solid red;
    }
    .auth-status.success {
        background-color: #dfd;
        color: green;
        border: 1px solid green;
    }
    #profil-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 200002;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
    }
    .profil-card {
        background: white;
        padding: 40px;
        border-radius: 15px;
        width: 100%;
        max-width: 600px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        text-align: center;
    }
    .profil-card h2 {
        font-size: 36px;
        margin-bottom: 30px;
        color: #333;
    }
    .profil-foto {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 20px;
        border: 5px solid #4CAF50;
    }
    .profil-info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        font-size: 24px;
    }
    .profil-info-item strong {
        color: #555;
    }
    .profil-info-item span {
        font-weight: bold;
        color: #000;
    }
    .profil-info-item:last-child {
        border-bottom: none;
    }
    .profil-info-item #profilPoin {
        color: gold;
        text-shadow: 1px 1px 2px #333;
    }
    .profil-card .btn-kembali {
        margin-top: 30px;
        padding: 15px 30px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 24px;
        transition: background-color 0.3s;
    }
    .profil-card .btn-kembali:hover {
        background-color: #da190b;
    }
    .profil-card .button-group-bottom {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 20px;
    }
    .profil-card .button-group-bottom .btn-kembali,
    .profil-card .button-group-bottom #btnLogout {
        width: 50%;
        margin: 0;
    }

    #payment-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 200003;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
    }
    .payment-card {
        background: white;
        padding: 40px;
        border-radius: 15px;
        width: 100%;
        max-width: 600px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        text-align: left;
        max-height: 90vh;
        overflow-y: auto;
    }
    .payment-card p, .payment-card h3 {
        font-size: 22px;
        margin-bottom: 10px;
    }
    .payment-options button {
        width: 100%;
        padding: 15px;
        margin-bottom: 10px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 24px;
        transition: background-color 0.3s;
    }
    .payment-card .btn-kembali {
        width: 100%;
        margin-top: 15px;
        padding: 15px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 24px;
        transition: background-color 0.3s;
    }
    .product-image-slider {
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
        border-radius: 8px;
    }
    .slider-wrapper {
        display: flex;
        transition: transform 0.5s ease-in-out;
    }
    .slider-item {
        min-width: 100%;
    }
    .slider-item img {
        width: 100%;
        height: auto;
        display: block;
    }
    .slider-nav button {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
        z-index: 10;
        font-size: 20px;
    }
    .slider-nav button:first-child {
        left: 0;
    }
    .slider-nav button:last-child {
        right: 0;
    }
    .slider-dots {
        text-align: center;
        margin-top: 10px;
    }
    .slider-dot {
        height: 10px;
        width: 10px;
        margin: 0 5px;
        background-color: #bbb;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
    }
    .slider-dot.active {
        background-color: #717171;
    }


    #fixedFooter {
        position: fixed;
        bottom: 10px;
        left: 0;
        width: 100%;
        text-align: center;
        z-index: 99999;
        background: rgba(255, 255, 255, 0.8);
        padding: 5px 0;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        font-size: 20px;
    }
    #fixedFooter a {
        color: #000;
        text-decoration: none;
        margin: 0 10px;
        font-weight: bold;
    }
    #fixedFooter a:hover {
        text-decoration: underline;
    }
  </style>
</head>
<body id="gameBody" class="home-bg">
<div id="home-container">
  <div class="layanancenter"></div>
  <div class="arya-bar raya" style="position: relative;">
    <div class="profil-overlay">
      <a id="Profil" href="#" onclick="showLogin()">
        <img src="https://nasukafoods.site/gambarkosong.jpg" class="arya-item raya" id="Foto" />
      </a>
      <span id="Nama" class="blink-glow">Silahkan Masuk</span>
    </div>
       <div class="arya-overlay">
        <a href="#" onclick="">
          <img src="https://nasukafoods.site/500.png" />
        </a>
      </div>
         <div class="arya-overlay">
        <a href="#" onclick="">
          <img src="https://nasukafoods.site/1.000.png" />
        </a>
      </div>
    <div class="arya-overlay">
        <a href="#" onclick="">
          <img src="https://nasukafoods.site/5.000.png" />
        </a>
      </div>
      <div class="arya-overlay">
        <a href="#" onclick="">
          <img src="https://nasukafoods.site/10.000.png" />
        </a>
      </div>
      <div class="arya-overlay">
        <a href="#" onclick="">
          <img src="https://nasukafoods.site/20.000.png" />
        </a>
      </div>
      <div class="arya-overlay">
        <a href="#" onclick="">
          <img src="https://nasukafoods.site/40.000.png" />
        </a>
      </div>
    </div>
  <div class="arya-bar raya" style="position: relative;">
  <div class="scrolling-text">Website sedang dalam perbaikan</div>
  <div class="arya-scol">
    </div>
</div>
<h2 style="text-align: center; font-size: 15px;">GRATIS ONGKOS KIRIM SE CIBADUYUT RAYA</h2>
  <div class="product-grid">
    <div class="product-card">
      <img src="https://nasukafoods.site/nasukacilok.jpg" alt="">
      <h3>Rp 1.000</h3>
      <p>1 Pcs</p>
      <button onclick="showPayment('Cilok Isian Gajih', ' Cilok premium dengan isian gajih pilihan .', 975, ['https://nasukafoods.site/paketcilok.jpg'], 'No detail')">Detail</button>
    </div>
    <div class="product-card">
      <img src="https://nasukafoods.site/nasukacilok.jpg" alt="">
      <h3>Rp 47.500</h3>
      <p>50 pcs</p>
      <button onclick="showPayment('Cilok Lemak Sapi Premium', '50 pcs + 100 gram bumbu kacang ekslusif', 47500, ['https://nasukafoods.site/cilokisian.jpg'], 'Pesanan akan dikirim ke alamat sesuai data di akun profil anda')">Detail</button>
    </div>
    <div class="product-card">
      <img src="https://nasukafoods.site/nasukacilok.jpg" alt="">
      <h3>Rp 95.000</h3>
      <p>100 pcs</p>
      <button onclick="showPayment('Cilok ekslusif', 'Terbaik', 95000, ['https://nasukafoods.site/cilokisian.jpg'], 'Keterangan tambahan untuk 100 pcs.')">Detail</button>
    </div>
  </div>
  <div class="product-grid">
    <div class="product-card">
      <img src="https://nasukafoods.site/nasukacilok.jpg" alt="">
      <h3>Rp 460.000</h3>
      <p>500 pcs</p>
      <button onclick="showPayment('Cilok Wow', 'yang paling hard .', 460000, ['https://nasukafoods.site/paketcilok.jpg'], 'Keterangan tambahan untuk 500 pcs.')">Detail</button>
    </div>
    <div class="product-card">
         <a href="#" onclick="">
          <img src="https://nasukafoods.site/logocilok.jpg" />
        </a>
    </div>
    <div class="product-card">
      <img src="https://nasukafoods.site/nasukacilok.jpg" alt="">
      <h3>Rp 900.000</h3>
      <p>1.000 Pcs</p>
      <button onclick="showPayment('Cilok hayhay', 'Varian khusus', 900000, ['https://nasukafoods.site/cilokisian.jpg', ' https://nasukafoods.site/paketcilok.jpg'], 'Harga normal untuk 1.000 pcs adalah rp 1.000.000 tapi kita kasih diskon 10% cukup bayar Rp 900.000.')">Detail</button>
    </div>
  </div>

  <div class="product-grid" style="grid-template-columns: repeat(2, 1fr);">
    <div class="product-card" style="grid-column: span 1; padding: 0;">
      <a href="#" onclick="">
          <img src="https://nasukafoods.site/rodanasuka1.jpg" style="width: 100%; height: auto; border-radius: 8px;" alt="Roda Nasuka 1"/>
      </a>
    </div>
    <div class="product-card" style="grid-column: span 1; padding: 0;">
       <a href="#" onclick="">
          <img src="https://nasukafoods.site/nasukaroda2.jpg" style="width: 100%; height: auto; border-radius: 8px;" alt="Roda Nasuka 2"/>
       </a>
    </div>
  </div>
  </div>
<div id="editprofil-container"></div>
<div id="payment-container"></div>
<div id="rule-container"></div>
<div id="leaderboard-container"></div>
<div id="belanja-container"></div>
<div id="labirin-container"></div>
<div id="saya-container"></div>
<div id="inbox-container"></div>
<div id="pasar-container"></div>
<div id="login-container" class="auth-container">
    <div class="auth-card">
        <h2>Masuk Akun</h2>
        <form id="loginForm">
            <input type="text" id="loginUsername" placeholder="Username" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button type="submit">Masuk</button>
            <div id="loginStatus" class="auth-status"></div>
        </form>
        <p class="link-switch">Belum punya akun? <a href="#" onclick="showSignup()">Daftar Sekarang</a></p>
        <p class="link-switch"><a href="#" onclick="showHome()">Kembali ke Beranda</a></p>
    </div>
</div>
<div id="signup-container" class="auth-container">
    <div class="auth-card">
        <h2>Daftar Akun Baru</h2>
        <form id="signupForm">
            <input type="text" id="signupUsername" placeholder="Username" required>
            <input type="text" id="signupNama" placeholder="Nama Lengkap" required>
            <input type="password" id="signupPassword" placeholder="Password" required>
            <button type="submit">Daftar</button>
            <div id="signupStatus" class="auth-status"></div>
        </form>
        <p class="link-switch">Sudah punya akun? <a href="#" onclick="showLogin()">Masuk</a></p>
        <p class="link-switch"><a href="#" onclick="showHome()">Kembali ke Beranda</a></p>
    </div>
</div>
<div id="profil-container">
    <div class="profil-card">
        <h2>Profil Pengguna</h2>
        <img id="profilFoto" src="https://nasukafoods.site/gambarkosong.jpg" alt="Foto Profil" class="profil-foto">
        <div class="profil-info">
            <div class="profil-info-item">
                <strong>Nama:</strong>
                <span id="profilNama">-</span>
            </div>
            <div class="profil-info-item">
                <strong>Username:</strong>
                <span id="profilUsername">-</span>
            </div>
            <div class="profil-info-item">
                <strong>Saldo Poin:</strong>
                <span id="profilPoin">0</span>
            </div>
            <div class="profil-info-item">
                <strong>No. HP:</strong>
                <span id="profilNomorHP">-</span>
            </div>
            <div class="profil-info-item">
                <strong>Alamat Pengiriman:</strong>
                <span id="profilAlamat">-</span>
            </div>
        </div>
        <button onclick="showHome()" class="btn-kembali" style="display: none;">Kembali</button>
    </div>
</div>

<div id="fixedFooter">
    </div>


<script>

 const firebaseConfig = {
    apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpI",
    authDomain: "nasukafoods1.firebaseapp.com",
    databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nasukafoods1",
    messagingSenderId: "84287800896",
    appId: "1:84287800896:web:83189d6766997b00f701a5"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();
const localUser = {
  Username: localStorage.getItem("Username"),
  Nama: localStorage.getItem("Nama"),
  ID: localStorage.getItem("ID"),
  Poin: parseInt(localStorage.getItem("Poin")) || 0,
  Alamat: localStorage.getItem("Alamat") || "Alamat belum diatur",
  NomorHP: localStorage.getItem("NomorHP") || "Nomor HP belum diatur",
  Foto: localStorage.getItem("Foto") || "https://nasukafoods.site/gambarkosong.jpg",
};
if (!localUser.ID) {
  console.log("User ID not found in localStorage. Please log in.");
}
if (localUser.ID) {
    const userRef = db.ref(`users/${localUser.ID}`);
    userRef.on('value', (snapshot) => {
      const userData = snapshot.val();
      if (userData !== null) {
        localUser.Poin = userData.Poin || 0;
        localUser.Alamat = userData.Alamat || "Alamat belum diatur";
        localUser.NomorHP = userData.NomorHP || "Nomor HP belum diatur";
        localUser.Foto = userData.Foto || "https://nasukafoods.site/gambarkosong.jpg";
        localStorage.setItem("Poin", localUser.Poin);
        localStorage.setItem("Alamat", localUser.Alamat);
        localStorage.setItem("NomorHP", localUser.NomorHP);
        localStorage.setItem("Foto", localUser.Foto);
        updatePoinDisplay();
      }
    });
}
function updatePoinDisplay() {

}
function initializeHome() {
  console.log('Home page successfully loaded and initialized.');
  initializeUserProfile();
  setupChatNotifications();
}
function initializeUserProfile() {
  const userID = localStorage.getItem("ID") || "";
  const fotoEl = document.getElementById("Foto");
  const namaEl = document.getElementById("Nama");
  const profilLink = document.getElementById("Profil");
  if (!userID) {
    if (namaEl) namaEl.textContent = "Silahkan Masuk";
    if (fotoEl) fotoEl.src = "https://nasukafoods.site/gambarkosong.jpg";
    if (profilLink) {
      profilLink.href = "#";
      profilLink.onclick = showLogin;
    }
    return;
  }
  fetchUserProfileFromDB(userID);
}
function updateProfileDisplay(nama, foto, userID) {
  const namaEl = document.getElementById("Nama");
  const fotoEl = document.getElementById("Foto");
  const profilLink = document.getElementById("Profil");
  if (namaEl) namaEl.textContent = nama;
  if (fotoEl) fotoEl.src = foto;
  if (profilLink) {
    profilLink.href = "#";
    profilLink.onclick = showProfil;
  }
}
function fetchUserProfileFromDB(userID) {
  db.ref("users").orderByChild("ID").equalTo(userID).once("value").then(snap => {
    let userFound = false;
    snap.forEach(child => {
      const val = child.val();
      const nama = val.Nama || "Tanpa Nama";
      const foto = val.Foto || "https://nasukafoods.site/gambarkosong.jpg";
      localStorage.setItem("Nama", nama);
      localStorage.setItem("Foto", foto);
      localStorage.setItem("Alamat", val.Alamat || "Alamat belum diatur");
      localStorage.setItem("NomorHP", val.NomorHP || "Nomor HP belum diatur");
      localUser.Alamat = val.Alamat || "Alamat belum diatur";
      localUser.NomorHP = val.NomorHP || "Nomor HP belum diatur";
      localUser.Foto = foto;
      updateProfileDisplay(nama, foto, userID);
      userFound = true;
    });
    if (!userFound) {
      updateProfileDisplay("Tanpa Nama", "https://nasukafoods.site/gambarkosong.jpg", userID);
    }
  });
}
function setupChatNotifications() {
  const userID = localStorage.getItem("ID") || "";
  const notifInbox = document.getElementById("notifInbox");
  if (!userID || !notifInbox) return;
  const userChatsRef = db.ref(`users/${userID}/chats`);
  userChatsRef.on('value', snapshot => {
    const chats = snapshot.val() || {};
    let unreadCount = 0;
    for (const key in chats) {
      if ((chats[key].read === false || chats[key].read === undefined) && chats[key].ID !== userID) {
        unreadCount++;
      }
    }
    if (unreadCount > 0) {
      notifInbox.style.display = 'inline-block';
      notifInbox.textContent = unreadCount > 99 ? '99+' : unreadCount;
    } else {
      notifInbox.style.display = 'none';
      notifInbox.textContent = '';
    }
  });
  notifInbox.onclick = () => {
    showChatSendersList(userID);
  };
}
async function showChatSendersList(userID) {
  const snapshot = await db.ref(`users/${userID}/chats`).once('value');
  const chats = snapshot.val() || {};
  if (Object.keys(chats).length === 0) {
    alert('No message senders');
    return;
  }
  const pengirimData = [];
  for (const chatID of Object.keys(chats)) {
    const userSnap = await db.ref('users').orderByChild('ID').equalTo(chatID).once('value');
    userSnap.forEach(u => {
      const nama = u.val().Nama || 'User';
      pengirimData.push({ id: chatID, nama });
    });
  }
  const container = document.createElement('div');
  container.style.position = 'fixed';
  container.style.top = '50%';
  container.style.left = '50%';
  container.style.transform = 'translate(-50%, -50%)';
  container.style.background = '#fff';
  container.style.border = '1px solid #ccc';
  container.style.borderRadius = '8px';
  container.style.padding = '12px';
  container.style.zIndex = '9999';
  container.style.maxHeight = '300px';
  container.style.overflowY = 'auto';
  container.style.minWidth = '200px';
  container.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'x';
  closeBtn.style.position = 'absolute';
  closeBtn.style.top = '6px';
  closeBtn.style.right = '6px';
  closeBtn.style.background = 'transparent';
  closeBtn.style.border = 'none';
  closeBtn.style.fontSize = '18px';
  closeBtn.style.cursor = 'pointer';
  closeBtn.onclick = () => document.body.removeChild(container);
  container.appendChild(closeBtn);
  pengirimData.forEach(({ id, nama }) => {
    const btn = document.createElement('button');
    btn.textContent = nama;
    btn.style.display = 'block';
    btn.style.width = '100%';
    btn.style.margin = '6px 0';
    btn.style.padding = '8px';
    btn.style.border = 'none';
    btn.style.borderRadius = '4px';
    btn.style.background = '#2196F3';
    btn.style.color = '#fff';
    btn.style.cursor = 'pointer';
    btn.onclick = () => {
      document.body.removeChild(container);
    };
    container.appendChild(btn);
  });
  document.body.appendChild(container);
}
const urlParams = new URLSearchParams(location.search);
const viewedID = urlParams.get("id");
const currentID = localStorage.getItem("ID");
const isOwner = currentID && viewedID === currentID;
const isLoggedIn = !!currentID;
const isVisitor = !currentID;
function loadUserProfile(userID) {
    db.ref("users").orderByChild("ID").equalTo(userID).once("value").then(snap => {
        const user = Object.values(snap.val() || {})[0];
        if (user) {
            renderUser(user);
        } else {
            alert("Pengguna tidak ditemukan");
        }
    }).catch(error => {
        console.error("Gagal memuat Profile:", error);
        alert("Terjadi kesalahan saat memuat Profile.");
    });
}
function renderUser(user) {

}
function hideAllContainers() {
    document.querySelectorAll('#home-container, #login-container, #signup-container, #roll-container, #profil-container, #payment-container, #rule-container, #editprofil-container, #leaderboard-container, #belanja-container, #labirin-container, #saya-container, #inbox-container, #pasar-container, #zona1-container, #cross-container').forEach(el => {
        if (el) el.style.display = 'none';
    });
}

function processPoinPayment(amount, productName) {
    const statusDiv = document.getElementById('payment-status');
    statusDiv.innerHTML = '';
    
    if (localUser.Poin < amount) {
        statusDiv.innerHTML = `<span style="color: red; display: block; text-align: center;">Saldo Poin Anda (${localUser.Poin.toLocaleString('id-ID')}) tidak cukup untuk membeli ${productName} (${amount.toLocaleString('id-ID')} Poin).</span>`;
        return;
    }

    if (!confirm(`Anda yakin ingin membeli "${productName}" seharga ${amount.toLocaleString('id-ID')} Poin?`)) {
        return;
    }

    const newPoin = localUser.Poin - amount;
    
    statusDiv.innerHTML = `<span style="color: orange; display: block; text-align: center;">Memproses pembelian...</span>`;

    db.ref(`users/${localUser.ID}`).update({ Poin: newPoin })
        .then(() => {
            localUser.Poin = newPoin;
            localStorage.setItem("Poin", newPoin);
            updatePoinDisplay();

            statusDiv.innerHTML = `
                <span style="color: green; display: block; text-align: center; font-weight: bold;">
                    Pembelian "${productName}" Berhasil! ✅
                </span>
                <span style="display: block; text-align: center; margin-top: 10px;">
                    Poin Anda sekarang: ${newPoin.toLocaleString('id-ID')}.
                </span>
                <span style="display: block; text-align: center; margin-top: 10px; font-style: italic;">
                    Pesanan akan segera diproses dan dikirim ke alamat Anda: ${localUser.Alamat}.
                </span>
            `;
            
            setTimeout(showHome, 5000); 
        })
        .catch(error => {
            console.error("Gagal memproses pembayaran Poin:", error);
            statusDiv.innerHTML = `<span style="color: red; display: block; text-align: center;">Pembelian gagal. Silakan coba lagi.</span>`;
        });
}

function showPayment(productName, productDescription, productPrice, productImageUrls, manualDescription) {
    hideAllContainers();
    if (!localStorage.getItem("ID")) {
        alert("Silahkan login terlebih dahulu untuk melanjutkan pembelian.");
        showLogin();
        return;
    }
    const userName = localStorage.getItem("Nama") || "Nama belum di setting";
    const userAddress = localStorage.getItem("Alamat") || "Alamat pengantaran belum di seting";
    
    const productPriceInPoin = productPrice; 
    
    const paymentContainer = document.getElementById('payment-container');
    paymentContainer.style.display = 'flex';
    let sliderHtml = '';
    if (productImageUrls && productImageUrls.length > 0) {
        sliderHtml = `
            <div class="product-image-slider">
                <div class="slider-wrapper" id="productImageSliderWrapper">
                    ${productImageUrls.map(url => `<div class="slider-item"><img src="${url}" alt="${productName}"></div>`).join('')}
                </div>
                <div class="slider-nav">
                    <button onclick="prevSlide()">&lt;</button>
                    <button onclick="nextSlide()">&gt;</button>
                </div>
                <div class="slider-dots" id="sliderDots">
                    ${productImageUrls.map((_, index) => `<span class="slider-dot" onclick="currentSlide(${index})"></span>`).join('')}
                </div>
            </div>
        `;
    }
    paymentContainer.innerHTML = `
        <div class="payment-card">
            ${sliderHtml}
            <p><strong>Produk:</strong> ${productName}</p>
            <p><strong>Deskripsi:</strong> ${productDescription}</p>
            <p><strong>Harga:</strong> Rp ${Math.round(productPrice).toLocaleString('id-ID')}</p>
            <p><strong>Harga Poin:</strong> <span style="font-weight: bold; color: #ff9800;">${productPriceInPoin.toLocaleString('id-ID')} Poin</span></p>
            <p><strong>Keterangan:</strong> ${manualDescription}</p>
            <hr>
            <h3>Informasi Pengiriman</h3>
            <p><strong>Nama:</strong> ${userName}</p>
            <p><strong>Alamat:</strong> ${userAddress}</p>
            <p><strong>Saldo Poin Anda:</strong> <span style="font-weight: bold; color: gold; text-shadow: 1px 1px 1px #333;">${localUser.Poin.toLocaleString('id-ID')} Poin</span></p>
            <hr>
            <div class="payment-options">
                <button onclick="processPoinPayment(${productPriceInPoin}, '${productName}')" style="background-color: #ff9800; color: white;">Bayar dengan Poin</button>
            </div>
            <button onclick="showHome()" class="btn-kembali">Kembali ke Beranda</button>
            <div id="payment-status" style="margin-top: 15px;"></div>
        </div>
    `;
    if (productImageUrls && productImageUrls.length > 0) {
        initializeSlider(productImageUrls.length);
    }
}
let currentSlideIndex = 0;
let totalSlides = 0;
function initializeSlider(numSlides) {
    totalSlides = numSlides;
    currentSlideIndex = 0;
    updateSlider();
}
function updateSlider() {
    const sliderWrapper = document.getElementById('productImageSliderWrapper');
    const sliderDotsContainer = document.getElementById('sliderDots');
    if (sliderWrapper && sliderDotsContainer) {
        sliderWrapper.style.transform = `translateX(-${currentSlideIndex * 100}%)`;
        const dots = sliderDotsContainer.children;
        for (let i = 0; i < dots.length; i++) {
            dots[i].classList.remove('active');
        }
        if (dots[currentSlideIndex]) {
            dots[currentSlideIndex].classList.add('active');
        }
    }
}
function nextSlide() {
    currentSlideIndex = (currentSlideIndex + 1) % totalSlides;
    updateSlider();
}
function prevSlide() {
    currentSlideIndex = (currentSlideIndex - 1 + totalSlides) % totalSlides;
    updateSlider();
}
function currentSlide(index) {
    currentSlideIndex = index;
    updateSlider();
}

function showHome() {
    hideAllContainers();
    document.getElementById('home-container').style.display = 'block';
    initializeHome();
}
function logoutUser() {
    if (confirm("Anda yakin ingin keluar?")) {
        localStorage.removeItem("ID");
        localStorage.removeItem("Username");
        localStorage.removeItem("Nama");
        localStorage.removeItem("Poin");
        localStorage.removeItem("Alamat");
        localStorage.removeItem("NomorHP");
        localStorage.removeItem("Foto");

        localUser.ID = null;
        localUser.Username = null;
        localUser.Nama = null;
        localUser.Poin = 0;
        localUser.Alamat = "Alamat belum diatur";
        localUser.NomorHP = "Nomor HP belum diatur";
        localUser.Foto = "https://nasukafoods.site/gambarkosong.jpg";

        alert("Anda telah keluar.");
        showHome();
    }
}

// --- FUNGSI showProfil() YANG DIMODIFIKASI ---
function showProfil() {
    hideAllContainers();
    const userID = localStorage.getItem("ID");
    if (!userID) {
        alert("Silahkan login terlebih dahulu.");
        showLogin();
        return;
    }
    document.getElementById('profil-container').style.display = 'flex';
    
    const profilCard = document.querySelector('#profil-container .profil-card');
    
    // Fungsi untuk merender data di kartu profil
    const renderProfil = () => {
        document.getElementById('profilFoto').src = localUser.Foto || "https://nasukafoods.site/gambarkosong.jpg";
        document.getElementById('profilNama').textContent = localUser.Nama || 'Nama belum diatur';
        document.getElementById('profilUsername').textContent = localUser.Username || 'Username tidak tersedia';
        document.getElementById('profilPoin').textContent = (localUser.Poin || 0).toLocaleString('id-ID');
        document.getElementById('profilNomorHP').textContent = localUser.NomorHP || 'No. HP belum diatur';
        document.getElementById('profilAlamat').textContent = localUser.Alamat || 'Alamat belum diatur';
    };

    // Load data jika belum ada di localUser
    if (localUser.Nama) {
        renderProfil();
    } else {
        db.ref(`users/${userID}`).once("value").then(snapshot => {
            const user = snapshot.val();
            if (user) {
                // Update localUser dan localStorage
                localUser.Nama = user.Nama || 'Nama belum diatur';
                localUser.Username = user.Username || 'Username tidak tersedia';
                localUser.Poin = user.Poin || 0;
                localUser.NomorHP = user.NomorHP || 'No. HP belum diatur';
                localUser.Alamat = user.Alamat || 'Alamat belum diatur';
                localUser.Foto = user.Foto || "https://nasukafoods.site/gambarkosong.jpg";
                localStorage.setItem("Nama", localUser.Nama);
                localStorage.setItem("Poin", localUser.Poin);
                localStorage.setItem("NomorHP", localUser.NomorHP);
                localStorage.setItem("Alamat", localUser.Alamat);
                localStorage.setItem("Foto", localUser.Foto);
                renderProfil();
            } else {
                alert("Data profil tidak ditemukan.");
                showHome();
            }
        }).catch(error => {
            console.error("Gagal memuat profil:", error);
            alert("Terjadi kesalahan saat memuat data profil.");
            showHome();
        });
    }

    // 1. Hapus tombol Kembali statis jika ada (hanya untuk memastikan kerapian)
    let existingKembaliButton = profilCard.querySelector('.btn-kembali');
    if (existingKembaliButton) {
        existingKembaliButton.remove();
    }

    // 2. Buat/Update Tombol Edit Profil
    let editButton = profilCard.querySelector('#btnEditProfil');
    if (!editButton) {
        editButton = document.createElement('button');
        editButton.id = 'btnEditProfil';
        editButton.textContent = 'Edit Profil';
        // Atur gaya agar full-width dan seragam
        editButton.style.padding = '15px 30px';
        editButton.style.backgroundColor = '#2196F3';
        editButton.style.color = 'white';
        editButton.style.border = 'none';
        editButton.style.borderRadius = '8px';
        editButton.style.cursor = 'pointer';
        editButton.style.fontSize = '24px';
        editButton.style.transition = 'background-color 0.3s';
        editButton.style.marginTop = '30px';
        editButton.style.width = '100%';
        editButton.onclick = showEditProfil;
        profilCard.appendChild(editButton); 
    } else {
         // Pindahkan ke bagian bawah sebelum button-group-bottom
         editButton.style.display = 'block';
    }

    // 3. Buat/Update Grup Tombol Bawah (Kembali dan Logout)
    let buttonGroupBottom = profilCard.querySelector('.button-group-bottom');
    if (!buttonGroupBottom) {
        buttonGroupBottom = document.createElement('div');
        buttonGroupBottom.className = 'button-group-bottom';
        profilCard.appendChild(buttonGroupBottom);
    } else {
        buttonGroupBottom.innerHTML = ''; // Bersihkan konten lama
    }

    // Buat Tombol Kembali (Home)
    let newKembaliButton = document.createElement('button');
    newKembaliButton.textContent = 'Kembali';
    newKembaliButton.className = 'btn-kembali'; 
    newKembaliButton.onclick = showHome;
    newKembaliButton.style.width = '50%';
    newKembaliButton.style.margin = '0';
    newKembaliButton.style.backgroundColor = '#4CAF50'; // Warna Hijau

    // Buat Tombol Logout
    let logoutButton = document.createElement('button');
    logoutButton.id = 'btnLogout';
    logoutButton.textContent = 'Logout';
    logoutButton.className = 'btn-kembali'; 
    logoutButton.style.backgroundColor = '#f44336'; // Warna Merah
    logoutButton.onclick = logoutUser;
    logoutButton.style.width = '50%';
    logoutButton.style.margin = '0';

    // Tambahkan kedua tombol ke grup
    buttonGroupBottom.appendChild(newKembaliButton);
    buttonGroupBottom.appendChild(logoutButton);

    // Pastikan urutan di profilCard adalah: Info -> Edit -> Grup Bawah
    // Pindahkan Edit Button agar berada tepat sebelum Group Bottom (jika sudah ada sebelumnya)
    profilCard.insertBefore(editButton, buttonGroupBottom);
}
// --- AKHIR FUNGSI showProfil() YANG DIMODIFIKASI ---

// --- FUNGSI showEditProfil() YANG DIMODIFIKASI ---
function showEditProfil() {
    hideAllContainers();
    const editContainer = document.getElementById('editprofil-container');
    editContainer.style.display = 'flex';
    editContainer.style.position = 'fixed';
    editContainer.style.top = '0';
    editContainer.style.left = '0';
    editContainer.style.width = '100%';
    editContainer.style.height = '100%';
    editContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
    editContainer.style.zIndex = '200003';
    editContainer.style.justifyContent = 'center';
    editContainer.style.alignItems = 'center';
    editContainer.style.padding = '20px';
    
    // Pastikan data terbaru dari localUser digunakan
    const currentUsername = localUser.Username || '';
    const currentNama = localUser.Nama || '';
    const currentNomorHP = localUser.NomorHP === 'Nomor HP belum diatur' ? '' : localUser.NomorHP;
    const currentAlamat = localUser.Alamat === 'Alamat belum diatur' ? '' : localUser.Alamat;

    editContainer.innerHTML = `
        <div class="auth-card">
            <h2>Edit Profil</h2>
            <form id="editProfilForm">
                <input type="text" id="editUsername" placeholder="Username" value="${currentUsername}" required>
                <input type="text" id="editNama" placeholder="Nama Lengkap" value="${currentNama}" required>
                <input type="text" id="editNomorHP" placeholder="Nomor HP" value="${currentNomorHP}" required>
                <textarea id="editAlamat" placeholder="Alamat Pengiriman" rows="3" required>${currentAlamat}</textarea>
                <input type="password" id="editPassword" placeholder="Password Baru (kosongkan jika tidak ingin ganti)">
                <button type="submit">Simpan Perubahan</button>
                <div id="editStatus" class="auth-status"></div>
            </form>
            <button onclick="showProfil()" class="btn-kembali" style="margin-top: 10px; background-color: #f44336;">Batal</button>
        </div>
    `;
    document.getElementById('editProfilForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updateProfile();
    });
}

// --- FUNGSI updateProfile() YANG DIMODIFIKASI ---
function updateProfile() {
    const userID = localUser.ID;
    const newUsername = document.getElementById('editUsername').value.trim();
    const nama = document.getElementById('editNama').value.trim();
    const nomorHP = document.getElementById('editNomorHP').value.trim();
    const alamat = document.getElementById('editAlamat').value.trim();
    const password = document.getElementById('editPassword').value.trim();
    const statusDiv = document.getElementById('editStatus');
    
    statusDiv.className = 'auth-status';
    statusDiv.innerHTML = 'Menyimpan...';

    if (!newUsername || !nama || !nomorHP || !alamat) {
        statusDiv.innerHTML = 'Username, Nama, Nomor HP, dan Alamat wajib diisi.';
        statusDiv.classList.add('error');
        return;
    }

    if (newUsername.length < 5) {
        statusDiv.innerHTML = 'Username minimal 5 karakter.';
        statusDiv.classList.add('error');
        return;
    }

    if (password && password.length < 5) {
        statusDiv.innerHTML = 'Password minimal 5 karakter.';
        statusDiv.classList.add('error');
        return;
    }

    const updates = {
        Nama: nama,
        NomorHP: nomorHP,
        Alamat: alamat
    };
    if (password) {
        updates.Password = password;
    }

    const processUpdate = () => {
        db.ref(`users/${userID}`).update(updates)
            .then(() => {
                // Update local storage and local user object
                localUser.Username = newUsername;
                localUser.Nama = nama;
                localUser.NomorHP = nomorHP;
                localUser.Alamat = alamat;

                localStorage.setItem("Username", newUsername);
                localStorage.setItem("Nama", nama);
                localStorage.setItem("NomorHP", nomorHP);
                localStorage.setItem("Alamat", alamat);
                
                // Jika password diubah, Firebase sudah menanganinya, tidak perlu disimpan di localStorage

                statusDiv.innerHTML = 'Profil berhasil diperbarui!';
                statusDiv.classList.add('success');
                updateProfileDisplay(localUser.Nama, localUser.Foto, localUser.ID);
                setTimeout(showProfil, 1500);
            })
            .catch(error => {
                console.error("Update Profil Error:", error);
                statusDiv.innerHTML = 'Gagal memperbarui profil. Silakan coba lagi.';
                statusDiv.classList.add('error');
            });
    };

    // Check if Username has changed and if the new one is available
    if (newUsername !== localUser.Username) {
        db.ref("users").orderByChild("Username").equalTo(newUsername).once("value")
            .then(snapshot => {
                // Check if the new username exists AND belongs to another user
                let isTaken = false;
                snapshot.forEach(child => {
                    if (child.val().ID !== userID) {
                        isTaken = true;
                    }
                });

                if (isTaken) {
                    statusDiv.innerHTML = 'Username sudah digunakan oleh pengguna lain. Silakan pilih yang lain.';
                    statusDiv.classList.add('error');
                } else {
                    updates.Username = newUsername; // Add new username to updates object
                    processUpdate();
                }
            })
            .catch(error => {
                console.error("Check Username Error:", error);
                statusDiv.innerHTML = 'Terjadi kesalahan saat memeriksa username.';
                statusDiv.classList.add('error');
            });
    } else {
        // Username is the same, just update other fields
        processUpdate();
    }
}
// --- AKHIR FUNGSI YANG DIMODIFIKASI ---

function showLogin() {
    hideAllContainers();
    document.getElementById('login-container').style.display = 'flex';
    document.getElementById('loginStatus').innerHTML = '';
    document.getElementById('loginForm').reset();
}
function showSignup() {
    hideAllContainers();
    document.getElementById('signup-container').style.display = 'flex';
    document.getElementById('signupStatus').innerHTML = '';
    document.getElementById('signupForm').reset();
}
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    loginUser();
});
document.getElementById('signupForm').addEventListener('submit', function(e) {
    e.preventDefault();
    signupUser();
});
function loginUser() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const statusDiv = document.getElementById('loginStatus');
    statusDiv.className = 'auth-status';
    statusDiv.innerHTML = 'Memproses...';
    if (!username || !password) {
        statusDiv.innerHTML = 'Username dan Password wajib diisi.';
        statusDiv.classList.add('error');
        return;
    }
    db.ref("users").orderByChild("Username").equalTo(username).once("value")
        .then(snapshot => {
            const userData = snapshot.val();
            if (userData) {
                const userKey = Object.keys(userData)[0];
                const user = userData[userKey];
                if (user.Password === password) {
                    localStorage.setItem("ID", user.ID);
                    localStorage.setItem("Username", user.Username);
                    localStorage.setItem("Nama", user.Nama);
                    localStorage.setItem("Poin", user.Poin || 0);
                    localStorage.setItem("Foto", user.Foto || "https://nasukafoods.site/gambarkosong.jpg");
                    localStorage.setItem("Alamat", user.Alamat || "Alamat belum diatur");
                    localStorage.setItem("NomorHP", user.NomorHP || "Nomor HP belum diatur");
                    statusDiv.innerHTML = 'Login Berhasil! Mengalihkan...';
                    statusDiv.classList.add('success');
                    localUser.ID = user.ID;
                    localUser.Username = user.Username;
                    localUser.Nama = user.Nama;
                    localUser.Poin = user.Poin || 0;
                    localUser.Foto = user.Foto || "https://nasukafoods.site/gambarkosong.jpg";
                    localUser.Alamat = user.Alamat || "Alamat belum diatur";
                    localUser.NomorHP = user.NomorHP || "Nomor HP belum diatur";
                    setTimeout(showHome, 1500);
                } else {
                    statusDiv.innerHTML = 'Password salah.';
                    statusDiv.classList.add('error');
                }
            } else {
                statusDiv.innerHTML = 'Username tidak ditemukan.';
                statusDiv.classList.add('error');
            }
        })
        .catch(error => {
            console.error("Login Error:", error);
            statusDiv.innerHTML = 'Terjadi kesalahan saat login.';
            statusDiv.classList.add('error');
        });
}
function signupUser() {
    const username = document.getElementById('signupUsername').value.trim();
    const nama = document.getElementById('signupNama').value.trim();
    const password = document.getElementById('signupPassword').value.trim();
    const statusDiv = document.getElementById('signupStatus');
    statusDiv.className = 'auth-status';
    statusDiv.innerHTML = 'Memproses...';
    if (!username || !nama || !password) {
        statusDiv.innerHTML = 'Semua field wajib diisi.';
        statusDiv.classList.add('error');
        return;
    }
    if (username.length < 5 || password.length < 5) {
        statusDiv.innerHTML = 'Username dan Password harus minimal 5 karakter.';
        statusDiv.classList.add('error');
        return;
    }
    db.ref("users").orderByChild("Username").equalTo(username).once("value")
        .then(snapshot => {
            if (snapshot.exists()) {
                statusDiv.innerHTML = 'Username sudah digunakan. Silakan pilih yang lain.';
                statusDiv.classList.add('error');
            } else {
                const newID = db.ref().child('users').push().key;
                const newUser = {
                    ID: newID,
                    Username: username,
                    Nama: nama,
                    Password: password,
                    Poin: 900,
                    Foto: "https://nasukafoods.site/gambarkosong.jpg",
                    Jenis: "Member",
                    Alamat: "Alamat belum diatur",
                    NomorHP: "Nomor HP belum diatur"
                };
                db.ref(`users/${newID}`).set(newUser)
                    .then(() => {
                        localStorage.setItem("ID", newUser.ID);
                        localStorage.setItem("Username", newUser.Username);
                        localStorage.setItem("Nama", newUser.Nama);
                        localStorage.setItem("Poin", newUser.Poin);
                        localStorage.setItem("Foto", newUser.Foto);
                        localStorage.setItem("Alamat", newUser.Alamat);
                        localStorage.setItem("NomorHP", newUser.NomorHP);
                        localUser.ID = newUser.ID;
                        localUser.Username = newUser.Username;
                        localUser.Nama = newUser.Nama;
                        localUser.Poin = newUser.Poin;
                        localUser.Foto = newUser.Foto;
                        localUser.Alamat = newUser.Alamat;
                        localUser.NomorHP = newUser.NomorHP;
                        statusDiv.innerHTML = 'Pendaftaran Berhasil! Anda mendapatkan 900 Poin gratis. Mengalihkan ke Beranda...';
                        statusDiv.classList.add('success');
                        setTimeout(showHome, 1500);
                    })
                    .catch(error => {
                        console.error("Signup Error:", error);
                        statusDiv.innerHTML = 'Gagal mendaftar. Silakan coba lagi.';
                        statusDiv.classList.add('error');
                    });
            }
        })
        .catch(error => {
            console.error("Check Username Error:", error);
            statusDiv.innerHTML = 'Terjadi kesalahan sistem. Silakan coba lagi.';
            statusDiv.classList.add('error');
        });
}


$(document).ready(function() {
    initializeHome();
});
</script>
</body>
</html>
