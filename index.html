<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nasuka.apk</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      color: black;
      background-color: white;
    }

    .top-bar {
      position: fixed;
      top: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      font-size: 12px;
      z-index: 999;
      background-color: rgba(0, 0, 0, 0);
    }

    .top-bar a {
      color: white;
      text-decoration: none;
      text-align: center;
    }

    .hero-section {
      position: relative;
      height: 20vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .hero-section .hero-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }

    .promo-text,
    .info,
    .sidebar {
     position: relative;
     z-index: 1;
    }

    .info, .sidebar {
      position: absolute;
      bottom: 20px;
    }

    .info {
      left: 10px;
      color: white;
    }

    .info .location {
      font-size: 12px;
      color: #ccc;
    }

    .info .username {
      font-size: 14px;
      margin-top: 5px;
    }

    .info .balance {
        font-size: 14px;
        font-weight: bold;
        color: black;
    }

    .sidebar {
      right: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
    }

    .sidebar div {
      margin: 8px 0;
      font-size: 12px;
    }

    .product-list {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 10px;
      gap: 15px;
      margin-top: 10px;
    }

    .product-card {
      min-width: 75px;
      text-align: center;
      color: black;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
    }

    .product-image-container {
      width: 75px;
      height: 75px;
      overflow: hidden;
    }

    .product-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .product-title {
      font-size: 15.6px;
      margin-top: 6px;
    }

    .product-price {
      font-weight: bold;
      font-size: 14.1px;
      margin-top: 3px;
      color: black;
    }

    .add-to-cart-btn {
      background-color: #8B0000;
      color: white;
      border: none;
      padding: 7.5px 15px;
      font-size: 12.5px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 6px;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }

    .add-to-cart-btn:hover {
      background-color: #5e0000;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.9);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #1a1a1a;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
      color: white;
    }

    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
    }
    input, select {
        width: 100%;
        padding: 12px;
        border: 1px solid #333;
        background-color: #333;
        color: white;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
    }
    button {
        width: 100%;
        padding: 15px;
        background-color: #25D366;
        border: none;
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        border-radius: 4px;
        margin-top: 10px;
    }
    button:hover {
        background-color: #1a8a47;
    }
    .status-message {
        margin-top: 20px;
        font-weight: bold;
        text-align: center;
    }
    .error {
        color: #dc3545;
    }
    .success {
        color: #25D366;
    }
    .register-link {
        margin-top: 15px;
        font-size: 14px;
        text-align: center;
    }
    .register-link a {
        color: black;
        text-decoration: none;
    }

    .profile-info p {
        margin: 10px 0;
        padding-bottom: 5px;
        border-bottom: 1px solid #333;
    }
    .profile-info strong {
        color: black;
    }
  </style>
</head>

<body>

  <div class="top-bar" id="top-bar-links">
    </div>

  <section class="hero-section">
    <img src="https://nasukafoods.site/wireless.jpg" alt="Hero Image" class="hero-image">
    <div class="info">
      <div class="location">Jawa Barat</div>
      <div class="username" id="user-greeting">Proyek Apk</div>
      <div class="balance" id="user-balance"></div>
    </div>
    <div class="sidebar">
      <div>‚ù§Ô∏è 790.M</div>
      <div>üí¨ 427.M</div>
      <div>üîó Share</div>
    </div>
  </section>

  <div class="product-list">
    <div class="product-card">
      <a href="https://nasukafoods.site/produk-detail-1.html">
        <div class="product-image-container">
          <img class="product-image" src="https://nasukafoods.site/tiktok-viewers.png" alt="Produk 1">
        </div>
        <div class="product-title"><strong>CILOK</strong></div>
        <div class="product-price">Rp 240.000</div>
      </a>
      <button class="add-to-cart-btn" onclick="addToCart(this)">Add</button>
    </div>




    <div class="product-card">
      <a href="https://nasukafoods.site/product-detail.html">
        <div class="product-image-container">
          <img class="product-image" src="https://nasukafoods.site/paketcilok.jpg" alt="Produk 2">
        </div>
        <div class="product-title">Produk 2</div>
        <div class="product-price">Rp 75.000</div>
      </a>
      <button class="add-to-cart-btn" onclick="addToCart(this)">Add</button>
    </div>
    <div class="product-card">
      <a href="https://nasukafoods.site/product-detail.html">
        <div class="product-image-container">
          <img class="product-image" src="https://nasukafoods.site/lacak-lokasi.gif" alt="Produk 3">
        </div>
        <div class="product-title">Produk 3</div>
        <div class="product-price">Rp 120.000</div>
      </a>
      <button class="add-to-cart-btn" onclick="addToCart(this)">Add</button>
    </div>
    <div class="product-card">
      <a href="https://nasukafoods.site/product-detail.html">
        <div class="product-image-container">
          <img class="product-image" src="https://nasukafoods.site/wireless.jpg" alt="Produk 4">
        </div>
        <div class="product-title">Produk 4</div>
        <div class="product-price">Rp 45.000</div>
      </a>
      <button class="add-to-cart-btn" onclick="addToCart(this)">Add</button>
    </div>
  </div>




  <div id="topupModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeTopupModal()">&times;</span>
      <h2 style="color: black; text-align: center;">Top Up Saldo</h2>
      <form id="modalTopupForm">
        <div class="form-group">
            <label for="topupAmount">Jumlah Deposit (Rp):</label>
            <input type="number" id="topupAmount" name="JumlahDeposit" min="10000" required>
        </div>
        <div class="form-group">
            <label for="paymentMethod">Metode Pembayaran:</label>
            <select id="paymentMethod" name="MetodePembayaran" required>
                <option value="">Pilih Metode</option>
                <option value="Transfer Bank">Transfer Bank</option>
                <option value="Dana">Dana</option>
                <option value="GoPay">GoPay</option>
            </select>
        </div>
        <button type="submit" id="modalTopupButton">Ajukan Top Up</button>
      </form>
      <div id="modalTopupStatus" class="status-message"></div>
    </div>
  </div>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeProfileModal()">&times;</span>
      <h2 style="color: black; text-align: center;">Profil Pengguna</h2>
      <div class="profile-info" id="profileInfoContent">
        </div>
      <div style="text-align: center; margin-top: 20px;">
        <button onclick="logout()" style="width: auto; padding: 10px 20px; background-color: #dc3545;">Logout</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby84KGedeLwHiRBb4O0_rkzhYQh6r2-HgwtD_gcq6ubVwFy8jn_GbSxiBjctKm2b9ruZg/exec';

    function formatRupiah(number) {
        const num = parseFloat(number);
        if (isNaN(num)) {
            return 'Rp 0';
        }
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(num);
    }

    function addToCart(element) {
      const productCard = element.closest('.product-card');
      if (!productCard) return;

      const title = productCard.querySelector('.product-title').innerText;
      const price = productCard.querySelector('.product-price').innerText;
      const img = productCard.querySelector('.product-image').src;

      const product = {
          name: title,
          price: price,
          image: img,
          quantity: 1
      };

      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart.push(product);

      localStorage.setItem('cart', JSON.stringify(cart));
      alert(`${title} berhasil ditambahkan ke keranjang.`);
    }

    async function fetchUserBalance(userData) {
        const userBalanceElement = document.getElementById('user-balance');

        // Display 'Memuat saldo...' initially
        userBalanceElement.textContent = 'Memuat saldo...';

        const identifier = userData['Username'] || userData['Nomor HP'];
        const identifierType = userData['Username'] ? 'Username' : 'Nomor HP';

        if (!identifier) {
            userBalanceElement.textContent = 'Saldo: -';
            return;
        }

        try {
            const payload = new URLSearchParams({
                action: 'getUserData',
                identifier: identifier,
                identifierType: identifierType
            });

            const response = await fetch(GAS_URL + '?' + payload.toString(), {
                method: 'GET'
            });

            const result = await response.json();

            if (result.status === 'success' && result.data && result.data['Saldo'] !== undefined) {
                const latestSaldo = result.data['Saldo'];
                userBalanceElement.textContent = `Saldo: ${formatRupiah(latestSaldo)}`;

                // Update localStorage with the latest Saldo
                let updatedUserData = { ...userData,
                    'Saldo': latestSaldo
                };
                localStorage.setItem('userData', JSON.stringify(updatedUserData));
            } else {
                userBalanceElement.textContent = 'Saldo: Rp 0';
            }
        } catch (error) {
            userBalanceElement.textContent = 'Gagal memuat saldo.';
        }
    }

    function updateUIBasedOnLoginStatus() {
        const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
        const userDataString = localStorage.getItem('userData');
        const topBarLinks = document.getElementById('top-bar-links');
        const userGreeting = document.getElementById('user-greeting');
        const userBalanceElement = document.getElementById('user-balance');

        let linksHTML = '';

        if (isLoggedIn && userDataString) {
            try {
                const user = JSON.parse(userDataString);

                // Update username
                if (user['Nama Lengkap']) {
                    userGreeting.textContent = user['Nama Lengkap'];
                } else if (user['Username']) {
                    userGreeting.textContent = user['Username'];
                }

                // Call fetchUserBalance to get and display the latest saldo from the sheet
                fetchUserBalance(user);

                linksHTML = `
                    <a href="index.html">üè†<br>Home</a>
                    <a href="">üìñ<br>Riwayat</a>
                    <a href="profil-pengguna.html">üëÆ<br>Profil</a>
                    <a href="keranjang.html">üõí <br>Keranjang</a>
                `;
            } catch (e) {
                // Handle parsing errors
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('userData');




  userGreeting.textContent = 'Hai selamat datang';
  userBalanceElement.textContent = '';


                linksHTML = `
                    <a href="index.html">üè†<br>Home</a>
                    <a href="https://nasukafoods.site/login.html">üì•<br>Login</a>
                    <a href="https://nasukafoods.site/keranjang-non-member.html">üõí <br>Keranjang</a>
                `;
            }
        } else {
            // Not logged in
            userGreeting.textContent = 'Hai selamat datang';
            userBalanceElement.textContent = '';

            linksHTML = `
                <a href="index.html">üè†<br>Home</a>
                <a href="https://nasukafoods.site/login.html">üì•<br>Login</a>
                <a href="https://nasukafoods.site/keranjang-non-member.html">üõí <br>Keranjang</a>
            `;
        }

        topBarLinks.innerHTML = linksHTML;
    }

    function logout() {
        localStorage.removeItem('userLoggedIn');
        localStorage.removeItem('userData');
        localStorage.removeItem('cart');
        window.location.href = 'index.html';
    }

    const topupModal = document.getElementById('topupModal');
    const modalTopupForm = document.getElementById('modalTopupForm');
    const modalTopupButton = document.getElementById('modalTopupButton');
    const modalTopupStatus = document.getElementById('modalTopupStatus');

    function openTopupModal() {
        const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
        if (!isLoggedIn) {
            window.location.href = 'https://nasukafoods.site/login.html';
            return;
        }
        topupModal.style.display = 'block';
    }

    function closeTopupModal() {
        topupModal.style.display = 'none';
        modalTopupStatus.textContent = '';
        modalTopupButton.textContent = 'Ajukan Top Up';
        modalTopupButton.disabled = false;
        modalTopupForm.reset();
        // Refresh saldo display when closing top-up modal
        updateUIBasedOnLoginStatus();
    }

    modalTopupForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData) {
            modalTopupStatus.textContent = 'Sesi login berakhir. Silakan login kembali.';
            modalTopupStatus.classList.add('error');
            return;
        }

        modalTopupButton.disabled = true;
        modalTopupButton.textContent = 'Mengirim Permintaan...';
        modalTopupStatus.textContent = '';
        modalTopupStatus.classList.remove('success', 'error');

        const amount = document.getElementById('topupAmount').value;
        const method = document.getElementById('paymentMethod').value;
        const customerName = userData['Nama Lengkap'];
        const customerPhone = userData['Nomor HP'];

        if (!customerName || !customerPhone) {
             modalTopupStatus.textContent = 'Data pengguna tidak lengkap. Silakan perbarui profil Anda.';
             modalTopupStatus.classList.add('error');
             modalTopupButton.disabled = false;
             modalTopupButton.textContent = 'Ajukan Top Up';
             return;
        }

        const payload = new URLSearchParams({
            action: 'recordDeposit',
            Tanggal: new Date().toISOString().slice(0, 10),
            NamaPelanggan: customerName,
            NomorHP: customerPhone,
            JumlahDeposit: amount,
            MetodePembayaran: method,
            Status: 'Pending'
        });

        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: payload.toString(),
            });

            const result = await response.json();

            if (result.status === 'success') {
                modalTopupStatus.textContent = 'Pengajuan top up berhasil. Silakan lakukan transfer.';
                modalTopupStatus.classList.add('success');
            } else {
                modalTopupStatus.textContent = result.message || 'Gagal mengajukan top up.';
                modalTopupStatus.classList.add('error');
            }
        } catch (error) {
            modalTopupStatus.textContent = 'Terjadi kesalahan jaringan atau server.';
            modalTopupStatus.classList.add('error');
        } finally {
            modalTopupButton.disabled = false;
            modalTopupButton.textContent = 'Ajukan Top Up';
        }
    });

    const profileModal = document.getElementById('profileModal');
    const profileInfoContent = document.getElementById('profileInfoContent');

    function openProfileModal() {
        const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
        if (!isLoggedIn) {
            window.location.href = 'https://nasukafoods.site/login.html';
            return;
        }

        const userData = JSON.parse(localStorage.getItem('userData'));
        if (userData) {
            populateProfileInfo(userData);
            profileModal.style.display = 'block';
        } else {
            alert('Gagal memuat data profil. Silakan coba login ulang.');
            logout();
        }
    }

    function closeProfileModal() {
        profileModal.style.display = 'none';
    }

    function populateProfileInfo(user) {
        let profileHTML = '';

        profileHTML += `<p><strong>ID Pelanggan:</strong> ${user['Customers ID'] || '-'}</p>`;
        profileHTML += `<p><strong>Nama Lengkap:</strong> ${user['Nama Lengkap'] || '-'}</p>`;
        profileHTML += `<p><strong>Username:</strong> ${user['Username'] || '-'}</p>`;
        profileHTML += `<p><strong>Nomor HP:</strong> ${user['Nomor HP'] || '-'}</p>`;
        profileHTML += `<p><strong>Alamat:</strong> ${user['Alamat Lengkap'] || '-'}</p>`;
        // Use the Saldo from localStorage for the profile modal
        profileHTML += `<p><strong>Saldo:</strong> ${user['Saldo'] ? formatRupiah(user['Saldo']) : 'Rp 0'}</p>`;
        profileHTML += `<p><strong>Tentang Saya:</strong> ${user['Tentang Saya'] || '-'}</p>`;
        profileHTML += `<p><strong>Tanggal Daftar:</strong> ${user['Tanggal Daftar'] || '-'}</p>`;

        profileInfoContent.innerHTML = profileHTML;
    }

    document.addEventListener('DOMContentLoaded', updateUIBasedOnLoginStatus);
  </script>

</body>
</html>
