<!DOCTYPE html>
<html>
<head>
  <title>Lokasi Realtime Arya</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    .info {
      margin-top: 20px;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <h2>Lokasi Realtime Arya</h2>
  <div id="map"></div>
  <div class="info">
    <p>Lokasi terakhir diperbarui pada:</p>
    <p id="lastUpdateTime">Memuat...</p>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Konfigurasi Firebase Anda
    const firebaseConfig = {
      apiKey: "AIzaSyC1pLpsAE5QJv26cEudkY6FoqzEoD9KM",
      authDomain: "posisi-saya.firebaseapp.com",
      projectId: "posisi-saya",
      storageBucket: "posisi-saya.appspot.com",
      messagingSenderId: "1090605644806",
      appId: "1:1090605644806:web:7a257eee40570904135787"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const map = L.map('map').setView([0, 0], 2); // Set view awal ke 0,0 dengan zoom rendah
    let marker;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const lastUpdateTimeEl = document.getElementById('lastUpdateTime');

    // Mendengarkan perubahan data di Firestore secara realtime
    onSnapshot(doc(db, "lokasi_saya", "Arya"), (docSnapshot) => {
      if (docSnapshot.exists()) {
        const data = docSnapshot.data();
        const lat = data.lat;
        const lng = data.lng;
        const waktuString = data.waktu; // Ini adalah string ISO 8601

        // Perbarui marker peta
        if (marker) {
          marker.setLatLng([lat, lng]);
        } else {
          marker = L.marker([lat, lng]).addTo(map);
        }
        map.setView([lat, lng], 16); // Set view peta ke lokasi baru dengan zoom yang lebih dekat

        // Format dan tampilkan waktu
        if (waktuString) {
          const date = new Date(waktuString);
          const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
          const formattedDate = date.toLocaleDateString('id-ID', options); // Menggunakan locale Indonesia
          lastUpdateTimeEl.textContent = formattedDate;
        } else {
          lastUpdateTimeEl.textContent = "Data waktu tidak tersedia.";
        }

      } else {
        lastUpdateTimeEl.textContent = "Data lokasi tidak ditemukan.";
        console.log("No such document!");
      }
    }, (error) => {
      lastUpdateTimeEl.textContent = "Gagal mengambil data lokasi.";
      console.error("Error getting document:", error);
    });
  </script>
</body>
</html>
