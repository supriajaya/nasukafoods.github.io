<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Roll Game</title>
  <style>
    body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
  text-align: center;
  background-image: url('https://nasukafoods.site/matahari1.gif');
  background-size: cover;   
  background-position: top;
  background-repeat: no-repeat;
}
    #stage {
      margin: 0 auto;
      width: 600px;
      padding: 0 0 40px;
    }
    .perspective-on { perspective: 1000px; }
    .perspective-off { perspective: 0; }
    #rotate {
      margin: 0 auto;
      width: 450px;
      height: 450px;
      padding-top: 600px;
      transform-style: preserve-3d;
    }
    .ring {
      margin: 0 auto;
      height: 80px;
      width: 90px;
      float: left;
      transform-style: preserve-3d;
    }
    .roll {
      position: absolute;
      width: 90px;
      height: 80px;
      box-sizing: border-box;
      opacity: 0.9;
      color: rgba(0,0,0,0.9);
      background: #fff;
      border: solid 2px #000;
      backface-visibility: hidden;
    }
    .roll p {
      font-size: 36px;
      font-weight: bold;
      line-height: 80px;
      margin: 0;
      text-align: center;
    }
    .backface-on { backface-visibility: visible; }
    .go {
      display: block;
      margin: 0 auto 20px;
      padding:10px 30px;
      font-size: 20px;
      cursor: pointer;
    }
    label {
      cursor: pointer;
      display: inline-block;
      width: 45%;
      text-align: center;
    }
    .tilted { transform: rotateY(45deg); }
    .spin-0  { transform: rotateX(-3600deg); }
    .spin-1  { transform: rotateX(-3636deg); }
    .spin-2  { transform: rotateX(-3672deg); }
    .spin-3  { transform: rotateX(-3708deg); }
    .spin-4  { transform: rotateX(-3744deg); }
    .spin-5  { transform: rotateX(-3780deg); }
    .spin-6  { transform: rotateX(-3816deg); }
    .spin-7  { transform: rotateX(-3852deg); }
    .spin-8  { transform: rotateX(-3888deg); }
    .spin-9  { transform: rotateX(-3924deg); }

    @keyframes back-spin { 100% { transform: rotateX(36deg); } }
    @keyframes tiltin { 0% { transform: rotateY(0deg);} 50% { transform: rotateY(0deg);} 100% { transform: rotateY(45deg);} }
    @keyframes tiltout { 0% { transform: rotateY(45deg);} 100% { transform: rotateY(0deg);} }

    @keyframes spin-0  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3600deg); } }
    @keyframes spin-1  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3636deg); } }
    @keyframes spin-2  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3672deg); } }
    @keyframes spin-3  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3708deg); } }
    @keyframes spin-4  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3744deg); } }
    @keyframes spin-5  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3780deg); } }
    @keyframes spin-6  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3816deg); } }
    @keyframes spin-7  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3852deg); } }
    @keyframes spin-8  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3888deg); } }
    @keyframes spin-9  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3924deg); } }


    #perakSayaDisplay { color: silver; }

    #resultDisplay { color: #000; }
    #scoreDisplay { color: green; }
    #jumlahSpinDisplay { color: darkorange; }
    #jumlahMenangDisplay { color: blue; }
    

    #angkaOutput {
      font-size: 24px;
      margin-top: 10px;
      color: blue;
    }

    #taruhanSelect {
      font-size: 16px;
      margin-top: 10px;
      padding: 5px;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div id="stage" class="perspective-on">
    <div id="rotate">
      <div id="ring1" class="ring"></div>
      <div id="ring2" class="ring"></div>
      <div id="ring3" class="ring"></div>
      <div id="ring4" class="ring"></div>
      <div id="ring5" class="ring"></div>
    </div>
   

    <div>
      <label for="taruhanSelect">Taruhan:</label>
      <select id="taruhanSelect">
        <option value="100">100 perak</option>
        <option value="250">250 perak</option>
        <option value="500">500 perak</option>
        <option value="1000">1000 perak</option>
        <option value="1250">1250 perak</option>
        <option value="2500">2500 perak</option>
        <option value="5000">5000 perak</option>
      </select>
    </div>

    <div id="perakSayaDisplay">Perak: -</div>

    <div>
      <button class="go">SPIN BRAY</button>
    </div>
    <div>
      <label><input type="checkbox" id="xray">Mode Miring</label>
      
    </div>

   
   
  </div>

  <script>
    const username = localStorage.getItem('username');
    const gasWebAppLink = 'https://script.google.com/macros/s/AKfycbwL9L9lI4GViVClRwcGN4dg2iyqhN_bPGnuwFL5v1Q_UMp5uZqdbQJmy9LIYwG81Dqy/exec'; 

    let perakSaya = 0;

   function updatePerakDisplay() {
  $('#perakSayaDisplay').text('Perak: ' + Math.round(perakSaya).toLocaleString('id-ID'));
}

    function loadPerak() {
      const currentUsername = localStorage.getItem('username');
      if (!currentUsername) {
        $('#perakSayaDisplay').text('Perak: Tidak Cukup.');
        return;
      }
      fetch(`${gasWebAppLink}?action=getPerak&username=${encodeURIComponent(currentUsername)}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && typeof data.perak === 'number') {
            perakSaya = data.perak;
            updatePerakDisplay();
          } else {
            $('#perakSayaDisplay').text('Perak: Gagal memuat data.');
          }
        })
        .catch(() => {
          $('#perakSayaDisplay').text('Perak: Error memuat.');
        });
    }

    function updatePerakOnServer(changeAmount) {
      const currentUsername = localStorage.getItem('username');
      if (!currentUsername) return;
      const payload = {
        action: 'updatePerak',
        username: currentUsername,
        changeAmount: changeAmount
      };
      fetch(gasWebAppLink, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(payload).toString()
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && typeof data.perak === 'number') {
            perakSaya = data.perak;
            updatePerakDisplay();
          } else {
            alert('Gagal mengupdate perak Anda: ' + (data.message || 'Unknown error.'));
            loadPerak();
          }
        })
        .catch(() => {
          alert('Gagal mengupdate perak Anda. Silakan coba lagi.');
          loadPerak();
        });
    }

    const ROLL_PER_REEL = 10;
    const REEL_RADIUS = 150;
    let currentSeeds = [0, 0, 0, 0, 0];
    let score = 0;
    let totalSpins = 0;
    let totalWins = 0;
    let totalLoses = 0;

    function updateSpinDisplay() {
      $('#jumlahSpinDisplay').text('Jumlah Spin: ' + totalSpins);
      $('#jumlahMenangDisplay').text('Jumlah Kemenangan: ' + totalWins);
      
    }
    
    
function createROLL(ring) {
  const rollAngle = 360 / ROLL_PER_REEL;
  for (let i = 0; i < ROLL_PER_REEL; i++) {
    const roll = document.createElement('div');
    roll.className = 'roll';
    const transform = 'rotateX(' + (rollAngle * i) + 'deg) translateZ(' + REEL_RADIUS + 'px)';
    roll.style.transform = transform;
    
    // Display the number directly as text within the roll div
    const p = document.createElement('p');
    p.textContent = i;
    roll.appendChild(p);

    ring.append(roll);
  }
}
    


    function getSeed(base = null) {
      const spinNum = totalSpins + 1;
      let chance = 0;

      if (spinNum <= 10) chance = 0.30;
      else if (spinNum <= 20) chance = 0.40;
      else if (spinNum <= 35) chance = 0.5;
      else if (spinNum <= 75) chance = 0.35;
      else if (spinNum <= 100) chance = 0.2;
      else if (spinNum <= 101) chance = 1.00;

      if (chance > 0 && Math.random() < chance) {
        if (base !== null) return base;
      }
      return Math.floor(Math.random() * ROLL_PER_REEL);
    }

    function spin(timer) {
      const taruhan = parseFloat($('#taruhanSelect').val());

      if (isNaN(taruhan) || taruhan <= 0) {
        alert('Jumlah taruhan tidak valid. Masukkan angka positif.');
        return;
      }

      if (perakSaya < taruhan) {
        alert('Perak tidak cukup! Saldo Anda: ' + perakSaya.toFixed(2));
        return;
      }

      $('.go').prop('disabled', true).text('Menggulir...');
      perakSaya -= taruhan;
      updatePerakDisplay();

      const winningSeed = getSeed();

      for (let i = 1; i <= 5; i++) {
        let oldSeed = -1;
        const oldClass = $('#ring' + i).attr('class');
        if (oldClass && oldClass.length > 4) {
          oldSeed = parseInt(oldClass.slice(10));
        }

        let seed = getSeed(winningSeed);
        while (oldSeed === seed) {
          seed = getSeed(winningSeed);
        }

        currentSeeds[i - 1] = seed;
        $('#ring' + i)
          .css('animation', 'back-spin 1s, spin-' + seed + ' ' + (timer + i * 0.5) + 's')
          .attr('class', 'ring spin-' + seed);
      }

      setTimeout(() => {
        const hasil = currentSeeds;
        $('#angkaOutput').text('Angka keluar: ' + hasil.join(' '));

        const count = {};
        for (let angka of hasil) {
          count[angka] = (count[angka] || 0) + 1;
        }

        let menang = false;
        let perakHadiah = 0;
        let pesanRoll = '';

        if (Object.values(count).some(v => v === 5)) {
          perakHadiah = taruhan * 5;
          pesanRoll = '5 ANGKA SAMA! ðŸŽ‰';
          menang = true;
        } else if (Object.values(count).some(v => v === 4)) {
          perakHadiah = taruhan * 3;
          pesanRoll = '4 ANGKA SAMA! ðŸŽ‰';
          menang = true;
        } else if (Object.values(count).some(v => v === 3)) {
          perakHadiah = taruhan * 1;
          pesanRoll = '3 ANGKA SAMA! ðŸŽ‰';
          menang = true;
        }

        totalSpins++;
        let perubahanPerakUntukServer = 0;

        if (menang) {
          totalWins++;
          perubahanPerakUntukServer = perakHadiah;
          $('#resultDisplay').text(`${pesanRoll} +${perakHadiah.toFixed(2)} Perak`);
        } else {
          totalLoses++;
          perubahanPerakUntukServer = -taruhan;
        
        }

        updateSpinDisplay();
        $('#scoreDisplay').text('Score: ' + score.toFixed(2));
        updatePerakOnServer(perubahanPerakUntukServer);
        $('.go').prop('disabled', false).text('ROLL SEKARANG!');
      }, (timer + 3.5) * 1000);
    }

    $(document).ready(function () {
      for (let i = 1; i <= 5; i++) {
        createROLL($('#ring' + i));
      }

      updatePerakDisplay();
      updateSpinDisplay();
      loadPerak();

      $('.go').on('click', function () {
        spin(2);
      });

      $('#xray').on('click', function () {
        const tilt = $(this).is(':checked') ? 'tiltin' : 'tiltout';
        $('#rotate').css('animation', tilt + ' 2s 1');
        setTimeout(() => {
          $('#rotate').toggleClass('tilted');
          $('.roll').toggleClass('backface-on', $(this).is(':checked'));
        }, 2000);
      });

      $('#perspective').on('click', function () {
        $('#stage').toggleClass('perspective-on perspective-off');
      });
    });
  </script>
</body>
</html>
