<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024">
  <title>Roll Game</title>
  
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>   
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://nasukafoods.site/rolli.css">
  
</head>
<body>
   Rolanges
  <div id="loading">Memuat Game...</div>
  <div id="stage" class="perspective-on">
    <div id="rotate" class="tilted">
      <div id="ring1" class="ring"></div>
      <div id="ring2" class="ring"></div>
      <div id="ring3" class="ring"></div>
      <div id="ring4" class="ring"></div>
      <div id="ring5" class="ring"></div>
    </div>
    
    <div id="numbersDisplay"></div>
    <button id="spinButton">Putar</button>
    
    <div class="betting-panel">
      <div>Rp: <span id="perakBalance">0</span></div>
      
      
      <input type="number" id="betAmount" class="bet-input" placeholder="Jumlah" min="1">
      <button id="placeBetButton" class="bet-button">Pasang</button>
      <button id="cancelBetButton" class="bet-button" disabled>Batalkan</button>
      
      <div class="auto-bet-options">
        <div id="autoBetButtons">
          <button onclick="toggleAutoBet(100)" id="autoBet100">100</button>
         
          <button onclick="toggleAutoBet(1000)" id="autoBet1000">1K</button>
          <button onclick="toggleAutoBet(10000)" id="autoBet10000">10K</button>
          <button onclick="toggleAutoBet(0)">OFF</button>
        </div>
      </div>
      
      <div id="betResult" class="result-message result-hidden"></div>
      
      <div class="win-types">
        <div class="win-type"><span>1 Pasang (2 angka sama)</span><span>x2</span></div>
        <div class="win-type"><span>2 Pasang (2x2 angka sama)</span><span>x3</span></div>
        <div class="win-type"><span>3 Angka Sama</span><span>x4</span></div>
        <div class="win-type"><span>Full House (3+2)</span><span>x5</span></div>
        <div class="win-type"><span>4 Angka Sama</span><span>6</span></div>
        <div class="win-type"><span>5 Angka Sama</span><span>x10</span></div>
      </div>
    </div>
  </div>
  
  <div class="rolling-text"><strong>Nasuka Roll, </strong></div>
  

<script>
    
  const firebaseConfig = {
    apiKey: "AIzaSyDPJfJgUg8a_e1zS3nSbU8RqHj3TOALX2s",
    authDomain: "nasuka-fc780.firebaseapp.com",
    databaseURL: "https://nasuka-fc780-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nasuka-fc780",
    messagingSenderId: "860641747257",
    appId: "1:860641747257:web:d1dc28bf34cc1f64ad48e8"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const localUser = {
    Username: localStorage.getItem("Username"),
    Nama: localStorage.getItem("Nama"),
    Perak: parseInt(localStorage.getItem("Perak")) || 0,
  };
      
  const ROLL_PER_REEL = 10;
  const REEL_RADIUS = 300;
  const TIME_TOLERANCE = 5 * 60 * 1000;
  const SPIN_DURATION = 5;
  const MANUAL_SPIN_COOLDOWN = 4 * 400;
  
  const WIN_MULTIPLIERS = {
    'pair': 2,
    'two_pairs': 3,
    'three': 4,
    'full_house': 5,
    'four': 6,
    'five': 10
  };
  
  const WIN_PROBABILITIES = {
    'pair': 0.0000001,
    'two_pairs': 0.00000001,
    'three': 0.0000000001,
    'full_house': 0.000000001,
    'four': 0.0000000000001,
    'five': 0.0000000000000000001
  };
  
  let currentSeeds = [0, 0, 0, 0, 0];
  let timeOffset = 0;
  let timeValidated = false;
  let isSpinning = false;
  let lastManualSpinTime = 0;
  let currentBet = 0;
  let hasPlacedBet = false;
  let autoBetAmount = 0;
  let isAutoBetEnabled = false;
  let playerWinStreak = 0;
  let playerLoseStreak = 0;
  let totalPlayerLoss = 0;
  let lossStreakForCompensation = 0;
  const COMPENSATION_THRESHOLD = 8;
  const COMPENSATION_MULTIPLIER = 1.2;
  const HOUSE_EDGE = 0;

  function updatePerakDisplay() {
    $('#perakBalance').text(localUser.Perak.toLocaleString('id-ID'));
    $('#lossStreakCounter').text(lossStreakForCompensation);
  }

  function createROLL(ring) {
    const rollAngle = 360 / ROLL_PER_REEL;
    for (let i = 0; i < ROLL_PER_REEL; i++) {
      const roll = document.createElement('div');
      roll.className = 'roll backface-on';
      roll.style.transform = `rotateX(${rollAngle * i}deg) translateZ(${REEL_RADIUS}px)`;
      const p = document.createElement('p');
      p.textContent = i;
      roll.appendChild(p);
      ring.append(roll);
    }
  }

  function saveRollToDatabase(result, isManual = false) {
    const now = new Date();
    const rollData = {
      numbers: result.join(''),
      timestamp: now.getTime(),
      date: now.toISOString(),
      username: localUser.Username || 'system',
      type: isManual ? 'manual' : 'auto',
      bet: hasPlacedBet ? currentBet : 0,
      lossStreak: lossStreakForCompensation,
      totalLoss: totalPlayerLoss
    };
    
    
    
    db.ref('rolls').push(rollData)
      .then(() => console.log('Roll saved to database'))
      .catch(error => console.error('Error saving roll:', error));
  }
  
  
  
  function generatePair() {
  if (Math.random() < 0.9) return generateRandomResult();
  
  const num = Math.floor(Math.random() * 10);
  return shuffleArray([num, num, 
    Math.floor(Math.random() * 10),
    Math.floor(Math.random() * 10), 
    Math.floor(Math.random() * 10)
  ]);
}


  function generateTwoPairs() {
    const num1 = Math.floor(Math.random() * 10);
    let num2;
    do {
      num2 = Math.floor(Math.random() * 10);
    } while (num2 === num1);
    
    const result = [num1, num1, num2, num2];
    
    while (result.length < 5) {
      let randNum;
      do {
        randNum = Math.floor(Math.random() * 10);
      } while (randNum === num1 || randNum === num2);
      result.push(randNum);
    }
    
    return shuffleArray(result);
  }






  function generateThreeOfAKind() {
    const num = Math.floor(Math.random() * 10);
    const result = [num, num, num];
    
    while (result.length < 5) {
      let randNum;
      do {
        randNum = Math.floor(Math.random() * 10);
      } while (randNum === num);
      result.push(randNum);
    }
    
    return shuffleArray(result);
  }






  function generateFullHouse() {
    const num1 = Math.floor(Math.random() * 10);
    let num2;
    do {
      num2 = Math.floor(Math.random() * 10);
    } while (num2 === num1);
    
    return shuffleArray([num1, num1, num1, num2, num2]);
  }





  function generateFourOfAKind() {
    const num = Math.floor(Math.random() * 10);
    const result = [num, num, num, num];
    
    while (result.length < 5) {
      let randNum;
      do {
        randNum = Math.floor(Math.random() * 10);
      } while (randNum === num);
      result.push(randNum);
    }
    
    return shuffleArray(result);
  }
  
  
  
  

  function generateFiveOfAKind() {
    const num = Math.floor(Math.random() * 10);
    return [num, num, num, num, num];
  }

  

function generateRandomResult() {
  const result = [];
  for (let i = 0; i < 5; i++) {
    let num;
    do {
      num = Math.floor(Math.random() * 10);
    } while (i < 5 && result.includes(num));
    result.push(num);
  }
  return result;
}











  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }
  
  
  
  

  function generateCompensationWin() {
    if (lossStreakForCompensation >= COMPENSATION_THRESHOLD) {
      if (Math.random() < 0.001) return generatePair();
      if (Math.random() < 0.009) return generateTwoPairs();
      return generateThreeOfAKind();
    }
    return generateRandomResult();
  }
  
  
  

  function generateControlledResult() {
    if (lossStreakForCompensation >= COMPENSATION_THRESHOLD) {
      return generateCompensationWin();
    }
    
    if (Math.random() > 0.0001) {
      return generateRandomResult();
    }
    
    const totalWinProb = Object.values(WIN_PROBABILITIES).reduce((a, b) => a + b, 0);
    const adjustedWinProb = adjustWinProbability(totalWinProb);
    const shouldForceWin = Math.random() < adjustedWinProb;
    
    if (shouldForceWin) {
      const rand = Math.random() * totalWinProb;
      let cumulativeProb = 0;
      let selectedType = null;
      
      for (const type in WIN_PROBABILITIES) {
        cumulativeProb += WIN_PROBABILITIES[type];
        if (rand <= cumulativeProb) {
          selectedType = type;
          break;
        }
      }
      
      switch(selectedType) {
        case 'pair': return generatePair();
        case 'two_pairs': return generateTwoPairs();
        case 'three': return generateThreeOfAKind();
        case 'full_house': return generateFullHouse();
        case 'four': return generateFourOfAKind();
        case 'five': return generateFiveOfAKind();
      }
    }
    
    return generateRandomResult();
  }

  function adjustWinProbability(baseProbability) {
    if (lossStreakForCompensation >= COMPENSATION_THRESHOLD) {
      return 1;
    }
    
    if (playerWinStreak > 0) {
      return baseProbability * 0.0001;
    }
    
    if (playerLoseStreak > 0) {
      return Math.min(baseProbability * (1 + (playerLoseStreak * 0.0005)), 0.0001);
    }
    
    return baseProbability;
  }

  function checkWin(result) {
    if (!hasPlacedBet || currentBet <= 0) return null;
    
    const frequency = {};
    result.forEach(num => {
      frequency[num] = (frequency[num] || 0) + 1;
    });
    
    const counts = Object.values(frequency);
    const maxCount = Math.max(...counts);
    const pairsCount = counts.filter(count => count >= 2).length;
    
    let winType = null;
    
    if (maxCount >= 5) {
      winType = 'five';
    } else if (maxCount >= 4) {
      winType = 'four';
    } else if (maxCount >= 3) {
      const hasPair = counts.some(count => count >= 2 && count < 3);
      if (hasPair && pairsCount >= 2) {
        winType = 'full_house';
      } else {
        winType = 'three';
      }
    } else if (maxCount >= 2) {
      if (pairsCount >= 2) {
        winType = 'two_pairs';
      } else {
        winType = 'pair';
      }
    }
    
    return winType;
  }

  function toggleAutoBet(amount) {
    if (amount > 0 && !isAutoBetEnabled && amount <= localUser.Perak) {
      const fee = Math.max(10, Math.floor(amount * 0.00,));
      localUser.Perak -= fee;
      localStorage.setItem("Perak", localUser.Perak);
      updatePerakDisplay();
    }
    
    autoBetAmount = amount;
    isAutoBetEnabled = amount > 0;
    
    if (isAutoBetEnabled) {
      $('#autoBetButtons button').removeClass('active');
      $(`#autoBet${amount}`).addClass('active');
      $('#betAmount').val(amount);
      placeBet(amount);
    } else {
      $('#autoBetButtons button').removeClass('active');
      cancelBet();
    }
  }

  function placeBet(amount) {
    if (amount > localUser.Perak) {
      alert('Saldo Perak tidak mencukupi');
      return false;
    }
    
    currentBet = amount;
    hasPlacedBet = true;
    $('#placeBetButton').prop('disabled', true);
    $('#cancelBetButton').prop('disabled', false);
   
    return true;
  }

  function cancelBet() {
    currentBet = 0;
    hasPlacedBet = false;
    $('#betAmount').val('');
    $('#placeBetButton').prop('disabled', false);
    $('#cancelBetButton').prop('disabled', true);
    $('#betResult').addClass('result-hidden').removeClass('win lose');
  }

  function processBetResult(result) {
    if (!hasPlacedBet) {
      if (isAutoBetEnabled) {
        placeBet(autoBetAmount);
      }
      return;
    }
    
    const winType = checkWin(result);
    let winAmount = 0;
    let message = "";
    let messageClass = "lose";
    
    if (winType) {
      let bonusMultiplier = 1;
      if (lossStreakForCompensation >= COMPENSATION_THRESHOLD) {
        bonusMultiplier = COMPENSATION_MULTIPLIER;
        message += " (Bonus Kompensasi)";
      }
      
      playerWinStreak++;
      playerLoseStreak = 0;
      const baseMultiplier = WIN_MULTIPLIERS[winType];
      const totalMultiplier = baseMultiplier * bonusMultiplier * (1 - HOUSE_EDGE);
      
      
      
      
      winAmount = Math.round(currentBet * totalMultiplier);
      
      localUser.Perak += winAmount;
      localStorage.setItem("Perak", localUser.Perak);
      
      if (lossStreakForCompensation >= COMPENSATION_THRESHOLD) {
        totalPlayerLoss = 0;
        lossStreakForCompensation = 0;
      }
      
      const winTypes = {
        'pair': '1 Pasang Angka Kembar',
        'two_pairs': '2 Pasang Angka Kembar',
        'three': '3 Angka Sama',
        'full_house': 'Full House (3+2)',
        'four': '4 Angka Sama',
        'five': '5 Angka Sama'
      };
      
      message = `MENANG! ${winTypes[winType]} (x${(totalMultiplier).toFixed(1)}): +${winAmount.toLocaleString('id-ID')} Perak`;
      messageClass = "win";
      
      saveWinToDatabase(winAmount, winType, result.join(''));
      
      
      } else {
    playerWinStreak = 0;
    playerLoseStreak++;
    lossStreakForCompensation++;
    totalPlayerLoss += currentBet;
    localUser.Perak -= currentBet;
    localStorage.setItem("Perak", localUser.Perak);
    
    // Tidak perlu menampilkan pesan saat kalah
    $('#betResult').addClass('result-hidden');
}
      
      
      
      
    
       
    
    $('#betResult')
      .text(message)
      .removeClass('win lose')
      .addClass(messageClass)
      .removeClass('result-hidden');
    
    updatePerakDisplay();
    
    if (isAutoBetEnabled) {
      setTimeout(() => {
        placeBet(autoBetAmount);
      }, 3000);
    } else {
      currentBet = 0;
      hasPlacedBet = false;
      $('#placeBetButton').prop('disabled', false);
      $('#cancelBetButton').prop('disabled', true);
    }
  }







  function saveWinToDatabase(amount, winType, numbers) {
    const now = new Date();
    const winData = {
      username: localUser.Username,
      amount: amount,
      type: winType,
      numbers: numbers,
      timestamp: now.getTime(),
      date: now.toISOString(),
      bet: currentBet,
      lossStreak: lossStreakForCompensation,
      totalLoss: totalPlayerLoss,
      wasCompensation: lossStreakForCompensation >= COMPENSATION_THRESHOLD
    };
    
    db.ref('wins').push(winData)
      .then(() => console.log('Win saved to database'))
      .catch(error => console.error('Error saving win:', error));
  }

  function spin(isManual = false) {
    if (isSpinning) return;
    isSpinning = true;
    
    $('#betResult').addClass('result-hidden');
    
    if (isManual) {
      lastManualSpinTime = Date.now();
      $('#spinButton').prop('disabled', true);
      updateManualSpinButton();
    }
      
    $('#numbersDisplay').empty();
      
    for (let i = 1; i <= 5; i++) {
      $(`#ring${i}`).css('animation', `back-spin 1s`);
    }
      
    setTimeout(() => {
      const result = generateControlledResult();
      currentSeeds = result;
      
      for (let i = 1; i <= 5; i++) {
        const seed = result[i-1];
        $(`#ring${i}`)
          .css('animation', `spin-${seed} ${SPIN_DURATION}s cubic-bezier(0.1, 0.7, 0.1, 1)`)
          .attr('class', `ring spin-${seed}`);
      }
        
      setTimeout(() => {
        $('#numbersDisplay').html(
          result.map(num => `<span>${num}</span>`).join('')
        );
        
        saveRollToDatabase(result, isManual);
        processBetResult(result);
        
        isSpinning = false;
      }, SPIN_DURATION * 1000);
    }, 1000);
  }
  
  
  
  
  
  
  
  
  

  function updateManualSpinButton() {
    const now = Date.now();
    const timeSinceLastSpin = now - lastManualSpinTime;
    const remainingCooldown = Math.max(0, MANUAL_SPIN_COOLDOWN - timeSinceLastSpin);
    
    if (remainingCooldown <= 0) {
      $('#spinButton').prop('disabled', false).text('Putar');
    } else {
      const seconds = Math.ceil(remainingCooldown / 1000);
      $('#spinButton').text(`roll selanjutnya: ${seconds}s`);
      setTimeout(updateManualSpinButton, 1000);
    }
  }

  $(document).ready(function() {
    for (let i = 1; i <= 5; i++) createROLL($('#ring' + i));
      
    $('#rotate').addClass('tilted');
    $('.roll').addClass('backface-on');
    
    setTimeout(() => {
      $('#loading').fadeOut();
    }, 2000);
    
    updatePerakDisplay();
    
    $('#spinButton').click(function() {
      if (!$(this).prop('disabled')) {
        spin(true);
      }
    });
    
    $('#placeBetButton').click(function() {
      const betAmount = parseInt($('#betAmount').val());
      
      if (isNaN(betAmount) || betAmount <= 0) {
        alert('Masukkan jumlah taruhan yang valid');
        return;
      }
      
      placeBet(betAmount);
    });
    
    $('#cancelBetButton').click(function() {
      cancelBet();
    });
  });

</script>

</body>
</html>
