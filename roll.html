<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1024">
  <title>Roll</title>
    
  
    
    
    
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>

    <style>
        body { background-color: #333; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; font-family: sans-serif; }

        .perspective-on { perspective: 1000px; }
        .tilted { transform: rotateY(45deg); }

        @keyframes back-spin { 100% { transform: rotateX(36deg); } }
        .spin-0  { transform: rotateX(-3600deg); }
        .spin-1  { transform: rotateX(-3636deg); }
        .spin-2  { transform: rotateX(-3672deg); }
        .spin-3  { transform: rotateX(-3708deg); }
        .spin-4  { transform: rotateX(-3744deg); }
        .spin-5  { transform: rotateX(-3780deg); }
        .spin-6  { transform: rotateX(-3816deg); }
        .spin-7  { transform: rotateX(-3852deg); }
        .spin-8  { transform: rotateX(-3888deg); }
        .spin-9  { transform: rotateX(-3924deg); }
        @keyframes spin-0  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3600deg); } }
        @keyframes spin-1  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3636deg); } }
        @keyframes spin-2  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3672deg); } }
        @keyframes spin-3  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3708deg); } }
        @keyframes spin-4  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3744deg); } }
        @keyframes spin-5  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3780deg); } }
        @keyframes spin-6  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3816deg); } }
        @keyframes spin-7  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3852deg); } }
        @keyframes spin-8  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3888deg); } }
        @keyframes spin-9  { 0% { transform: rotateX(36deg); } 100% { transform: rotateX(-3924deg); } }
        #rotate {
            margin: 0 auto;
            width: 700px;
            height: 700px;
            padding-top: 700px;
            transform-style: preserve-3d;
            transform: rotateY(45deg);
        }
        .ring {
            margin: 0 auto;
            height: 115px;
            width: 115px;
            float: left;
            transform-style: preserve-3d;
        }
        .roll {
            position: absolute;
            width: 120px;
            height: 120px;
            box-sizing: border-box;
            opacity: 0.9;
            color: black;
            background: white;
            border: solid 5px #ccc;
            backface-visibility: visible;
        }
        .roll p {
            font-size: 100px;
            font-weight: bold;
            line-height: 130px;
            margin: 0;
            text-align: center;
        }
        .backface-on { backface-visibility: visible; }

        #spinButton {
            position: relative;
            margin-top: 20px;
            padding: 30px;
            background-color: blue;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 30px;
            width: 95%;
            max-width: 950px;
        }
        #spinButton:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .mainting-panel {
            position: relative;
            margin-top: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            font-size: 30px;
            border-radius: 10px;
            color: white;
            width: 95%;
            max-width: 950px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .auto-main-options {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
            font-size: 30px;
        }
        #automainButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            font-size: 30px;
        }
        #automainButtons button {
            flex: 1;
            min-width: 50px;
            padding: 5px;
            background-color: #333;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 30px;
        }
        #automainButtons button.active {
            background-color: #4CAF50;
            font-weight: bold;
        }
        #automainButtons button:last-child {
            background-color: #f44336;
        }
        .auto-spin-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }
        .auto-spin-buttons button {
            padding: 15px 30px;
            font-size: 24px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            width: 45%;
            color: white;
        }
        #startAutoSpinButton {
            background-color: #4CAF50;
        }
        #stopAutoSpinButton {
            background-color: #f44336;
            display: none;
        }
        .error-message {
            color: red;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        .result-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 30px;
        }
        .result-hidden {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
        }
        .win {
            background-color: rgba(255, 215, 0, 0.7) !important;
            color: black !important;
        }
        #SaldoBalance {
            font-weight: bold;
            color: snow;
        }
        .bling-bling {
            animation: glowing 1.5s infinite alternate;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff7, 0 0 20px #ff7, 0 0 25px #ff0, 0 0 30px #ff0, 0 0 35px #ff0;
        }
        @keyframes glowing {
            from { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #ff7, 0 0 20px #ff7, 0 0 25px #ff0, 0 0 30px #ff0, 0 0 35px #ff0; }
            to { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #ff0, 0 0 40px #ff0, 0 0 50px #ff7, 0 0 60px #ff7, 0 0 70px #ff7; }
        }
    </style>
</head>

<body>
    <div id="stage" class="perspective-on" style="margin-top: 50px;">
        <div id="rotate" class="tilted">
            <div id="ring1" class="ring"></div>
            <div id="ring2" class="ring"></div>
            <div id="ring3" class="ring"></div>
            <div id="ring4" class="ring"></div>
            <div id="ring5" class="ring"></div>
        </div>

        <audio id="winAudio" src="https://nasukafoods.site/slavafunk.mp3" preload="auto"></audio>
        <audio id="slotAudio" src="https://nasukafoods.site/mesinslot.mp3" preload="auto"></audio>

        <button id="spinButton">Putar</button>
        <div class="mainting-panel">
            <div>Saldo Saya: <span id="SaldoBalance">0</span></div>
            <div id="errorMessage" class="error-message"></div>
            <div class="auto-main-options">
                <div id="automainButtons">
                    <button onclick="selectmain(1)" id="main1">1</button>
                    <button onclick="selectmain(100)" id="main100">100</button>
                    <button onclick="selectmain(1000)" id="main1000">1.000</button>
                    <button onclick="selectmain(10000)" id="main10000">10.000</button>
                    <button onclick="selectmain(0)">off</button>
                </div>
            </div>
            <div class="auto-spin-buttons">
                <button id="startAutoSpinButton"> Otomatis</button>
                <button id="stopAutoSpinButton">Hentikan</button>
            </div>
            <div id="mainResult" class="result-message result-hidden"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
            authDomain: "nasukafoods1.firebaseapp.com",
            databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "nasukafoods1",
            messagingSenderId: "84287800896",
            appId: "1:84287800896:web:83189d6766997b00f701a5"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        const localUser = {
            ID: localStorage.getItem("ID"),
            Username: localStorage.getItem("Username"),
            Saldo: parseInt(localStorage.getItem("Saldo")) || 0,
        };

        const userRef = db.ref(`users/${localUser.ID}`);

        if (localUser.ID) {
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData !== null) {
                    localUser.Saldo = userData.Saldo || 0;
                    localStorage.setItem("Saldo", localUser.Saldo);
                    updateSaldoDisplay();
                }
            });
        }

        const ROLL_PER_REEL = 10;
        const REEL_RADIUS = 400;
        const SPIN_DURATION = 5;
        const MANUAL_SPIN_COOLDOWN = 4 * 400;

        const WIN_MULTIPLIERS = {
            'dua': 2,
            'tiga': 3,
            'empat': 4,
            'lima': 5,
            'jackpot': 10
        };

        const WIN_PROBABILITIES = {
            'dua': 0.1,
            'tiga': 0.03,
            'empat': 0.02,
            'lima': 0.0000000000000000000000000000000000000001,
            'jackpot': 0.00000000000000000000000000000000000000000000000000001
        };

        let currentSeeds = [0, 0, 0, 0, 0];
        let isSpinning = false;
        let lastManualSpinTime = 0;
        let currentmain = 0;
        let isAutomainEnabled = false;
        let playerWinStreak = 0;
        let playerLoseStreak = 0;
        const HOUSE_EDGE = 0;

        function updateSaldoDisplay() {
            $('#SaldoBalance').text(localUser.Saldo.toLocaleString('id-ID'));
        }

        function showErrorMessage(message) {
            $('#errorMessage').text(message).fadeIn().delay(3000).fadeOut();
        }

        function createROLL(ring) {
            const rollAngle = 360 / ROLL_PER_REEL;
            for (let i = 0; i < ROLL_PER_REEL; i++) {
                const roll = document.createElement('div');
                roll.className = 'roll backface-on';
                roll.style.transform = `rotateX(${rollAngle * i}deg) translateZ(${REEL_RADIUS}px)`;
                const p = document.createElement('p');
                p.textContent = i;
                roll.appendChild(p);
                ring.append(roll);
            }
        }

        function saveRollToDatabase(result, isManual = false) {
            console.log("Logging roll data has been disabled.");
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generateDua() {
            const num = Math.floor(Math.random() * 10);
            const result = [num, num];
            while (result.length < 5) {
                const uniqueNum = Math.floor(Math.random() * 10);
                if (!result.includes(uniqueNum)) {
                    result.push(uniqueNum);
                }
            }
            return shuffleArray(result);
        }

        function generateTiga() {
            const num = Math.floor(Math.random() * 10);
            const result = [num, num, num];
            while (result.length < 5) {
                const uniqueNum = Math.floor(Math.random() * 10);
                if (!result.includes(uniqueNum)) {
                    result.push(uniqueNum);
                }
            }
            return shuffleArray(result);
        }

        function generateEmpat() {
            const num = Math.floor(Math.random() * 10);
            const result = [num, num, num, num];
            while (result.length < 5) {
                const uniqueNum = Math.floor(Math.random() * 10);
                if (!result.includes(uniqueNum)) {
                    result.push(uniqueNum);
                }
            }
            return shuffleArray(result);
        }

        function generateLima() {
            const num = Math.floor(Math.random() * 10);
            return [num, num, num, num, num];
        }

        function generateJackpot() {
            const result = [1, 2, 3, 4, 5];
            return shuffleArray(result);
        }

        function generateRandomResult() {
            const result = [];
            while (result.length < 5) {
                const num = Math.floor(Math.random() * 10);
                if (!result.includes(num)) {
                    result.push(num);
                }
            }
            return result;
        }

        function generateControlledResult() {
            let currentProbabilities = WIN_PROBABILITIES;

            const rand = Math.random();
            let cumulativeProb = 0;

            for (const type in currentProbabilities) {
                cumulativeProb += currentProbabilities[type];
                if (rand < cumulativeProb) {
                    switch(type) {
                        case 'dua': return generateDua();
                        case 'tiga': return generateTiga();
                        case 'empat': return generateEmpat();
                        case 'lima': return generateLima();
                        case 'jackpot': return generateJackpot();
                    }
                }
            }
            return generateRandomResult();
        }
        
        function checkWin(result) {
            const sortedResult = [...result].sort((a, b) => a - b).join('');
            if (sortedResult === '12345') {
                return 'jackpot';
            }

            const frequency = {};
            result.forEach(num => {
                frequency[num] = (frequency[num] || 0) + 1;
            });

            const counts = Object.values(frequency);
            const hasLima = counts.some(count => count >= 5);
            const hasEmpat = counts.some(count => count >= 4);
            const hasTiga = counts.some(count => count >= 3);
            const hasDua = counts.some(count => count >= 2);

            if (hasLima) {
                return 'lima';
            } else if (hasEmpat) {
                return 'empat';
            } else if (hasTiga) {
                return 'tiga';
            } else if (hasDua) {
                return 'dua';
            }
            return null;
        }

        function selectmain(amount) {
            if (amount > 0 && amount <= localUser.Saldo) {
                currentmain = amount;
                $('#automainButtons button').removeClass('active');
                $(`#main${amount}`).addClass('active');

            } else if (amount === 0) {
                currentmain = 0;
                $('#automainButtons button').removeClass('active');

            } else {
                showErrorMessage('Saldo tidak mencukupi atau jumlah main tidak valid.');
            }
        }

        function startAutoSpin() {
            if (currentmain <= 0) {
                showErrorMessage('Pilih jumlah main terlebih dahulu.');
                return;
            }
            isAutomainEnabled = true;
            $('#startAutoSpinButton').hide();
            $('#stopAutoSpinButton').show();
            $('#spinButton').prop('disabled', true);
            spin(false);
        }

        function stopAutoSpin() {
            isAutomainEnabled = false;
            $('#stopAutoSpinButton').hide();
            $('#startAutoSpinButton').show();
            $('#spinButton').prop('disabled', false);
        }

        function spin(isManual) {
            if (isSpinning) return;

            const slotAudio = document.getElementById('slotAudio');
            slotAudio.currentTime = 0;
            slotAudio.play().catch(err => console.log("Autoplay blocked:", err));

            if (currentmain <= 0) {
                showErrorMessage('Pilih jumlah main.');
                return;
            }
            if (currentmain > localUser.Saldo) {
                showErrorMessage('Saldo tidak cukup untuk main ini.');
                return;
            }

            localUser.Saldo -= currentmain;
            updateSaldoDisplay();
            userRef.child('Saldo').set(localUser.Saldo); 
            
            const winAudio = document.getElementById('winAudio');
            if (!winAudio.paused) {
                winAudio.pause();
                winAudio.currentTime = 0;
            }

            isSpinning = true;
            $('#mainResult').addClass('result-hidden').removeClass('win lose');
            if (isManual) {
                lastManualSpinTime = Date.now();
                $('#spinButton').prop('disabled', true);
                updateManualSpinButton();
            }

            $('#stage .roll p').removeClass('bling-bling');

            for (let i = 1; i <= 5; i++) {
                $(`#ring${i}`).css('animation', `back-spin 1s`);
            }

            setTimeout(() => {
                const result = generateControlledResult();
                currentSeeds = result;

                for (let i = 1; i <= 5; i++) {
                    const seed = result[i-1];
                    $(`#ring${i}`)
                        .css('animation', `spin-${seed} ${SPIN_DURATION}s cubic-bezier(0.1, 0.7, 0.1, 1)`)
                        .attr('class', `ring spin-${seed}`);
                }

                setTimeout(() => {
                    for (let i = 0; i < result.length; i++) {
                        const numberElement = $(`#ring${i+1} .roll`).eq(result[i]).find('p');
                        numberElement.addClass('bling-bling');
                    }

                    saveRollToDatabase(result, isManual);
                    processmainResult(result, isManual);

                    isSpinning = false;

                    if (isAutomainEnabled) {
                        setTimeout(() => {
                            if (isAutomainEnabled) {
                                spin(false);
                            }
                        }, 3000);
                    }
                }, SPIN_DURATION * 1000);
            }, 1000);
        }

        function processmainResult(result, isManual) {
            const winType = checkWin(result);
            let message = "coba lagi";
            let messageClass = "lose";
            let winAmount = 0;

            if (winType) {
                playerWinStreak++;
                playerLoseStreak = 0;

                const baseMultiplier = WIN_MULTIPLIERS[winType];
                const totalMultiplier = baseMultiplier * (1 - HOUSE_EDGE);
                winAmount = Math.round(currentmain * totalMultiplier);

                message = `Selamat Anda MENDAPATKAN +${winAmount.toLocaleString('id-ID')} `;
                messageClass = "win";
                triggerConfetti();
                document.getElementById('winAudio').play();


            } else {
                playerWinStreak = 0;
                playerLoseStreak++;
            }

            localUser.Saldo += winAmount;

            userRef.transaction((currentData) => {
                if (currentData) {
                    let finalSaldo = (currentData.Saldo || 0) + winAmount;
                    return { ...currentData, Saldo: finalSaldo, };
                } else {
                    return;
                }
            }).then(() => {
                updateSaldoDisplay();

                $('#mainResult')
                    .text(message)
                    .removeClass('result-hidden')
                    .addClass(messageClass);
            }).catch(error => {
                console.error("Transaksi gagal:", error);
            });
        }

        function updateManualSpinButton() {
            const now = Date.now();
            const timeSinceLastSpin = now - lastManualSpinTime;
            const remainingCooldown = Math.max(0, MANUAL_SPIN_COOLDOWN - timeSinceLastSpin);

            if (remainingCooldown <= 0) {
                $('#spinButton').prop('disabled', isAutomainEnabled ? true : false).text('Putar');
            } else {
                const seconds = Math.ceil(remainingCooldown / 1000);
                $('#spinButton').text(`Tunggu (${seconds}s)`);
                setTimeout(updateManualSpinButton, 1000);
            }
        }

        function triggerConfetti() {
            const defaults = {
                spread: 360,
                ticks: 200,
                gravity: 0.4,
                decay: 0.94,
                startVelocity: 90,
                colors: ['#FFC107', '#E91E63', '#4CAF50', '#2196F3']
            };
            function shoot() {
                confetti({
                    ...defaults,
                    particleCount: 2000,
                    scalar: 1.2,
                    shapes: ['star']
                });
                confetti({
                    ...defaults,
                    particleCount: 300,
                    scalar: 0.8,
                    shapes: ['circle']
                });
            }
            setTimeout(shoot, 0);
            setTimeout(shoot, 150);
            setTimeout(shoot, 300);
        }

        $(document).ready(function() {
            for (let i = 1; i <= 5; i++) createROLL($('#ring' + i));

            $('#rotate').addClass('tilted');
            $('.roll').addClass('backface-on');

            let winAudio = document.getElementById('winAudio');
            let userInteracted = false;

            $('#spinButton').click(function() {
                if (!userInteracted) {
                    winAudio.muted = true;
                    winAudio.play().then(() => {
                        winAudio.pause();
                        winAudio.currentTime = 0;
                        winAudio.muted = false;
                        userInteracted = true;
                    }).catch(error => {
                        console.error("Audio play blocked:", error);
                    });
                }

                if (!$(this).prop('disabled')) {
                    spin(true);
                }
            });

            $('#startAutoSpinButton').click(startAutoSpin);
            $('#stopAutoSpinButton').click(stopAutoSpin);
            
            updateSaldoDisplay(); 
        });
    </script>
</body>
</html>
