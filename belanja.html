<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etalase Nasuka Foods</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://nasukafoods.site/lain.css">
    <link rel="stylesheet" href="https://nasukafoods.site/index.css">
    <style>
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 15px;
            background: #f4f4f4;
        }
        .product-card {
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .product-card:active { transform: scale(0.95); }
        .product-card img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }
        .product-info { padding: 10px; }
        .product-name {
            font-size: 14px;
            font-weight: 600;
            height: 35px;
            overflow: hidden;
            margin-bottom: 5px;
            color: #333;
        }
        .product-price {
            color: #ee4d2d;
            font-weight: bold;
            font-size: 15px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 20px;
            position: relative;
        }
        .checkout-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .info-box {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        .receipt-box {
            font-family: 'Courier New', Courier, monospace;
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-content">
            <div class="top-nav">
                <i class="fas fa-arrow-left" onclick="window.location.href='index.html'"></i>
                <span class="welcome">Menu Nasuka</span>
                <div id="displaySaldoTop" style="font-weight:bold; color:#fff; background:rgba(0,0,0,0.2); padding:2px 8px; border-radius:10px;">Rp 0</div>
            </div>
        </div>
    </div>

    <div class="product-grid" id="productContainer">
        </div>
</div>

<div id="modalCheckout" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">Konfirmasi Pesanan</h3>
        <div id="checkoutDetails" class="checkout-item"></div>
        
        <div class="info-box">
            <strong>Tujuan Pengiriman:</strong><br>
            <span id="destNama"></span><br>
            <span id="destHP"></span><br>
            <span id="destAlamat"></span>
        </div>

        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:18px; margin-bottom:20px;">
            <span>Total Bayar:</span>
            <span id="totalHarga" style="color:#ee4d2d;"></span>
        </div>

        <button onclick="eksekusiPembayaran()" id="btnBayar" class="btn-primary" style="width:100%; margin-bottom:10px;">Bayar Sekarang</button>
        <button onclick="tutupModal('modalCheckout')" class="btn-secondary" style="width:100%;">Batal</button>
    </div>
</div>

<div id="modalStruk" class="modal">
    <div class="modal-content" style="text-align:center;">
        <i class="fas fa-check-circle" style="color:#2ecc71; font-size:50px; margin-bottom:10px;"></i>
        <h3 style="margin:0;">Pembayaran Berhasil</h3>
        <p style="color:#666; font-size:13px;">Silakan simpan struk ini</p>
        
        <div class="receipt-box" id="isiStruk"></div>

        <button onclick="window.location.href='index.html'" class="btn-primary" style="width:100%; margin-top:20px;">Kembali ke Home</button>
    </div>
</div>

<script>
// Konfigurasi Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAJPoqA190LutHQ7xnvnV96GTRHzz24IpT",
    authDomain: "nasukafoods1.firebaseapp.com",
    databaseURL: "https://nasukafoods1-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "nasukafoods1",
    messagingSenderId: "84287800896",
    appId: "1:84287800896:web:83189d6766997b00f701a5"
};

if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.database();

// Data User dari LocalStorage
const userData = {
    ID: localStorage.getItem("ID"),
    Nama: localStorage.getItem("Nama"),
    Saldo: parseInt(localStorage.getItem("Saldo")) || 0,
    Alamat: localStorage.getItem("Alamat"),
    HP: localStorage.getItem("NomorHP")
};

// Data Produk (kategori: wifi, axis, tsel, atau fisik)
const listProduk = [
    { id: 'P1', nama: 'Bumbu Kacang Instan Tinggal Seduh', harga: 20000, img: 'https://nasukafoods.site/image/paket.jpg', kategori: 'fisik' },
    { id: 'P2', nama: 'Voucher Wifi Nita Cell', harga: 3000, img: 'https://nasukafoods.site/image/isia.jpg', kategori: 'wifi' },
    { id: 'P7', nama: 'Voucher Axis 3D', harga: 10000, img: 'https://nasukafoods.site/image/isia.jpg', kategori: 'axis' },
    { id: 'P8', nama: 'Voucher Telkomsel 100GB', harga: 50000, img: 'https://nasukafoods.site/image/isia.jpg', kategori: 'tsel' },
    { id: 'P3', nama: 'Paket 25rb 10 cilok rasa gajih + 10 cilok isian gajih + 10 cilok telor puyuh', harga: 25000, img: 'https://nasukafoods.site/image/h.jpg', kategori: 'fisik' },
    { id: 'P4', nama: 'Es Teh Manis Jumbo', harga: 5000, img: 'https://nasukafoods.site/image/is.jpg', kategori: 'fisik' },
    { id: 'P5', nama: 'Cilok Telur Puyuh', harga: 12000, img: 'https://nasukafoods.site/image/nasukabird.jpg', kategori: 'fisik' },
    { id: 'P6', nama: 'Cilok Goreng Crispy', harga: 13000, img: 'https://nasukafoods.site/nasukafoods.jpg', kategori: 'fisik' }
];

let itemTerpilih = null;

function muatProduk() {
    const container = document.getElementById('productContainer');
    document.getElementById('displaySaldoTop').textContent = 'Rp ' + userData.Saldo.toLocaleString('id-ID');
    
    listProduk.forEach(p => {
        container.innerHTML += `
            <div class="product-card" onclick="siapkanCheckout('${p.id}')">
                <img src="${p.img}">
                <div class="product-info">
                    <div class="product-name">${p.nama}</div>
                    <div class="product-price">Rp ${p.harga.toLocaleString('id-ID')}</div>
                </div>
            </div>
        `;
    });
}

function siapkanCheckout(id) {
    if(!userData.ID) { alert("Harap login terlebih dahulu."); return; }
    itemTerpilih = listProduk.find(x => x.id === id);
    
    document.getElementById('checkoutDetails').innerHTML = `
        <img src="${itemTerpilih.img}" style="width:70px; height:70px; border-radius:8px; object-fit:cover;">
        <div>
            <div style="font-weight:bold;">${itemTerpilih.nama}</div>
            <div style="color:#666; font-size:13px;">Kuantitas: 1</div>
        </div>
    `;
    
    document.getElementById('destNama').textContent = userData.Nama;
    document.getElementById('destHP').textContent = userData.HP;
    document.getElementById('destAlamat').textContent = userData.Alamat;
    document.getElementById('totalHarga').textContent = 'Rp ' + itemTerpilih.harga.toLocaleString('id-ID');
    
    document.getElementById('modalCheckout').style.display = 'flex';
}

async function eksekusiPembayaran() {
    if (userData.Saldo < itemTerpilih.harga) {
        alert("Saldo Anda tidak mencukupi!");
        return;
    }

    document.getElementById('btnBayar').disabled = true;
    document.getElementById('btnBayar').innerText = "Memproses...";

    let kodeVoucherTerambil = "-";
    let labelVoucher = "";

    // Logika Pengambilan Kode Voucher
    if (itemTerpilih.kategori !== 'fisik') {
        let nodeDB = "";
        
        if (itemTerpilih.kategori === 'wifi') {
            nodeDB = 'vouchers';
            labelVoucher = 'KODE WIFI';
        } else if (itemTerpilih.kategori === 'axis') {
            nodeDB = 'vouchers_axis';
            labelVoucher = 'KODE AXIS';
        } else if (itemTerpilih.kategori === 'tsel') {
            nodeDB = 'vouchers_tsel';
            labelVoucher = 'KODE TELKOMSEL';
        }

        const snapshotVoucher = await db.ref(nodeDB).orderByChild('status').equalTo('tersedia').limitToFirst(1).once('value');
        
        if (!snapshotVoucher.exists()) {
            alert(`Stok Voucher ${labelVoucher.split(' ')[1]} sedang habis!`);
            document.getElementById('btnBayar').disabled = false;
            document.getElementById('btnBayar').innerText = "Bayar Sekarang";
            return;
        }

        const keyVoucher = Object.keys(snapshotVoucher.val())[0];
        kodeVoucherTerambil = snapshotVoucher.val()[keyVoucher].kode;

        await db.ref(`${nodeDB}/${keyVoucher}`).remove();
    }

    const tgl = new Date();
    const invoice = "NSK" + tgl.getTime();
    const formatTgl = tgl.toLocaleString('id-ID');

    db.ref(`users/${userData.ID}/Saldo`).transaction((currentSaldo) => {
        return (currentSaldo || 0) - itemTerpilih.harga;
    }, (error, committed, snapshot) => {
        if (committed) {
            const dataRiwayat = {
                invoice: invoice,
                produk: itemTerpilih.nama,
                total: itemTerpilih.harga,
                tanggal: formatTgl,
                status: "LUNAS",
                voucher: kodeVoucherTerambil,
                label: labelVoucher
            };

            db.ref(`history/${userData.ID}`).push(dataRiwayat).then(() => {
                localStorage.setItem("Saldo", snapshot.val());
                tampilkanStruk(dataRiwayat);
            });
        } else {
            alert("Transaksi gagal.");
            document.getElementById('btnBayar').disabled = false;
        }
    });
}

function tampilkanStruk(data) {
    document.getElementById('modalCheckout').style.display = 'none';
    const isi = document.getElementById('isiStruk');
    
    let infoVoucher = "";
    if (data.voucher !== "-") {
        infoVoucher = `${data.label}: ${data.voucher}<br>---------------------------<br>`;
    }

    isi.innerHTML = `
        NO. INV : ${data.invoice}<br>
        WAKTU   : ${data.tanggal}<br>
        ---------------------------<br>
        ITEM    : ${data.produk}<br>
        TOTAL   : Rp ${data.total.toLocaleString('id-ID')}<br>
        ${infoVoucher}
        METODE  : SALDO NASUKA<br>
        ---------------------------<br>
        Penerima: ${userData.Nama}<br>
        STATUS  : BERHASIL
    `;
    document.getElementById('modalStruk').style.display = 'flex';
}

function tutupModal(id) { document.getElementById(id).style.display = 'none'; }

$(document).ready(() => muatProduk());
</script>

</body>
</html>
